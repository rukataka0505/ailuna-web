# AiLuna (SaaS版) - AI電話取次サービス

AI電話取次サービス「AiLuna」のSaaS版Webアプリケーションです。
Next.jsとSupabaseを使用して構築されており、セキュアな認証機能とモダンなLPを備えています。

## 技術スタック

- **Framework**: Next.js 16 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Auth & DB**: Supabase
- **Icons**: Lucide React

## 機能

- **ランディングページ (LP)**:
  - 未ログインユーザー向けのサービス紹介ページ（`/`）
  - **構成**:
    - ヘッダー: ロゴと認証ボタン（「ログイン」「無料で始める」）
    - ヒーローセクション: キャッチコピーとメインCTAボタン
    - 機能紹介セクション: 3つの主要機能を紹介
    - フッターCTA: アカウント登録への誘導
  - **強調している主要機能**:
    - **トーク形式での通話履歴確認**: チャットのように会話を振り返れる機能
    - **AIプロンプトの編集機能**: お店ごとにAIオペレーターをカスタマイズ可能
    - **ダッシュボードでの可視化**: 着信状況・利用時間・請求額をひと目で把握
  - レスポンシブデザイン
  - **認証フォームは含まれません**（専用の `/login` ページに集約）
- **ヘッダーナビゲーション**:
  - 全ページ共通のヘッダーコンポーネント（`src/components/Header.tsx`）
  - 左側: AiLunaロゴ（クリックでトップページへ）
  - 右側: 
    - 「ログイン」ボタン（テキストスタイル） → `/login?mode=login` に遷移
    - 「無料で始める」ボタン（プライマリスタイル） → `/login?mode=signup` に遷移
- **認証機能**:
  - **認証ページ**: `/login` に統合（ログイン／新規登録の共通入り口）
  - クエリパラメータ（`?mode=login` または `?mode=signup`）でタブを制御
  - メールアドレス/パスワードによるサインアップ・ログイン
  - Supabase Auth UI と Server Actions を併用
  - 未認証ユーザーがダッシュボードにアクセスしようとすると、自動的にトップページへリダイレクト
  - **新規登録時の必須入力項目**:
    - メールアドレス
    - パスワード
    - パスワード（確認用）
    - 氏（lastName）と名（firstName）- 同じ行で横並びに表示
    - アカウント名（accountName）
    - 登録完了後、`profiles` テーブルに以下が自動保存されます：
      - `full_name`: 「氏」と「名」を結合した文字列（例：「大塚 孝雄」）
      - `account_name`: 入力されたアカウント名（例：「大塚ラーメン本店」）
    - **実装詳細**:
      - `src/components/AuthForm.tsx`: フォーム入力のハンドリング
      - `src/app/login/actions.ts`: `signup` サーバーアクション内で、Supabase Auth の `options.data` に `full_name` と `account_name` を渡す
      - **Supabase Trigger**: `handle_new_user` 関数がトリガーされ、メタデータから `profiles` テーブルに値を自動挿入（`supabase/update_handle_new_user.sql` の適用が必要）
  - **メール認証フロー**:
    - サインアップ時、Supabase から送信される認証メールのリンクは `/auth/complete` にリダイレクトされます
    - `/auth/callback` は内部的な認証コード交換用のルートハンドラーとして存在しますが、ユーザーが直接アクセスすることは想定されていません
    - 認証リンククリック後、`/auth/complete`（完了画面）へ遷移
    - 完了画面から「ログインしてマイページを開く」ボタンでダッシュボード（マイページ）へ移動
    - **Supabase 設定要件**:
      - Supabase Dashboard の Authentication → URL Configuration で以下を設定してください：
        - Site URL: 本番環境のURL（例：`https://ailuna-web.vercel.app`）
        - Redirect URLs: 以下のパターンを許可リストに追加
          - `https://ailuna-web.vercel.app/**` (本番環境)
          - `http://localhost:3000/**` (ローカル開発環境)
      - これにより `/auth/complete` へのリダイレクトが正常に動作します
    - **検証手順**:
      - **ローカル環境**: 
        1. `npm run dev` で開発サーバーを起動
        2. 新しいメールアドレスでサインアップ
        3. 届いたメールのURLに `redirect_to=http://localhost:3000/auth/complete` が含まれていることを確認
        4. リンクをクリックして `/auth/complete` ページが表示されることを確認
      - **本番環境**:
        1. `https://ailuna-web.vercel.app` から新規登録
        2. 届いたメールのURLに `redirect_to=https://ailuna-web.vercel.app/auth/complete` が含まれていることを確認
        3. リンクをクリックして `/auth/complete` ページが表示されることを確認（404エラーにならないこと）
  - **パスワードリセット機能**:
    - ログインフォームから「パスワードをお忘れですか？」リンクで申請
    - メールで送信されたリンクから `/auth/update-password` ページへ遷移
    - 新しいパスワードを入力して更新
    - 更新完了後はダッシュボードへ自動リダイレクト
- **ダッシュボード**:
  - ログイン済みユーザーのみアクセス可能 (`/dashboard`)
  - ユーザー情報の表示
  - **AI設定**:
    - 電話応答時の挨拶と事業内容を設定可能
    - 設定は `user_prompts` テーブルに保存され、ログインユーザーごとに管理されます
  - **通話履歴**:
    - アコーディオン形式で過去の通話ログを表示
    - クリックで詳細な会話内容を展開/折りたたみ可能
    - AI生成の要約タイトルで内容を一目で把握
    - 日時、電話番号、要約を一覧表示
    - **ページネーション機能**: 「さらに読み込む」ボタンで過去の履歴を順次ロード
    - **高度なフィルター機能**: 
      - **期間指定**: 開始日と終了日を指定してログを絞り込み
      - **発信者指定**: 過去の発信者番号リストから特定の発信者を絞り込み
      - フィルター適用中もページネーションが動作
  - **メトリクス表示**:
    - `call_logs` テーブルから集計した「着信対応回数」と「利用時間」を表示
    - **着信対応回数**: ユーザーの全通話ログ数
    - **利用時間**: `call_logs.duration_seconds` の合計（秒）を分単位で表示。
      - `duration_seconds` が `NULL` のレコード（過去のログなど）は `0` 秒として計算されます。
    - Next.js Streaming (Suspense) を利用し、計算中もスケルトン表示でUIをブロックしない設計
    - **今月の請求額**:
      - 現在はダミー表示（¥0）です。
      - 将来的に通話時間や料金設定に基づいた計算ロジックが実装される予定です。
  - ログアウト機能
- **モバイル対応**:
  - レスポンシブデザイン対応
  - モバイル時はハンバーガーメニューからドロワーナビゲーションを表示
  - ドロワーは**右側**からスライドインする仕様に変更されました
- **ミドルウェア**:
  - セッション管理とルート保護
  - 未認証ユーザーのダッシュボードアクセス制限
  - LP (`/`) へのパブリックアクセス許可
- **電話番号表示**:
  - ダッシュボード右上（サイドバーおよびモバイルヘッダー）にログインユーザーの電話番号を表示
  - データソース: `profiles.phone_number` カラム
  - 電話番号が登録されている場合: 「電話番号：+81-90-xxxx-xxxx」のように表示
  - 電話番号が未登録の場合: 「電話番号：登録されていません」と表示
  - コンポーネント: `src/components/UserPhoneDisplay.tsx`
  - サーバーアクション: `src/app/dashboard/actions.ts` の `fetchUserProfile()`
- **ダッシュボードヘッダー構成**:
  - ダッシュボードのヘッダー（サイドバーおよびモバイルヘッダー）は以下の構成になっています：
  - **アカウント情報カード**:
    - ロゴ「AiLuna」の下に、アカウント名と電話番号を1つのカードで表示
    - データソース: `profiles.account_name` および `profiles.phone_number` カラム
    - **デザイン**: アイコンベースのモダンなレイアウト
      - アカウント名: User アイコン + 名前（太字）
      - 電話番号: Phone アイコン + 番号（サブ情報）
      - デスクトップでは1行表示（例：👤 rukataka0505 ・ 📞 +1573...）
      - モバイルでは折り返し対応
    - **未登録時の表示**:
      - アカウント名が未設定の場合: 「未設定」と表示
      - 電話番号が未登録の場合: 「未登録」とグレーアウト表示
    - コンポーネント: `src/components/AccountInfoCard.tsx`

## UI/UX改善

### 統一された操作感（インタラクション）
アプリ全体のボタンやインタラクティブ要素に対し、一貫した操作フィードバックを提供します:

1. **クリックエフェクト**
   - 全ての主要ボタンに `active:scale-[0.96]` を適用
   - クリック時にわずかに縮む効果で「押した」感覚を提供
   - ダッシュボード、認証フォーム、設定保存ボタンなど全体で統一

2. **ホバーエフェクト**
   - インタラクティブ要素には `hover:opacity-90` や `hover:bg-XXX-700` を適用
   - マウスオーバー時の反応を明確化

3. **ローディング表現**
   - 処理中（`isPending` / `isLoading`）はボタンを `disabled` に設定
   - `cursor: not-allowed` でインタラクション不可を明示
   - スピナーアイコンと「処理中...」テキストで状態を可視化

### 認証フォームの強化
カスタム認証フォーム (`src/components/AuthForm.tsx`) に以下の機能を実装し、ユーザーエクスペリエンスを大幅に向上させました:

1. **パスワードリセット機能**
   - ログインフォームに「パスワードをお忘れですか?」リンクを配置
   - クリックでリセットモードに切り替わり、メールアドレス入力のみを表示
   - メール送信後、「再設定メールを送信しました」という完了画面を表示
   - メール内のリンクから `/auth/update-password` ページへ遷移
   - 新しいパスワードを2回入力（確認用）して変更を確定

2. **ボタン操作感の向上**
   - クリック時のスケールアニメーション (`active:scale-[0.96]`) を適用
   - 処理中はボタンを無効化し、スピナーと「処理中...」テキストを表示
   - 二重送信を防止

3. **パスワード表示切り替え**
   - パスワード入力欄に目のアイコン (Eye/EyeOff) を配置
   - クリックでパスワードの表示/非表示を切り替え可能

4. **パスワード確認機能**
   - 新規登録時のみ確認用パスワード入力欄を表示
   - クライアント側でパスワード一致を検証
   - 不一致時は即座にエラーメッセージを表示

5. **モード切り替えアニメーション**
   - `framer-motion` を使用したスムーズなトランジション
   - ログイン ⇔ 新規登録 ⇔ パスワードリセットの切り替え時にフェード/スライド効果

6. **登録完了フィードバック**
   - 登録成功時は「認証メールを送信しました」メッセージを表示
   - フォームを非表示にし、完了画面に切り替え
   - サーバーアクション (`signup`) は成功時に `{ success: true }` を返す仕様に変更

### その他のUI改善
- **認証完了ページ** (`/auth/complete`): 「ログインしてマイページを開く」ボタンにクリックアニメーションを適用
- **パスワード更新ページ** (`/auth/update-password`): 統一されたデザインとインタラクションを実装
- **ダッシュボード**: 
  - 「設定を保存する」ボタンとログアウトボタンにクリックアニメーションを適用
  - 通話履歴フィルターの「検索」「クリア」ボタンにも統一インタラクションを適用
- 統一されたボタンフィードバックによる一貫したUI体験

### 通話履歴フィルターの改善
通話履歴リストのフィルター機能（`src/components/CallLogList.tsx`）を以下の通り改修しました：

1. **ポップアップ表示への変更**
   - フィルターアイコンボタンをクリックした時のみ条件設定フォームを表示
   - 画面の専有面積を減らし、コンテンツ（履歴リスト）を広く表示
   - 直感的な開閉操作（アイコンクリックで開く、外側クリック/×ボタンで閉じる）

2. **視認性の向上**
   - フィルター項目（開始日、終了日、発信者）のラベルテキスト色を濃く調整（`text-zinc-500` → `text-zinc-700`）
   - 入力フィールド内のテキスト色も明確化
   - 全体的なコントラスト比を高め、読みやすさを改善

## Supabase セットアップ
 
 ### 1. プロジェクトの作成
 Supabase で新しいプロジェクトを作成してください。
 
 ### 2. スキーマの適用 (SQL Editor)
 データベースのテーブルとセキュリティ設定を作成します。
 
 1. Supabase ダッシュボードの左サイドバーから **SQL Editor** を開きます。
 2. 「New Query」をクリックして新しいクエリエディタを開きます。
 3. プロジェクトルートの `../supabase/schema.sql` の内容をすべてコピーし、エディタに貼り付けます。
 4. **Run** ボタンをクリックして実行します。
 5. 画面右下のログに "Success" と表示されれば完了です。
 
 ### 3. 通話履歴機能のテーブル追加（追加セットアップ）
  通話履歴機能を使用する場合は、以下のSQLファイルも実行してください：
  
  1. Supabase ダッシュボードの **SQL Editor** を開きます。
  2. `../supabase/add_summary_column.sql` の内容をコピーし、エディタに貼り付けます。
  3. **Run** ボタンをクリックして実行します。
  4. これにより `call_logs` テーブルと `summary` カラムが追加されます。
  
  ### 5. 電話番号表示機能のセットアップ（追加セットアップ）
  電話番号表示機能を使用する場合は、以下のSQLファイルも実行してください：
  
  1. Supabase ダッシュボードの **SQL Editor** を開きます。
  2. `../supabase/add_phone_number_column.sql` の内容をコピーし、エディタに貼り付けます。
  3. **Run** ボタンをクリックして実行します。
  4. これにより `profiles` テーブルに `phone_number` カラムが追加されます。
  
  ### 6. 氏名カラムのセットアップ（追加セットアップ）
  氏名を保存する機能を使用する場合は、以下のSQLファイルも実行してください：
  
  1. Supabase ダッシュボードの **SQL Editor** を開きます。
  2. `../supabase/add_full_name_column.sql` の内容をコピーし、エディタに貼り付けます。
  3. **Run** ボタンをクリックして実行します。
  4. これにより `profiles` テーブルに `full_name` カラムが追加されます。
  
  ### 7. アカウント名表示機能のセットアップ（追加セットアップ）
  アカウント名表示機能を使用する場合は、以下のSQLファイルも実行してください：
  
  1. Supabase ダッシュボードの **SQL Editor** を開きます。
  2. `../supabase/add_account_name_column.sql` の内容をコピーし、エディタに貼り付けます。
  3. **Run** ボタンをクリックして実行します。
  4. これにより `profiles` テーブルに `account_name` カラムが追加されます。
  
  ### 8. テーブル作成の確認
  左サイドバーの **Table Editor** を開き、以下のテーブルが作成されていることを確認してください：
  
  - `profiles`: ユーザー情報（Stripe IDなど）
  - `user_prompts`: AI設定（挨拶文、事業説明）
  - `call_logs`: 通話履歴（Call Engine からの保存用）
 
 > [!IMPORTANT]
 > `user_prompts` テーブルの `user_id` カラムには **Unique** 制約が必要です。`schema.sql` にはこれが含まれていますが、もし手動で作成した場合は必ず追加してください。これがないと設定の保存（Upsert）が正しく動作しません。

## データベース設計

### テーブル構成

1. **`public.profiles`** (ユーザー管理・課金用)
   - `id`: UUID (Primary Key, `auth.users.id` 参照)
   - `stripe_customer_id`: Stripe顧客ID
   - `is_subscribed`: サブスクリプション状態
   - `usage_count`: 利用回数
   - `phone_number`: 電話番号（国際形式、例：+81-90-1234-5678）
   - `full_name`: 氏名（例：大塚 孝雄）
   - `account_name`: アカウント名（表示用、例：AiLuna実験店舗）

2. **`public.user_prompts`** (AI設定用)
   - `id`: UUID (Primary Key)
   - `user_id`: UUID (`profiles.id` 参照)
   - `greeting_message`: 挨拶メッセージ
   - `business_description`: 事業内容・指示

3. **`public.call_logs`** (通話履歴)
   - `id`: UUID (Primary Key)
   - `user_id`: UUID (`profiles.id` 参照)
   - `call_sid`: Twilio Call SID
   - `caller_number`: 発信者電話番号
   - `transcript`: JSONB 形式の会話ログ
   - `summary`: AI生成の要約タイトル（20文字程度）
   - `duration_seconds`: 通話時間（秒単位）
   - `created_at`: 通話日時
   - `updated_at`: 更新日時

### セキュリティ (RLS)
- ユーザーは自身のデータのみ読み書き可能 (`auth.uid() = user_id`)
- `profiles` はユーザー登録時にトリガーによって自動作成されます
- `user_prompts` はダッシュボードで設定を保存したタイミングで作成・更新されます

## ダッシュボード設定の保存仕様

- **保存先**: `user_prompts` テーブル
- **データ構造**: 1ユーザーにつき1レコード (`user_id` で一意)
- **挙動**:
  - フォームを開くと、現在の設定が読み込まれます（未設定時は空欄）。
  - 「設定を保存する」ボタンを押すと、`upsert` 処理が実行されます。
  - 既存のレコードがあれば更新、なければ新規作成されます。
  - 保存後はページが再検証され、最新の状態が表示されます。

## セットアップ

### 1. 環境変数の設定

`.env.local` ファイルを作成し、Supabaseのプロジェクト情報を設定してください。

```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
STRIPE_SECRET_KEY=your_stripe_secret_key
```

### 2. Stripe設定

`npm install stripe` でライブラリを導入済みです。
`.env.local` に `STRIPE_SECRET_KEY` を設定してください。

### 3. インストールと実行

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開いて確認してください。

## 開発ガイド

### 認証UXの動作確認

新しい認証フローの動作確認手順：

#### 1. ランディングページ（`/`）の確認
```bash
npm run dev
```
ブラウザで `http://localhost:3000` を開き、以下を確認：
- ヘッダーに「ログイン」と「無料で始める」ボタンが表示されている
- ページ内に認証フォームが**表示されていない**（製品紹介のみ）
- ヒーローセクションの「無料で試してみる」ボタンをクリック → `/login?mode=signup` に遷移
- ヘッダーの「ログイン」ボタンをクリック → `/login?mode=login` に遷移
- ヘッダーの「無料で始める」ボタンをクリック → `/login?mode=signup` に遷移

#### 2. ログインページ（`/login`）の確認
- `http://localhost:3000/login` に直接アクセス → ログインタブがアクティブ
- `http://localhost:3000/login?mode=login` にアクセス → ログインタブがアクティブ
- `http://localhost:3000/login?mode=signup` にアクセス → アカウント登録タブがアクティブ
- フォーム内のタブ切り替えボタンで、ログイン⇔アカウント登録の切り替えが正常に動作

#### 3. レスポンシブデザインの確認
ブラウザのDevToolsでモバイルビューポート（375px幅）に切り替え：
- ヘッダーのボタンが正しく表示され、レイアウトが崩れていない
- ランディングページの各セクションが適切に表示される
- ログインページのフォームが適切に表示される

#### 4. 既存の認証フローの確認
- `/login?mode=signup` から新規登録を実行 → 認証メール送信の成功画面が表示される
- `/login?mode=login` からログインを実行 → ダッシュボードにリダイレクトされる
- パスワードリセットフローが正常に動作する

### コード概要の更新

大きな変更を行った後は、以下のコマンドを実行してコードの要約ファイルを更新してください。

```bash
npm run summary
```

これにより、`project_code_summary.txt` が最新化され、AIエージェントとのコンテキスト共有がスムーズになります。

### バックアップ (Git Push)

開発の区切りやバックアップを取りたいタイミングで、以下のコマンドを実行してください。

```bash
npm run backup
```

このコマンドは以下の処理を自動で行います：
1. 変更の有無をチェック
2. `git add .`
3. 日時入りのメッセージで `git commit`
4. `git push origin main`

※ AIエージェントは自動でプッシュを行いません。バックアップが必要な場合はこのコマンドを使用してください。

## トラブルシューティング

### 通話要約が表示されない場合

ダッシュボードの通話履歴に「要約なし」と表示され続ける場合、バックエンド（AiLuna Call Engine）側の要約生成処理でエラーが発生している可能性があります。
特に、`gpt-5.1` などの最新モデルを使用する場合は、バックエンド側のコードが `developer` ロールや `max_completion_tokens` に対応している必要があります。
正常に生成された場合、Supabaseの `call_logs` テーブルの `summary` カラムにタイトルが保存され、自動的に一覧に反映されます。

## マイページ（ダッシュボード）構成

マイページ（`/dashboard`）は、以下の5つのセクションで構成されています：

1.  **ダッシュボード**: 着信対応回数や利用時間のメトリクスを表示します。
2.  **アカウント管理**: アカウント情報の確認・変更（現在はプレースホルダー）。
3.  **プラン・決済**: 利用プランの確認とアップグレード（現在はプレースホルダー）。
4.  **AIエージェント設定**: 電話応対AIの挨拶や事業内容の設定を行います。
5.  **通話履歴**: 過去の着信履歴と通話内容（書き起こし・要約）を確認できます。

左側のサイドバー（モバイルではハンバーガーメニュー）から各セクションに切り替えることができます。
