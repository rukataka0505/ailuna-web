# AiLuna (SaaS版) - AI電話取次サービス

AI電話取次サービス「AiLuna」のSaaS版Webアプリケーションです。
Next.jsとSupabaseを使用して構築されており、セキュアな認証機能とモダンなLPを備えています。

## 技術スタック

- **Framework**: Next.js 16 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Auth & DB**: Supabase
- **Icons**: Lucide React

## 機能

- **ランディングページ (LP)**:
  - 未ログインユーザー向けのサービス紹介ページ
  - ログイン/新規登録フォームの埋め込み (`src/components/AuthForm.tsx`)
  - レスポンシブデザイン
- **認証機能**:
  - メールアドレス/パスワードによるサインアップ・ログイン
  - Supabase Auth UI と Server Actions を併用
  - ログインページを廃止し、トップページ（LP）に統合
  - 未認証ユーザーは自動的にトップページへリダイレクト
  - **メール認証フロー**:
    - 認証リンククリック後、`/auth/complete`（完了画面）へ遷移
    - 完了画面から「ログインページへ戻る」ボタンでトップページへ移動し、ログインを行うフロー
  - **パスワードリセット機能**:
    - ログインフォームから「パスワードをお忘れですか？」リンクで申請
    - メールで送信されたリンクから `/auth/update-password` ページへ遷移
    - 新しいパスワードを入力して更新
    - 更新完了後はダッシュボードへ自動リダイレクト
- **ダッシュボード**:
  - ログイン済みユーザーのみアクセス可能 (`/dashboard`)
  - ユーザー情報の表示
  - **AI設定**:
    - 電話応答時の挨拶と事業内容を設定可能
    - 設定は `user_prompts` テーブルに保存され、ログインユーザーごとに管理されます
  - **通話履歴**:
    - アコーディオン形式で過去の通話ログを表示
    - クリックで詳細な会話内容を展開/折りたたみ可能
    - AI生成の要約タイトルで内容を一目で把握
    - 日時、電話番号、要約を一覧表示
    - **ページネーション機能**: 「さらに読み込む」ボタンで過去の履歴を順次ロード
    - **高度なフィルター機能**: 
      - **期間指定**: 開始日と終了日を指定してログを絞り込み
      - **発信者指定**: 過去の発信者番号リストから特定の発信者を絞り込み
      - フィルター適用中もページネーションが動作
  - **メトリクス表示**:
    - `call_logs` テーブルから集計した「着信対応回数」と「利用時間」を表示
    - **着信対応回数**: ユーザーの全通話ログ数
    - **利用時間**: `call_logs.duration_seconds` の合計（秒）を分単位で表示。
      - `duration_seconds` が `NULL` のレコード（過去のログなど）は `0` 秒として計算されます。
    - Next.js Streaming (Suspense) を利用し、計算中もスケルトン表示でUIをブロックしない設計
  - ログアウト機能
- **ミドルウェア**:
  - セッション管理とルート保護
  - 未認証ユーザーのダッシュボードアクセス制限
  - LP (`/`) へのパブリックアクセス許可
- **電話番号表示**:
  - ダッシュボード右上（サイドバーおよびモバイルヘッダー）にログインユーザーの電話番号を表示
  - データソース: `profiles.phone_number` カラム
  - 電話番号が登録されている場合: 「電話番号：+81-90-xxxx-xxxx」のように表示
  - 電話番号が未登録の場合: 「電話番号：登録されていません」と表示
  - コンポーネント: `src/components/UserPhoneDisplay.tsx`
  - サーバーアクション: `src/app/dashboard/actions.ts` の `fetchUserProfile()`

## UI/UX改善

### 統一された操作感（インタラクション）
アプリ全体のボタンやインタラクティブ要素に対し、一貫した操作フィードバックを提供します:

1. **クリックエフェクト**
   - 全ての主要ボタンに `active:scale-[0.96]` を適用
   - クリック時にわずかに縮む効果で「押した」感覚を提供
   - ダッシュボード、認証フォーム、設定保存ボタンなど全体で統一

2. **ホバーエフェクト**
   - インタラクティブ要素には `hover:opacity-90` や `hover:bg-XXX-700` を適用
   - マウスオーバー時の反応を明確化

3. **ローディング表現**
   - 処理中（`isPending` / `isLoading`）はボタンを `disabled` に設定
   - `cursor: not-allowed` でインタラクション不可を明示
   - スピナーアイコンと「処理中...」テキストで状態を可視化

### 認証フォームの強化
カスタム認証フォーム (`src/components/AuthForm.tsx`) に以下の機能を実装し、ユーザーエクスペリエンスを大幅に向上させました:

1. **パスワードリセット機能**
   - ログインフォームに「パスワードをお忘れですか?」リンクを配置
   - クリックでリセットモードに切り替わり、メールアドレス入力のみを表示
   - メール送信後、「再設定メールを送信しました」という完了画面を表示
   - メール内のリンクから `/auth/update-password` ページへ遷移
   - 新しいパスワードを2回入力（確認用）して変更を確定

2. **ボタン操作感の向上**
   - クリック時のスケールアニメーション (`active:scale-[0.96]`) を適用
   - 処理中はボタンを無効化し、スピナーと「処理中...」テキストを表示
   - 二重送信を防止

3. **パスワード表示切り替え**
   - パスワード入力欄に目のアイコン (Eye/EyeOff) を配置
   - クリックでパスワードの表示/非表示を切り替え可能

4. **パスワード確認機能**
   - 新規登録時のみ確認用パスワード入力欄を表示
   - クライアント側でパスワード一致を検証
   - 不一致時は即座にエラーメッセージを表示

5. **モード切り替えアニメーション**
   - `framer-motion` を使用したスムーズなトランジション
   - ログイン ⇔ 新規登録 ⇔ パスワードリセットの切り替え時にフェード/スライド効果

6. **登録完了フィードバック**
   - 登録成功時は「認証メールを送信しました」メッセージを表示
   - フォームを非表示にし、完了画面に切り替え
   - サーバーアクション (`signup`) は成功時に `{ success: true }` を返す仕様に変更

### その他のUI改善
- **認証完了ページ** (`/auth/complete`): 「ログインページへ戻る」ボタンにクリックアニメーションを適用
- **パスワード更新ページ** (`/auth/update-password`): 統一されたデザインとインタラクションを実装
- **ダッシュボード**: 
  - 「設定を保存する」ボタンとログアウトボタンにクリックアニメーションを適用
  - 通話履歴フィルターの「検索」「クリア」ボタンにも統一インタラクションを適用
- 統一されたボタンフィードバックによる一貫したUI体験

### 通話履歴フィルターの改善
通話履歴リストのフィルター機能（`src/components/CallLogList.tsx`）を以下の通り改修しました：

1. **ポップアップ表示への変更**
   - フィルターアイコンボタンをクリックした時のみ条件設定フォームを表示
   - 画面の専有面積を減らし、コンテンツ（履歴リスト）を広く表示
   - 直感的な開閉操作（アイコンクリックで開く、外側クリック/×ボタンで閉じる）

2. **視認性の向上**
   - フィルター項目（開始日、終了日、発信者）のラベルテキスト色を濃く調整（`text-zinc-500` → `text-zinc-700`）
   - 入力フィールド内のテキスト色も明確化
   - 全体的なコントラスト比を高め、読みやすさを改善

## Supabase セットアップ
 
 ### 1. プロジェクトの作成
 Supabase で新しいプロジェクトを作成してください。
 
 ### 2. スキーマの適用 (SQL Editor)
 データベースのテーブルとセキュリティ設定を作成します。
 
 1. Supabase ダッシュボードの左サイドバーから **SQL Editor** を開きます。
 2. 「New Query」をクリックして新しいクエリエディタを開きます。
 3. プロジェクトルートの `../supabase/schema.sql` の内容をすべてコピーし、エディタに貼り付けます。
 4. **Run** ボタンをクリックして実行します。
 5. 画面右下のログに "Success" と表示されれば完了です。
 
 ### 3. 通話履歴機能のテーブル追加（追加セットアップ）
  通話履歴機能を使用する場合は、以下のSQLファイルも実行してください：
  
  1. Supabase ダッシュボードの **SQL Editor** を開きます。
  2. `../supabase/add_summary_column.sql` の内容をコピーし、エディタに貼り付けます。
  3. **Run** ボタンをクリックして実行します。
  4. これにより `call_logs` テーブルと `summary` カラムが追加されます。
  
  ### 5. 電話番号表示機能のセットアップ（追加セットアップ）
  電話番号表示機能を使用する場合は、以下のSQLファイルも実行してください：
  
  1. Supabase ダッシュボードの **SQL Editor** を開きます。
  2. `../supabase/add_phone_number_column.sql` の内容をコピーし、エディタに貼り付けます。
  3. **Run** ボタンをクリックして実行します。
  4. これにより `profiles` テーブルに `phone_number` カラムが追加されます。
  
  ### 6. テーブル作成の確認
  左サイドバーの **Table Editor** を開き、以下のテーブルが作成されていることを確認してください：
  
  - `profiles`: ユーザー情報（Stripe IDなど）
  - `user_prompts`: AI設定（挨拶文、事業説明）
  - `call_logs`: 通話履歴（Call Engine からの保存用）
 
 > [!IMPORTANT]
 > `user_prompts` テーブルの `user_id` カラムには **Unique** 制約が必要です。`schema.sql` にはこれが含まれていますが、もし手動で作成した場合は必ず追加してください。これがないと設定の保存（Upsert）が正しく動作しません。

## データベース設計

### テーブル構成

1. **`public.profiles`** (ユーザー管理・課金用)
   - `id`: UUID (Primary Key, `auth.users.id` 参照)
   - `stripe_customer_id`: Stripe顧客ID
   - `is_subscribed`: サブスクリプション状態
   - `usage_count`: 利用回数
   - `phone_number`: 電話番号（国際形式、例：+81-90-1234-5678）

2. **`public.user_prompts`** (AI設定用)
   - `id`: UUID (Primary Key)
   - `user_id`: UUID (`profiles.id` 参照)
   - `greeting_message`: 挨拶メッセージ
   - `business_description`: 事業内容・指示

3. **`public.call_logs`** (通話履歴)
   - `id`: UUID (Primary Key)
   - `user_id`: UUID (`profiles.id` 参照)
   - `call_sid`: Twilio Call SID
   - `caller_number`: 発信者電話番号
   - `transcript`: JSONB 形式の会話ログ
   - `summary`: AI生成の要約タイトル（20文字程度）
   - `duration_seconds`: 通話時間（秒単位）
   - `created_at`: 通話日時
   - `updated_at`: 更新日時

### セキュリティ (RLS)
- ユーザーは自身のデータのみ読み書き可能 (`auth.uid() = user_id`)
- `profiles` はユーザー登録時にトリガーによって自動作成されます
- `user_prompts` はダッシュボードで設定を保存したタイミングで作成・更新されます

## ダッシュボード設定の保存仕様

- **保存先**: `user_prompts` テーブル
- **データ構造**: 1ユーザーにつき1レコード (`user_id` で一意)
- **挙動**:
  - フォームを開くと、現在の設定が読み込まれます（未設定時は空欄）。
  - 「設定を保存する」ボタンを押すと、`upsert` 処理が実行されます。
  - 既存のレコードがあれば更新、なければ新規作成されます。
  - 保存後はページが再検証され、最新の状態が表示されます。

## セットアップ

### 1. 環境変数の設定

`.env.local` ファイルを作成し、Supabaseのプロジェクト情報を設定してください。

```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
STRIPE_SECRET_KEY=your_stripe_secret_key
```

### 2. Stripe設定

`npm install stripe` でライブラリを導入済みです。
`.env.local` に `STRIPE_SECRET_KEY` を設定してください。

### 3. インストールと実行

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開いて確認してください。

## 開発ガイド

### コード概要の更新

大きな変更を行った後は、以下のコマンドを実行してコードの要約ファイルを更新してください。

```bash
npm run summary
```

これにより、`project_code_summary.txt` が最新化され、AIエージェントとのコンテキスト共有がスムーズになります。

### バックアップ (Git Push)

開発の区切りやバックアップを取りたいタイミングで、以下のコマンドを実行してください。

```bash
npm run backup
```

このコマンドは以下の処理を自動で行います：
1. 変更の有無をチェック
2. `git add .`
3. 日時入りのメッセージで `git commit`
4. `git push origin main`

※ AIエージェントは自動でプッシュを行いません。バックアップが必要な場合はこのコマンドを使用してください。

## トラブルシューティング

### 通話要約が表示されない場合

ダッシュボードの通話履歴に「要約なし」と表示され続ける場合、バックエンド（AiLuna Call Engine）側の要約生成処理でエラーが発生している可能性があります。
特に、`gpt-5.1` などの最新モデルを使用する場合は、バックエンド側のコードが `developer` ロールや `max_completion_tokens` に対応している必要があります。
正常に生成された場合、Supabaseの `call_logs` テーブルの `summary` カラムにタイトルが保存され、自動的に一覧に反映されます。
