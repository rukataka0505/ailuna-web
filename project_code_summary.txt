---
File: web/src/app/api/checkout/route.ts
import { NextResponse } from 'next/server';
import { createClient } from '@/utils/supabase/server';
import { stripe } from '@/utils/stripe/server';

export async function POST(request: Request) {
    try {
        // 1. Supabase Auth でログインユーザーを取得
        const supabase = await createClient();
        const { data: { user }, error: authError } = await supabase.auth.getUser();

        if (authError || !user) {
            return NextResponse.json(
                { error: 'Unauthorized. Please log in.' },
                { status: 401 }
            );
        }

        // 2. リクエストの origin を取得（success_url, cancel_url に使用）
        const origin = request.headers.get('origin') || 'http://localhost:3000';

        // 3. 環境変数から Price ID を取得
        const priceId = process.env.NEXT_PUBLIC_STRIPE_PRICE_ID;
        if (!priceId) {
            console.error('NEXT_PUBLIC_STRIPE_PRICE_ID is not set');
            return NextResponse.json(
                { error: 'Server configuration error. Please contact support.' },
                { status: 500 }
            );
        }

        const usagePriceId = process.env.NEXT_PUBLIC_STRIPE_USAGE_PRICE_ID;

        // 4. line_items を動的に構築
        // 重要: 従量課金（usage-based/metered）のPriceには quantity を指定してはいけない
        const lineItems: any[] = [
            {
                price: priceId,
                quantity: 1, // 固定プランには quantity が必要
            }
        ];

        // 従量課金IDが設定されている場合は追加（quantityなし）
        if (usagePriceId) {
            lineItems.push({
                price: usagePriceId,
                // 従量課金プランには quantity を含めない
            });
        } else {
            console.warn('NEXT_PUBLIC_STRIPE_USAGE_PRICE_ID is not set. Usage-based billing will not be enabled.');
        }

        // 5. Stripe Checkout Session を作成
        const session = await stripe.checkout.sessions.create({
            mode: 'subscription',
            payment_method_types: ['card'],
            line_items: lineItems,
            customer_email: user.email,
            client_reference_id: user.id, // Webhook での紐付けに使用
            metadata: {
                userId: user.id,
            },
            success_url: `${origin}/dashboard?payment=success`,
            cancel_url: `${origin}/dashboard?payment=cancelled`,
        });

        // 6. セッション URL を返す
        return NextResponse.json({ url: session.url });

    } catch (error) {
        console.error('Checkout session creation error:', error);
        return NextResponse.json(
            { error: 'Failed to create checkout session. Please try again.' },
            { status: 500 }
        );
    }
}
---
---
File: web/src/app/api/demo-call/token/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/utils/supabase/server'
import { createHmac, createHash } from 'crypto'

/**
 * GET /api/demo-call/token
 * 
 * ログインユーザーに対して、HMAC署名付きトークンを発行。
 * WEB_DEMO_SHARED_SECRET で署名。
 * トークンに timestamp を埋め込み、期限判定は call-engine 側で行う（デフォルト5分 ±60秒の clock skew 許容）。
 */
export async function GET() {
    try {
        const supabase = await createClient()
        const { data: { user } } = await supabase.auth.getUser()

        if (!user) {
            return NextResponse.json(
                { error: 'Unauthorized' },
                { status: 401 }
            )
        }

        const secret = process.env.WEB_DEMO_SHARED_SECRET
        const wsUrl = process.env.CALL_ENGINE_WS_URL

        if (!secret || !wsUrl) {
            console.error('WEB_DEMO_SHARED_SECRET or CALL_ENGINE_WS_URL not configured')
            return NextResponse.json(
                { error: 'Service not configured' },
                { status: 503 }
            )
        }

        // Debug: log sha256 of secret for cross-service verification (never log the actual secret)
        const secretHash = createHash('sha256').update(secret, 'utf8').digest('hex')
        console.log(`WEB_DEMO_SHARED_SECRET sha256=${secretHash} len=${secret.length}`)

        // Generate timestamp (seconds)
        const timestamp = Math.floor(Date.now() / 1000)

        // HMAC-SHA256 signature: hmac = HMAC-SHA256(secret, "${timestamp}.${userId}")
        const dataToSign = `${timestamp}.${user.id}`
        const signature = createHmac('sha256', secret)
            .update(dataToSign)
            .digest('hex')

        // Token format: base64url("${timestamp}.${userId}.${hmacHex}")
        const tokenData = `${timestamp}.${user.id}.${signature}`
        const token = Buffer.from(tokenData).toString('base64url')

        return NextResponse.json({
            token,
            wsUrl: `${wsUrl}/web-demo-media`,
            userId: user.id
        })

    } catch (error) {
        console.error('Demo call token API error:', error)
        return NextResponse.json(
            { error: 'Internal Server Error' },
            { status: 500 }
        )
    }
}

---
---
File: web/src/app/api/webhooks/stripe/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { headers } from 'next/headers'
import Stripe from 'stripe'
import { stripe } from '@/utils/stripe/server'
import { createAdminClient } from '@/utils/supabase/server'

export async function POST(req: NextRequest) {
    const body = await req.text()
    const signature = (await headers()).get('Stripe-Signature') as string

    let event: Stripe.Event

    try {
        if (!process.env.STRIPE_WEBHOOK_SECRET) {
            throw new Error('STRIPE_WEBHOOK_SECRET is missing')
        }
        event = stripe.webhooks.constructEvent(
            body,
            signature,
            process.env.STRIPE_WEBHOOK_SECRET
        )
    } catch (error: any) {
        console.error(`Webhook signature verification failed: ${error.message}`)
        return NextResponse.json({ error: error.message }, { status: 400 })
    }

    if (event.type === 'checkout.session.completed') {
        const session = event.data.object as Stripe.Checkout.Session
        const userId = session.metadata?.userId || session.client_reference_id

        if (userId) {
            const supabase = await createAdminClient()

            // Update user profile
            const { error: profileError } = await supabase
                .from('profiles')
                .update({
                    is_subscribed: true,
                    stripe_customer_id: session.customer as string,
                })
                .eq('id', userId)

            if (profileError) {
                console.error('Error updating profile:', profileError)
                return NextResponse.json({ error: 'Error updating profile' }, { status: 500 })
            }

            // Claim phone number if logic exists
            try {
                // Check if we can claim a phone number using rpc
                const { error: rpcError } = await supabase.rpc('claim_phone_number', {
                    user_id_input: userId,
                })

                if (rpcError) {
                    // Log but don't fail the webhook if phone claim fails (it might be optional or out of numbers)
                    console.warn('Failed to claim phone number or function missing:', rpcError.message)
                } else {
                    console.log('Phone number claimed successfully for user:', userId)
                }
            } catch (err) {
                console.warn('claim_phone_number RPC call exception:', err)
            }
        }
    }

    return NextResponse.json({ received: true })
}

---
---
File: web/src/app/auth/callback/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/utils/supabase/server'

export async function GET(request: Request) {
    const { searchParams, origin } = new URL(request.url)
    const code = searchParams.get('code')
    // パラメータに "next" がある場合、それをリダイレクト先URLとして使用します
    const next = searchParams.get('next') ?? '/auth/complete'

    if (code) {
        const supabase = await createClient()
        const { error } = await supabase.auth.exchangeCodeForSession(code)
        if (!error) {
            const forwardedHost = request.headers.get('x-forwarded-host') // ロードバランサー前の元のオリジン
            const isLocalEnv = process.env.NODE_ENV === 'development'
            if (isLocalEnv) {
                // ロードバランサーが間にないことが確実なため、X-Forwarded-Host を監視する必要はありません
                return NextResponse.redirect(`${origin}${next}`)
            } else if (forwardedHost) {
                return NextResponse.redirect(`https://${forwardedHost}${next}`)
            } else {
                return NextResponse.redirect(`${origin}${next}`)
            }
        }
    }

    // 手順を記載したエラーページにユーザーを戻します
    return NextResponse.redirect(`${origin}/auth/auth-code-error`)
}

---
---
File: web/src/app/auth/complete/page.tsx
import Link from 'next/link'
import { CheckCircle, ArrowRight } from 'lucide-react'

export default function AuthCompletePage() {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
                <div className="p-8 text-center">
                    <div className="flex justify-center mb-6">
                        <div className="bg-green-100 p-3 rounded-full">
                            <CheckCircle className="w-12 h-12 text-green-600" />
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-gray-800 mb-4">
                        メール認証が完了しました
                    </h2>

                    <p className="text-gray-500 mb-8">
                        このままログインしてマイページを開き、<br />
                        サービスの利用を開始できます。
                    </p>

                    <Link
                        href="/dashboard"
                        className="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all active:scale-[0.96]"
                    >
                        ログインしてマイページを開く
                        <ArrowRight className="ml-2 h-4 w-4" />
                    </Link>
                </div>
            </div>
        </div>
    )
}

---
---
File: web/src/app/auth/update-password/actions.ts
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { createClient } from '@/utils/supabase/server'

export async function updatePassword(formData: FormData): Promise<{ error: string } | undefined> {
    const supabase = await createClient()

    const password = formData.get('password') as string

    const { error } = await supabase.auth.updateUser({
        password,
    })

    if (error) {
        console.error('Update password error:', error)
        return { error: 'パスワードの更新に失敗しました。もう一度お試しください。' }
    }

    revalidatePath('/', 'layout')
    redirect('/dashboard')
}

---
---
File: web/src/app/auth/update-password/page.tsx
'use client'

import { useState } from 'react'
import { updatePassword } from './actions'
import { Lock, ArrowRight, Eye, EyeOff, Loader2, KeyRound } from 'lucide-react'
import { motion } from 'framer-motion'

export default function UpdatePasswordPage() {
    const [errorMessage, setErrorMessage] = useState<string | null>(null)
    const [showPassword, setShowPassword] = useState(false)
    const [showConfirmPassword, setShowConfirmPassword] = useState(false)
    const [isSubmitting, setIsSubmitting] = useState(false)

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        setErrorMessage(null)
        const formData = new FormData(e.currentTarget)

        const password = formData.get('password') as string
        const confirmPassword = formData.get('confirmPassword') as string

        if (password !== confirmPassword) {
            setErrorMessage('パスワードが一致しません。')
            return
        }

        if (password.length < 6) {
            setErrorMessage('パスワードは6文字以上で入力してください。')
            return
        }

        setIsSubmitting(true)

        const result = await updatePassword(formData)

        setIsSubmitting(false)

        if (result && 'error' in result) {
            setErrorMessage(result.error)
        }
    }

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden"
            >
                <div className="p-8">
                    <div className="flex justify-center mb-6">
                        <div className="bg-indigo-100 p-3 rounded-full">
                            <KeyRound className="w-8 h-8 text-indigo-600" />
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">
                        新しいパスワードの設定
                    </h2>
                    <p className="text-center text-gray-500 mb-8">
                        新しいパスワードを入力してください
                    </p>

                    {errorMessage && (
                        <motion.div
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700"
                        >
                            <p className="font-bold">エラー</p>
                            <p>{errorMessage}</p>
                        </motion.div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-900 mb-1">
                                新しいパスワード
                            </label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <Lock className="h-5 w-5 text-gray-400" />
                                </div>
                                <input
                                    name="password"
                                    type={showPassword ? 'text' : 'password'}
                                    required
                                    className="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                    placeholder="••••••••"
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowPassword(!showPassword)}
                                    className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    {showPassword ? (
                                        <EyeOff className="h-5 w-5" />
                                    ) : (
                                        <Eye className="h-5 w-5" />
                                    )}
                                </button>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-900 mb-1">
                                新しいパスワード (確認用)
                            </label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <Lock className="h-5 w-5 text-gray-400" />
                                </div>
                                <input
                                    name="confirmPassword"
                                    type={showConfirmPassword ? 'text' : 'password'}
                                    required
                                    className="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                    placeholder="••••••••"
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                    className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    {showConfirmPassword ? (
                                        <EyeOff className="h-5 w-5" />
                                    ) : (
                                        <Eye className="h-5 w-5" />
                                    )}
                                </button>
                            </div>
                        </div>

                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all active:scale-[0.96] disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100"
                        >
                            {isSubmitting ? (
                                <>
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                    更新中...
                                </>
                            ) : (
                                <>
                                    変更する
                                    <ArrowRight className="ml-2 h-4 w-4" />
                                </>
                            )}
                        </button>
                    </form>
                </div>
                <div className="bg-gray-50 px-8 py-4 border-t border-gray-100 text-center">
                    <p className="text-xs text-gray-500">
                        パスワードは6文字以上で設定してください。
                    </p>
                </div>
            </motion.div>
        </div>
    )
}

---
---
File: web/src/app/dashboard/actions/agents.ts
'use server'

import { createClient } from '@/utils/supabase/server'
import { redirect } from 'next/navigation'
import { revalidatePath } from 'next/cache'
import { ConfigMetadata } from '@/types/agent'

export async function saveAgentSettings(
    systemPrompt: string,
    configMetadata: ConfigMetadata
) {
    const supabase = await createClient()

    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        redirect('/login')
    }

    const { error } = await supabase
        .from('user_prompts')
        .upsert(
            {
                user_id: user.id,
                system_prompt: systemPrompt,
                config_metadata: configMetadata, // Note: DB schema update required for this column if not exists, or it might be JSONB
                updated_at: new Date().toISOString()
            },
            { onConflict: 'user_id' }
        )

    if (error) {
        console.error('Error saving agent settings:', error)
        return { error: '設定の保存に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '設定を保存しました。' }
}

export async function deleteAgentSettings() {
    const supabase = await createClient()

    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        redirect('/login')
    }

    const { error } = await supabase
        .from('user_prompts')
        .delete()
        .eq('user_id', user.id)

    if (error) {
        console.error('Error deleting agent settings:', error)
        return { error: '設定の削除に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '設定を削除しました。' }
}

---
---
File: web/src/app/dashboard/actions/auth.ts
'use server'

import { createClient } from '@/utils/supabase/server'
import { redirect } from 'next/navigation'

export async function signOut() {
    const supabase = await createClient()
    await supabase.auth.signOut()
    redirect('/')
}

export async function fetchUserProfile() {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        return null
    }

    const { data, error } = await supabase
        .from('profiles')
        .select('phone_number, account_name')
        .eq('id', user.id)
        .single()

    if (error) {
        console.error('Error fetching user profile:', error)
        return null
    }

    return data
}

---
---
File: web/src/app/dashboard/actions/calls.ts
'use server'

import { createClient } from '@/utils/supabase/server'

export async function fetchUniqueCallerNumbers() {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        return []
    }

    // caller_numberのみを取得
    const { data, error } = await supabase
        .from('call_logs')
        .select('caller_number')
        .eq('user_id', user.id)
        .not('caller_number', 'is', null)
        .order('caller_number', { ascending: true })

    if (error) {
        console.error('Error fetching unique caller numbers:', error)
        return []
    }

    // 重複を除去して配列を返す
    const uniqueNumbers = Array.from(new Set(data.map(item => item.caller_number))).filter(Boolean) as string[]
    return uniqueNumbers
}

export type FilterParams = {
    startDate?: string
    endDate?: string
    callerNumber?: string
}

export async function fetchCallLogsPaginated(
    offset: number,
    limit: number,
    filters: FilterParams = {}
) {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        throw new Error('Unauthorized')
    }

    // 一覧表示に必要なカラムのみ取得（transcriptは展開時に別途取得）
    let query = supabase
        .from('call_logs')
        .select('id, created_at, caller_number, duration_seconds, summary', { count: 'exact' })
        .eq('user_id', user.id)

    // フィルター適用
    if (filters.startDate) {
        // 開始日の00:00:00から
        query = query.gte('created_at', `${filters.startDate}T00:00:00`)
    }
    if (filters.endDate) {
        // 終了日の23:59:59まで
        query = query.lte('created_at', `${filters.endDate}T23:59:59`)
    }
    if (filters.callerNumber && filters.callerNumber !== 'all') {
        query = query.eq('caller_number', filters.callerNumber)
    }

    // 常に作成日時降順（新しい順）
    const { data, count, error } = await query
        .order('created_at', { ascending: false })
        .range(offset, offset + limit - 1)

    if (error) {
        console.error('Error fetching call logs:', error)
        throw new Error('Failed to fetch call logs')
    }

    return { logs: data, count }
}

export type CallMetrics = {
    totalCalls: number
    totalDurationMinutes: number
}

export async function fetchCallMetrics(): Promise<CallMetrics> {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        return { totalCalls: 0, totalDurationMinutes: 0 }
    }

    // 着信対応回数を取得
    const { count, error: countError } = await supabase
        .from('call_logs')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.id)

    if (countError) {
        console.error('Error fetching call metrics (count):', countError)
        return { totalCalls: 0, totalDurationMinutes: 0 }
    }

    // 合計利用時間をSQLで計算（スケーラブル）
    const { data: sumData, error: sumError } = await supabase
        .rpc('sum_call_duration_seconds', { target_user_id: user.id })

    let totalSeconds = 0
    if (sumError) {
        console.error('Error fetching call metrics (sum):', sumError)
        // RPCがない場合はフォールバック
        const { data: durationData } = await supabase
            .from('call_logs')
            .select('duration_seconds')
            .eq('user_id', user.id)
        if (durationData) {
            totalSeconds = durationData.reduce((acc, curr) => acc + (curr.duration_seconds || 0), 0)
        }
    } else {
        totalSeconds = sumData || 0
    }

    // 秒 -> 分（小数点第1位まで）
    const totalDurationMinutes = Number((totalSeconds / 60).toFixed(1))

    return {
        totalCalls: count || 0,
        totalDurationMinutes
    }
}

/**
 * 展開時にトランスクリプトを個別取得（遅延ロード）
 */
export async function fetchCallTranscript(callId: string): Promise<string | null> {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        throw new Error('Unauthorized')
    }

    const { data, error } = await supabase
        .from('call_logs')
        .select('transcript')
        .eq('id', callId)
        .eq('user_id', user.id)
        .single()

    if (error) {
        console.error('Error fetching call transcript:', error)
        return null
    }

    return data?.transcript || null
}

---
---
File: web/src/app/dashboard/actions/forms.ts
'use server'

import { createClient } from '@/utils/supabase/server'
import { revalidatePath } from 'next/cache'

// Note: Future expansions might include 'datetime' or 'phone', but currently UI handles these.
export type ReservationFieldType = 'text' | 'number' | 'date' | 'time' | 'select' | 'multiline'

export type ReservationField = {
    id: string
    field_key: string
    label: string
    field_type: ReservationFieldType
    required: boolean
    enabled: boolean
    options?: string[] | null // For 'select' type
    display_order: number
}

// Helper to fetch list
export async function listReservationFields(): Promise<ReservationField[]> {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) return []

    const { data, error } = await supabase
        .from('reservation_form_fields')
        .select('*')
        .eq('user_id', user.id)
        .order('display_order', { ascending: true })

    if (error) {
        console.error('Error fetching form fields:', error)
        return []
    }

    return data as ReservationField[]
}

// Initialize defaults (Smart Merge)
export async function initializeDefaultFields() {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    // Fetch existing field keys
    const { data: existingFields } = await supabase
        .from('reservation_form_fields')
        .select('field_key')
        .eq('user_id', user.id)

    const existingKeys = new Set(existingFields?.map(f => f.field_key) || [])

    const defaults = [
        { field_key: 'customer_name', label: 'お名前', field_type: 'text', required: true, enabled: true, display_order: 1 },
        { field_key: 'party_size', label: '人数', field_type: 'number', required: true, enabled: true, display_order: 2 },
        { field_key: 'requested_date', label: '希望日', field_type: 'date', required: true, enabled: true, display_order: 3 },
        { field_key: 'requested_time', label: '希望時間', field_type: 'time', required: true, enabled: true, display_order: 4 },
        { field_key: 'notes', label: '備考・ご要望', field_type: 'multiline', required: false, enabled: true, display_order: 5 },
    ]

    // Filter to find missing defaults
    const missingDefaults = defaults.filter(d => !existingKeys.has(d.field_key))

    if (missingDefaults.length === 0) {
        return { success: 'すべてのデフォルト項目は既に存在します。' }
    }

    // Insert missing
    // Smart merge strategy: append to end.
    const { data: maxOrderData } = await supabase
        .from('reservation_form_fields')
        .select('display_order')
        .eq('user_id', user.id)
        .order('display_order', { ascending: false })
        .limit(1)
        .single()

    let nextOrder = (maxOrderData?.display_order || 0) + 1

    const inserts = missingDefaults.map((d, index) => ({
        ...d,
        user_id: user.id,
        display_order: nextOrder + index
    }))

    const { error } = await supabase
        .from('reservation_form_fields')
        .insert(inserts)

    if (error) {
        console.error('Error initializing fields:', error)
        return { error: '項目の追加に失敗しました。' }
    }

    revalidatePath('/dashboard')
    const addedNames = missingDefaults.map(d => d.label).join('、')
    return { success: `不足していた項目を追加しました（${addedNames}）。` }
}

export async function createReservationField(field: Omit<ReservationField, 'id'>) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const { error } = await supabase
        .from('reservation_form_fields')
        .insert({
            user_id: user.id,
            field_key: field.field_key,
            label: field.label,
            field_type: field.field_type,
            required: field.required,
            enabled: field.enabled,
            options: field.options,
            display_order: field.display_order
        })

    if (error) {
        console.error('Error creating field:', error)
        return { error: '項目の作成に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '項目を作成しました。' }
}

export async function updateReservationField(id: string, updates: Partial<ReservationField>) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const { error } = await supabase
        .from('reservation_form_fields')
        .update({
            ...updates,
            // Prevent changing user_id or id via updates spread if checked purely by TS
        })
        .eq('id', id)
        .eq('user_id', user.id)

    if (error) {
        console.error('Error updating field:', error)
        return { error: '項目の更新に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '項目を更新しました。' }
}

export async function deleteReservationField(id: string) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const { error } = await supabase
        .from('reservation_form_fields')
        .delete()
        .eq('id', id)
        .eq('user_id', user.id)

    if (error) {
        console.error('Error deleting field:', error)
        return { error: '項目の削除に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '項目を削除しました。' }
}

export async function reorderReservationFields(idsInOrder: string[]) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    // This is not the most efficient way (N updates), but sufficient for small number of fields (usually < 20).
    let hasError = false
    for (let i = 0; i < idsInOrder.length; i++) {
        const { error } = await supabase
            .from('reservation_form_fields')
            .update({ display_order: i + 1 })
            .eq('id', idsInOrder[i])
            .eq('user_id', user.id)

        if (error) {
            console.error(`Error reordering field ${idsInOrder[i]}:`, error)
            hasError = true
        }
    }

    if (hasError) {
        return { error: '並べ替え中にエラーが発生しましたが、一部は反映された可能性があります。' }
    }

    revalidatePath('/dashboard')
    return { success: '並べ替えを保存しました。' }
}

---
---
File: web/src/app/dashboard/actions/index.ts
// Re-export all actions from individual modules
// This maintains backwards compatibility with imports from '../actions'

// Agent settings
export {
    saveAgentSettings,
    deleteAgentSettings,
} from './agents'

// Authentication
export {
    signOut,
    fetchUserProfile,
} from './auth'

// Call logs
export {
    fetchUniqueCallerNumbers,
    fetchCallLogsPaginated,
    fetchCallMetrics,
    type FilterParams,
    type CallMetrics,
} from './calls'

// Reservation form fields
export {
    listReservationFields,
    createReservationField,
    updateReservationField,
    deleteReservationField,
    reorderReservationFields,
    initializeDefaultFields,
    type ReservationField,
    type ReservationFieldType,
} from './forms'

// Reservations
export {
    fetchReservationRequestsPaginated,
    approveReservationRequest,
    rejectReservationRequest,
    type ReservationStatus,
    type ReservationFilterParams,
} from './reservations'

// Store notification settings
export {
    getStoreNotificationSettings,
    upsertStoreNotificationSettings,
    createLineLinkToken,
    getActiveLineLinkToken,
    type StoreNotificationSettings,
} from './settings'

---
---
File: web/src/app/dashboard/actions/reservations.ts
'use server'

import { createClient } from '@/utils/supabase/server'
import { revalidatePath } from 'next/cache'
import { sendSMS } from '@/utils/twilio'

/**
 * Check if phone number is in E.164 format (e.g., +81901234567)
 * Non-E.164 numbers (like demo calls) won't receive SMS
 */
function isE164PhoneNumber(phone: string | null | undefined): boolean {
    if (!phone) return false
    // E.164: starts with + followed by 7-15 digits
    return /^\+[1-9]\d{6,14}$/.test(phone)
}

export type ReservationStatus = 'pending' | 'approved' | 'rejected' | 'auto_approved'

export type ReservationFilterParams = {
    status?: ReservationStatus | 'all'
    startDate?: string
    endDate?: string
}

export async function fetchReservationRequestsPaginated(
    offset: number,
    limit: number,
    filters: ReservationFilterParams = {}
) {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        throw new Error('Unauthorized')
    }

    let query = supabase
        .from('reservation_requests')
        .select('*', { count: 'exact' })
        .eq('user_id', user.id)

    // フィルター適用
    if (filters.status && filters.status !== 'all') {
        query = query.eq('status', filters.status)
    }
    if (filters.startDate) {
        query = query.gte('created_at', `${filters.startDate}T00:00:00`)
    }
    if (filters.endDate) {
        query = query.lte('created_at', `${filters.endDate}T23:59:59`)
    }

    // 新しい順
    const { data, count, error } = await query
        .order('created_at', { ascending: false })
        .range(offset, offset + limit - 1)

    if (error) {
        console.error('Error fetching reservation requests:', error)
        throw new Error('Failed to fetch reservation requests')
    }

    return { requests: data, count }
}

export async function approveReservationRequest(
    id: string,
    internalNote?: string,
    customerMessage?: string
) {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: request, error: fetchError } = await supabase
        .from('reservation_requests')
        .select('*')
        .eq('id', id)
        .eq('user_id', user.id)
        .single()

    if (fetchError || !request) {
        return { error: '予約情報の取得に失敗しました。' }
    }

    // 既に完了している場合は何もしない（あるいはエラーを返すか、UIが制御している前提で進める）
    // 要件：statusがpending以外ならブロック
    if (request.status !== 'pending') {
        return { error: '既に処理済みの予約です。' }
    }

    const { error } = await supabase
        .from('reservation_requests')
        .update({
            status: 'approved',
            decided_at: new Date().toISOString(),
            decided_by: user.id,
            internal_note: internalNote,
            customer_message: customerMessage,
        })
        .eq('id', id)
        .eq('user_id', user.id)

    if (error) {
        console.error('Error approving reservation:', error)
        return { error: '承認に失敗しました。' }
    }

    // SMS送信 (失敗してもエラーにはしないがログに残す)
    // ガード：送信済みなら送らない
    if (request.sms_sent_at) {
        revalidatePath('/dashboard')
        return { success: '予約を承認しました。（SMSは既に送信済みです）' }
    }
    try {
        const { data: profile } = await supabase
            .from('profiles')
            .select('phone_number')
            .eq('id', user.id)
            .single()

        // 日時の構築: Date型変換せず文字列として処理する
        let dateStr = ''
        if (request.requested_date) {
            const parts = request.requested_date.split('-') // YYYY-MM-DD
            if (parts.length === 3) {
                dateStr = `${Number(parts[1])}/${Number(parts[2])}`
            } else {
                dateStr = request.requested_date
            }
        }

        let timeStr = ''
        if (request.requested_time) {
            // HH:mm:ss -> HH:mm
            timeStr = request.requested_time.substring(0, 5)
        }

        // 構造化データがない場合はテキストでフォールバック
        const dateTimeDisplay = (dateStr && timeStr)
            ? `${dateStr} ${timeStr}`
            : (dateStr || request.requested_datetime_text || '')

        const partySizeStr = request.party_size ? `（人数:${request.party_size}）` : ''

        // Fetch SMS templates
        const { data: userPrompt } = await supabase
            .from('user_prompts')
            .select('config_metadata')
            .eq('user_id', user.id)
            .single()

        const templates = (userPrompt?.config_metadata as any)?.sms_templates
        let body = ''

        if (templates?.approved) {
            // Use Template
            body = templates.approved
                .replace('{{dateTime}}', dateTimeDisplay)
                .replace('{{partySize}}', partySizeStr)
        } else {
            // Default
            body = `ご予約を承りました。${dateTimeDisplay}${partySizeStr}で確定しました。`
        }

        // Auto-append customer message if provided
        if (customerMessage) {
            body += `\n\n${customerMessage}`
        }
        const fromNumber = profile?.phone_number || undefined

        // E.164チェック: デモ通話など非E.164の場合はSMS送信をスキップ
        if (!isE164PhoneNumber(request.customer_phone)) {
            revalidatePath('/dashboard')
            return { success: '予約を承認しました（デモ通話のためSMSは送信しません）' }
        }

        if (request.customer_phone && !request.sms_sent_at) {
            await sendSMS(request.customer_phone, body, fromNumber)

            // Log SMS sent
            await supabase
                .from('reservation_requests')
                .update({
                    sms_body_sent: body,
                    sms_sent_at: new Date().toISOString()
                })
                .eq('id', id)
        }
    } catch (smsError) {
        console.error('SMS sending failed:', smsError)
        return { success: '予約を承認しました。SMS通知の送信に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '予約を承認し、SMS通知を送信しました。' }
}

export async function rejectReservationRequest(
    id: string,
    reason: string,
    internalNote?: string,
    customerMessage?: string
) {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: request, error: fetchError } = await supabase
        .from('reservation_requests')
        .select('*')
        .eq('id', id)
        .eq('user_id', user.id)
        .single()

    if (fetchError || !request) {
        return { error: '予約情報の取得に失敗しました。' }
    }

    // 要件：statusがpending以外ならブロック
    if (request.status !== 'pending') {
        return { error: '既に処理済みの予約です。' }
    }

    const { error } = await supabase
        .from('reservation_requests')
        .update({
            status: 'rejected',
            decided_at: new Date().toISOString(),
            decided_by: user.id,
            decision_reason: reason,
            internal_note: internalNote,
            customer_message: customerMessage,
        })
        .eq('id', id)
        .eq('user_id', user.id)

    if (error) {
        console.error('Error rejecting reservation:', error)
        return { error: '却下に失敗しました。' }
    }

    // SMS送信
    // ガード：送信済みなら送らない
    if (request.sms_sent_at) {
        revalidatePath('/dashboard')
        return { success: '予約を却下しました。（SMSは既に送信済みです）' }
    }
    try {
        const { data: profile } = await supabase
            .from('profiles')
            .select('phone_number')
            .eq('id', user.id)
            .single()

        // Fetch SMS templates
        const { data: userPrompt } = await supabase
            .from('user_prompts')
            .select('config_metadata')
            .eq('user_id', user.id)
            .single()

        const templates = (userPrompt?.config_metadata as any)?.sms_templates
        let body = ''

        if (templates?.rejected) {
            // Use Template
            body = templates.rejected
                .replace('{{reason}}', reason)
        } else {
            // Default
            body = `申し訳ありません。ご希望の日時はお受けできませんでした。${reason ? '\n' + reason : ''}`
        }

        // Auto-append customer message if provided
        if (customerMessage) {
            body += `\n\n${customerMessage}`
        }
        const fromNumber = profile?.phone_number || undefined

        // E.164チェック: デモ通話など非E.164の場合はSMS送信をスキップ
        if (!isE164PhoneNumber(request.customer_phone)) {
            revalidatePath('/dashboard')
            return { success: '予約を却下しました（デモ通話のためSMSは送信しません）' }
        }

        if (request.customer_phone && !request.sms_sent_at) {
            await sendSMS(request.customer_phone, body, fromNumber)

            // Log SMS sent
            await supabase
                .from('reservation_requests')
                .update({
                    sms_body_sent: body,
                    sms_sent_at: new Date().toISOString()
                })
                .eq('id', id)
        }
    } catch (smsError) {
        console.error('SMS sending failed:', smsError)
        return { success: '予約を却下しました。SMS通知の送信に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '予約を却下し、SMS通知を送信しました。' }
}

---
---
File: web/src/app/dashboard/actions/settings.ts
'use server'

import { createClient } from '@/utils/supabase/server'
import { revalidatePath } from 'next/cache'
import { randomBytes } from 'crypto'

export type StoreNotificationSettings = {
    notify_email_enabled: boolean
    notify_emails: string[]
    notify_line_enabled: boolean
    line_target_id?: string | null
}

export async function getStoreNotificationSettings(): Promise<StoreNotificationSettings | null> {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        return null
    }

    const { data, error } = await supabase
        .from('store_notification_settings')
        .select('notify_email_enabled, notify_emails, notify_line_enabled, line_target_id')
        .eq('user_id', user.id)
        .single()

    if (error) {
        // If not found, return defaults or null. Let's return defaults if it's "PGRST116" (JSON object requested, multiple (or no) results returned)
        if (error.code === 'PGRST116') {
            return {
                notify_email_enabled: false,
                notify_emails: [],
                notify_line_enabled: false
            }
        }
        console.error('Error fetching store settings:', error)
        return null
    }

    return data as StoreNotificationSettings
}

export async function createLineLinkToken() {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    // Generate readable code
    const chars = '23456789ABCDEFGHJKLMNPQRSTUVWXYZ'
    const codeLen = 6
    const maxRetries = 5

    for (let i = 0; i < maxRetries; i++) {
        const randomValues = randomBytes(codeLen)
        let tokenCode = ''
        for (let j = 0; j < codeLen; j++) {
            tokenCode += chars[randomValues[j] % chars.length]
        }

        const expiresAt = new Date(Date.now() + 10 * 60 * 1000).toISOString() // 10 mins

        const { error } = await supabase
            .from('line_link_tokens')
            .insert({
                user_id: user.id,
                token: tokenCode,
                expires_at: expiresAt
            })

        if (!error) {
            return { token_code: tokenCode, expires_at: expiresAt }
        }
        // If UNIQUE failure, retry. Else return error
        if (error.code !== '23505') { // 23505 = unique_violation // Postgres
            console.error('Error creating token:', error)
            return { error: 'コードの発行に失敗しました。' }
        }
    }
    return { error: 'コードの発行に失敗しました(リトライ上限)。' }
}

export async function getActiveLineLinkToken() {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return null

    const { data, error } = await supabase
        .from('line_link_tokens')
        .select('token, expires_at')
        .eq('user_id', user.id)
        .is('used_at', null)
        .gt('expires_at', new Date().toISOString())
        .order('created_at', { ascending: false })
        .limit(1)
        .single()

    if (error) return null

    return { token_code: data.token, expires_at: data.expires_at }
}

export async function upsertStoreNotificationSettings(
    settings: StoreNotificationSettings
) {
    const supabase = await createClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { error } = await supabase
        .from('store_notification_settings')
        .upsert({
            user_id: user.id,
            notify_email_enabled: settings.notify_email_enabled,
            notify_emails: settings.notify_emails,
            notify_line_enabled: settings.notify_line_enabled,
            updated_at: new Date().toISOString()
        })

    if (error) {
        console.error('Error saving store settings:', error)
        return { error: '設定の保存に失敗しました。' }
    }

    revalidatePath('/dashboard')
    return { success: '通知設定を保存しました。' }
}

---
---
File: web/src/app/dashboard/ConciergeBuilder.tsx
'use client'

/**
 * Setup Concierge - AI電話番の設定コンポーネント (Redesigned)
 * 
 * 機能は維持しつつ、UI/UXを大幅に刷新。
 * - "AI電話番設定"の表示を削除
 * - 入力フィールドの視認性向上
 * - プレミアムなデザイン適用
 */

import { useState, useEffect } from 'react'
import { AgentSettings } from '@/types/agent'
import { Save, Loader2, Trash2, Sparkles, Info, Store, MessageSquare, Quote, Smartphone } from 'lucide-react'
import { saveAgentSettings, deleteAgentSettings } from './actions'

interface ConciergeBuilderProps {
    initialSettings: AgentSettings
}

const BLANK_SETTINGS: AgentSettings = {
    system_prompt: '',
    config_metadata: {
        tone: undefined,
        greeting_message: '',
        business_description: '',
        rules: [],
        business_type: '',
        sms_templates: {
            approved: 'ご予約を承りました。{{dateTime}}{{partySize}}',
            rejected: '申し訳ありません。ご希望の日時はお受けできませんでした。{{reason}}'
        }
    }
}

const DEFAULT_SETTINGS: AgentSettings = {
    system_prompt: `## 店舗基本情報
- 店名: 居酒屋AiLuna
- 営業時間: 11:00〜22:00（ラストオーダー 21:30）
- 定休日: 毎週月曜日
- 住所: 東京都渋谷区渋谷1-2-3
- 電話番号: 03-1234-5678

## よくある質問
- 駐車場: 近隣にコインパーキングあり
- 支払い方法: 現金、クレジットカード、電子マネー対応
- 個室: 4名様用個室あり（要予約）`,
    config_metadata: {
        tone: 'polite',
        greeting_message: 'お電話ありがとうございます。居酒屋AiLunaでございます。ご予約のお電話でしょうか？',
        business_description: '',
        rules: [],
        business_type: '飲食店',
        sms_templates: {
            approved: '【居酒屋AiLuna】ご予約を承りました。\n{{dateTime}}\n{{partySize}}\nご来店をお待ちしております。',
            rejected: '【居酒屋AiLuna】申し訳ございません。{{reason}}\n別の日時でのご予約をご検討いただけますと幸いです。'
        }
    }
}

export function ConciergeBuilder({ initialSettings }: ConciergeBuilderProps) {
    const [isSaving, setIsSaving] = useState(false)
    const [isResettingSettings, setIsResettingSettings] = useState(false)
    const [isApplyingDefaults, setIsApplyingDefaults] = useState(false)
    const [showSmsHelp, setShowSmsHelp] = useState(false)

    const [currentSettings, setCurrentSettings] = useState<AgentSettings>(initialSettings || BLANK_SETTINGS)
    const [savedSettings, setSavedSettings] = useState<AgentSettings>(initialSettings || BLANK_SETTINGS)

    useEffect(() => {
        if (initialSettings) {
            setCurrentSettings(initialSettings)
            setSavedSettings(initialSettings)
        }
    }, [initialSettings])

    const handleSave = async () => {
        if (isSaving) return
        setIsSaving(true)

        try {
            const result = await saveAgentSettings(currentSettings.system_prompt, currentSettings.config_metadata)
            if (result.error) {
                alert(result.error)
            } else {
                setSavedSettings(currentSettings)
                // Optional: Toast notification here would be better
            }
        } catch (error) {
            console.error('Save error:', error)
            alert('保存中にエラーが発生しました。')
        } finally {
            setIsSaving(false)
        }
    }

    const handleResetSettings = async () => {
        if (!window.confirm('設定がすべて破棄されますが、よろしいですか？\nデータベースからも完全に削除されます。')) {
            return
        }

        setIsResettingSettings(true)

        try {
            const result = await deleteAgentSettings()
            if (result.error) {
                alert(result.error)
                return
            }

            setCurrentSettings(BLANK_SETTINGS)
            setSavedSettings(BLANK_SETTINGS)
        } catch (error) {
            console.error('Reset error:', error)
            alert('設定のリセット中にエラーが発生しました。')
        } finally {
            setIsResettingSettings(false)
        }
    }

    const handleApplyDefaults = async () => {
        if (!window.confirm('未入力の項目に例文を入力します。\n既存の設定は上書きされません。\n\n続行しますか？')) {
            return
        }

        setIsApplyingDefaults(true)

        try {
            const mergedSettings: AgentSettings = {
                system_prompt: currentSettings.system_prompt?.trim() || DEFAULT_SETTINGS.system_prompt,
                config_metadata: {
                    tone: currentSettings.config_metadata?.tone || DEFAULT_SETTINGS.config_metadata.tone,
                    greeting_message: currentSettings.config_metadata?.greeting_message?.trim() || DEFAULT_SETTINGS.config_metadata.greeting_message,
                    business_description: currentSettings.config_metadata?.business_description?.trim() || DEFAULT_SETTINGS.config_metadata.business_description,
                    rules: currentSettings.config_metadata?.rules?.length ? currentSettings.config_metadata.rules : DEFAULT_SETTINGS.config_metadata.rules,
                    business_type: currentSettings.config_metadata?.business_type?.trim() || DEFAULT_SETTINGS.config_metadata.business_type,
                    sms_templates: {
                        approved: currentSettings.config_metadata?.sms_templates?.approved?.trim() || DEFAULT_SETTINGS.config_metadata.sms_templates!.approved,
                        rejected: currentSettings.config_metadata?.sms_templates?.rejected?.trim() || DEFAULT_SETTINGS.config_metadata.sms_templates!.rejected
                    }
                }
            }

            const result = await saveAgentSettings(mergedSettings.system_prompt, mergedSettings.config_metadata)
            if (result.error) {
                alert(result.error)
                return
            }

            setCurrentSettings(mergedSettings)
            setSavedSettings(mergedSettings)
        } catch (error) {
            console.error('Apply defaults error:', error)
            alert('デフォルト設定の適用中にエラーが発生しました。')
        } finally {
            setIsApplyingDefaults(false)
        }
    }

    const hasChanges = JSON.stringify(currentSettings) !== JSON.stringify(savedSettings)

    return (
        <div className="flex flex-col h-full bg-zinc-50/50">
            {/* Header Actions - Floating or Top Bar */}
            <div className="flex justify-end items-center gap-3 pb-4 px-1">
                <div className="flex items-center gap-2">
                    <button
                        onClick={handleResetSettings}
                        disabled={isSaving || isResettingSettings || isApplyingDefaults || !currentSettings?.system_prompt}
                        className="p-2 text-zinc-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all disabled:opacity-30 tooltip-trigger"
                        title="設定をリセット"
                    >
                        {isResettingSettings ? <Loader2 className="h-5 w-5 animate-spin" /> : <Trash2 className="h-5 w-5" />}
                    </button>

                    <button
                        onClick={handleApplyDefaults}
                        disabled={isSaving || isResettingSettings || isApplyingDefaults}
                        className="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all bg-white text-indigo-600 border border-indigo-100 shadow-sm hover:shadow-md hover:bg-indigo-50/50 disabled:opacity-50"
                    >
                        {isApplyingDefaults ? <Loader2 className="h-4 w-4 animate-spin" /> : <Sparkles className="h-4 w-4" />}
                        例文を入力
                    </button>

                    <button
                        onClick={handleSave}
                        disabled={isSaving || isApplyingDefaults || !hasChanges}
                        className={`flex items-center gap-2 px-6 py-2 rounded-xl text-sm font-medium transition-all shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed ${!hasChanges
                            ? 'bg-zinc-100 text-zinc-400 border border-zinc-200'
                            : 'bg-zinc-900 text-white hover:bg-zinc-800 hover:scale-[1.02]'
                            }`}
                    >
                        {isSaving ? <Loader2 className="h-4 w-4 animate-spin" /> : <Save className="h-4 w-4" />}
                        変更を保存
                    </button>
                </div>
            </div>

            {/* Scrollable Content */}
            <div className="flex-1 overflow-y-auto pr-2 pb-10 space-y-6">

                {/* 1. Basic Info Card */}
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-zinc-100/80">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
                            <Store className="h-5 w-5" />
                        </div>
                        <h3 className="font-semibold text-zinc-800 text-lg">お店の設定</h3>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-2">
                            <label className="text-sm font-medium text-zinc-700 block">業種</label>
                            <input
                                type="text"
                                className="w-full text-base px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-zinc-400"
                                value={currentSettings?.config_metadata?.business_type || ''}
                                onChange={(e) => setCurrentSettings(prev => ({
                                    ...prev,
                                    config_metadata: { ...prev.config_metadata, business_type: e.target.value }
                                }))}
                                placeholder="例: イタリアンレストラン、美容室"
                            />
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-zinc-700 block">AIの話し方</label>
                            <div className="relative">
                                <select
                                    className="w-full text-base px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all appearance-none"
                                    value={currentSettings?.config_metadata?.tone || 'polite'}
                                    onChange={(e) => setCurrentSettings(prev => ({
                                        ...prev,
                                        config_metadata: { ...prev.config_metadata, tone: e.target.value as any }
                                    }))}
                                >
                                    <option value="polite">丁寧（標準）</option>
                                    <option value="friendly">親しみやすく</option>
                                    <option value="casual">カジュアル</option>
                                </select>
                                <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-zinc-400">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* 2. Prompt Settings Card */}
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-zinc-100/80">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
                            <MessageSquare className="h-5 w-5" />
                        </div>
                        <h3 className="font-semibold text-zinc-800 text-lg">AIの振る舞い</h3>
                    </div>

                    <div className="space-y-6">
                        <div className="space-y-2">
                            <label className="text-sm font-medium text-zinc-700 block flex items-center justify-between">
                                第一声 (電話に出た時の挨拶)
                                <span className="text-xs font-normal text-zinc-400 px-2 py-0.5 bg-zinc-100 rounded">必須</span>
                            </label>
                            <input
                                type="text"
                                className="w-full text-base px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-zinc-400"
                                value={currentSettings?.config_metadata?.greeting_message || ''}
                                onChange={(e) => setCurrentSettings(prev => ({
                                    ...prev,
                                    config_metadata: { ...prev.config_metadata, greeting_message: e.target.value }
                                }))}
                                placeholder="お電話ありがとうございます。居酒屋AiLunaでございます。ご予約のお電話でしょうか？"
                            />
                            <p className="text-xs text-zinc-500 pl-1">
                                店名を含めるとお客様が安心します。
                            </p>
                        </div>

                        <div className="space-y-3">
                            <div className="flex justify-between items-end">
                                <label className="text-sm font-medium text-zinc-700 block">
                                    店舗情報・よくある質問 (システムプロンプト)
                                </label>
                            </div>

                            <div className="relative group">
                                <textarea
                                    className="w-full text-sm font-mono leading-relaxed px-4 py-4 bg-zinc-50 border border-zinc-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all min-h-[300px] resize-y"
                                    value={currentSettings?.system_prompt || ''}
                                    onChange={(e) => setCurrentSettings(prev => ({ ...prev, system_prompt: e.target.value }))}
                                    placeholder={`店舗の営業時間、アクセス、メニュー情報、よくある質問への回答などを自由に記述してください...

例:
- 駐車場: あり（3台）
- 予算: 3000円〜
- カード利用: 可`}
                                />
                                <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <div className="bg-white/90 backdrop-blur text-xs px-2 py-1 rounded shadow-sm border border-zinc-100 text-zinc-500 pointer-events-none">
                                        Markdown記法対応
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100/50">
                                <Info className="h-5 w-5 text-indigo-400 shrink-0 mt-0.5" />
                                <div className="text-xs text-indigo-900 leading-relaxed">
                                    <strong>ここに入力された情報は、AIがお客様への回答に使用します。</strong><br />
                                    営業時間、定休日、アクセス、メニュー、駐車場情報などを箇条書きで詳しく書くと、より賢い対応が可能になります。
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* 3. SMS Settings Card */}
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-zinc-100/80">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 bg-green-50 text-green-600 rounded-lg">
                            <Smartphone className="h-5 w-5" />
                        </div>
                        <h3 className="font-semibold text-zinc-800 text-lg">SMS通知メッセージ</h3>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Approved Template */}
                        <div className="space-y-3">
                            <label className="text-sm font-medium text-zinc-700 flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-green-500"></div>
                                予約確定時のメッセージ
                            </label>
                            <div className="relative">
                                <textarea
                                    className="w-full text-sm px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl focus:ring-2 focus:ring-green-500/20 focus:border-green-500 transition-all min-h-[120px]"
                                    value={currentSettings?.config_metadata?.sms_templates?.approved || ''}
                                    onChange={(e) => setCurrentSettings(prev => ({
                                        ...prev,
                                        config_metadata: {
                                            ...prev.config_metadata,
                                            sms_templates: {
                                                ...prev.config_metadata.sms_templates,
                                                approved: e.target.value,
                                                rejected: prev.config_metadata.sms_templates?.rejected || ''
                                            }
                                        }
                                    }))}
                                    placeholder="ご予約を承りました。{{dateTime}}{{partySize}}"
                                />
                                <Quote className="absolute bottom-3 right-3 h-4 w-4 text-zinc-300 pointer-events-none" />
                            </div>
                        </div>

                        {/* Rejected Template */}
                        <div className="space-y-3">
                            <label className="text-sm font-medium text-zinc-700 flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-red-400"></div>
                                お断り時のメッセージ
                            </label>
                            <div className="relative">
                                <textarea
                                    className="w-full text-sm px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition-all min-h-[120px]"
                                    value={currentSettings?.config_metadata?.sms_templates?.rejected || ''}
                                    onChange={(e) => setCurrentSettings(prev => ({
                                        ...prev,
                                        config_metadata: {
                                            ...prev.config_metadata,
                                            sms_templates: {
                                                approved: prev.config_metadata.sms_templates?.approved || '',
                                                rejected: e.target.value
                                            }
                                        }
                                    }))}
                                    placeholder="申し訳ありません。ご希望の日時はお受けできませんでした。"
                                />
                                <Quote className="absolute bottom-3 right-3 h-4 w-4 text-zinc-300 pointer-events-none" />
                            </div>
                        </div>
                    </div>

                    <div className="mt-6">
                        <button
                            onClick={() => setShowSmsHelp(!showSmsHelp)}
                            className="text-xs text-zinc-500 hover:text-zinc-800 flex items-center gap-1.5 transition-colors font-medium border border-dashed border-zinc-300 rounded-lg px-3 py-1.5 hover:bg-zinc-50 hover:border-zinc-400 w-max"
                        >
                            <Info className="h-3.5 w-3.5" />
                            {showSmsHelp ? '変数の説明を隠す' : 'メッセージ内で使える変数を見る'}
                        </button>

                        {showSmsHelp && (
                            <div className="mt-3 bg-zinc-50 rounded-xl p-4 text-xs border border-zinc-100 animate-in fade-in slide-in-from-top-1">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="space-y-1">
                                        <div className="font-mono text-blue-600 font-bold bg-blue-50 w-max px-1.5 rounded">{`{{dateTime}}`}</div>
                                        <div className="text-zinc-600">予約日時<br /><span className="text-zinc-400">例：12月24日 19:00</span></div>
                                    </div>
                                    <div className="space-y-1">
                                        <div className="font-mono text-blue-600 font-bold bg-blue-50 w-max px-1.5 rounded">{`{{partySize}}`}</div>
                                        <div className="text-zinc-600">人数<br /><span className="text-zinc-400">例：4名様</span></div>
                                    </div>
                                    <div className="space-y-1">
                                        <div className="font-mono text-red-500 font-bold bg-red-50 w-max px-1.5 rounded">{`{{reason}}`}</div>
                                        <div className="text-zinc-600">お断り理由<br /><span className="text-zinc-400">却下時のみ有効</span></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

            </div>
        </div>
    )
}

---
---
File: web/src/app/dashboard/DashboardClient.tsx
'use client'

import { useState } from 'react'
import {
    LayoutDashboard,
    User,
    CreditCard,
    Settings,
    Phone,
    Menu,
    X,
    LogOut,
    Calendar
} from 'lucide-react'
import { UserProfileChip } from '@/components/UserProfileChip'
import { DashboardSection } from './sections/DashboardSection'
import { AccountSection } from './sections/AccountSection'
import { PlanSection } from './sections/PlanSection'
import { AgentSettingsSection } from './sections/AgentSettingsSection'
import { CallHistorySection } from './sections/CallHistorySection'
import { ReservationSection } from './sections/ReservationSection'
import { DashboardMetricsData } from '@/components/DashboardMetrics'

type Tab = 'dashboard' | 'account' | 'plan' | 'agent' | 'history' | 'reservations'

import { AgentSettings } from '@/types/agent'

// ... existing imports

interface DashboardClientProps {
    userEmail: string
    userProfile: any
    metrics: DashboardMetricsData
    prompts: AgentSettings
    initialLogs: any[]
    initialCount: number
    uniqueCallers: string[]
    signOutAction: () => Promise<void>
}

export function DashboardClient({
    userEmail,
    userProfile,
    metrics,
    prompts,
    initialLogs,
    initialCount,
    uniqueCallers,
    signOutAction
}: DashboardClientProps) {
    const [activeTab, setActiveTab] = useState<Tab>('dashboard')
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)

    const menuItems = [
        { id: 'dashboard', label: 'ダッシュボード', icon: LayoutDashboard },
        { id: 'reservations', label: '予約管理', icon: Calendar },
        { id: 'history', label: '通話履歴', icon: Phone },
        { id: 'agent', label: 'AIエージェント設定', icon: Settings },
        { id: 'account', label: 'アカウント管理', icon: User },
        { id: 'plan', label: 'プラン・決済', icon: CreditCard },
    ] as const

    const renderContent = () => {
        switch (activeTab) {
            case 'dashboard':
                return <DashboardSection
                    metrics={metrics}
                    onNavigate={setActiveTab}
                    agentSettings={prompts}
                    recentLogs={initialLogs}
                    userProfile={userProfile}
                />
            case 'account':
                return <AccountSection />
            case 'plan':
                return <PlanSection />
            case 'agent':
                return (
                    <AgentSettingsSection
                        settings={prompts}
                    />
                )
            case 'history':
                return (
                    <CallHistorySection
                        initialLogs={initialLogs}
                        initialCount={initialCount}
                        uniqueCallers={uniqueCallers}
                    />
                )
            case 'reservations':
                return <ReservationSection />
            default:
                return null
        }
    }
    // ... rest of the file

    const SidebarContent = () => (
        <div className="flex flex-col h-full bg-white">
            <div className="p-6 border-b border-zinc-100">
                <div className="flex items-center gap-2 text-indigo-600 px-2">
                    <Phone className="h-6 w-6" />
                    <span className="text-xl font-bold text-zinc-900">AiLuna</span>
                </div>
            </div>

            <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                {menuItems.map((item) => {
                    const Icon = item.icon
                    const isActive = activeTab === item.id
                    return (
                        <button
                            key={item.id}
                            onClick={() => {
                                setActiveTab(item.id)
                                setIsMobileMenuOpen(false)
                            }}
                            className={`group w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 ${isActive
                                ? 'text-indigo-600 bg-indigo-50 shadow-sm ring-1 ring-indigo-100'
                                : 'text-zinc-500 hover:bg-zinc-50 hover:text-zinc-900'
                                }`}
                        >
                            <Icon className={`h-5 w-5 transition-colors ${isActive ? 'text-indigo-600' : 'text-zinc-400 group-hover:text-zinc-600'}`} />
                            {item.label}
                        </button>
                    )
                })}
            </nav>

            <div className="p-4 border-t border-zinc-100">
                <div className="flex items-center gap-3 px-4 py-3 mb-2">
                    <div className="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 ring-1 ring-indigo-100">
                        <User className="h-4 w-4" />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-zinc-900 truncate">
                            {userEmail}
                        </p>
                    </div>
                </div>
                <form action={signOutAction}>
                    <button className="w-full flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-zinc-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all active:scale-95">
                        <LogOut className="h-4 w-4" />
                        ログアウト
                    </button>
                </form>
            </div>
        </div>
    )

    return (
        <div className="min-h-screen bg-zinc-50/50 flex">
            {/* Desktop Sidebar */}
            <aside className="hidden md:flex w-72 bg-white border-r border-zinc-100 shadow-[4px_0_24px_-12px_rgba(0,0,0,0.1)] flex-col fixed inset-y-0 z-20">
                <SidebarContent />
            </aside>

            {/* Mobile Header */}
            <div className="md:hidden fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-md border-b border-zinc-200 z-20 px-4 py-2 flex items-center justify-between gap-2">
                <div className="flex items-center gap-2 text-indigo-600 shrink-0">
                    <Phone className="h-6 w-6" />
                    <span className="text-xl font-bold text-zinc-900 hidden sm:inline">AiLuna</span>
                </div>

                <div className="flex-1 flex justify-end mr-2">
                    <UserProfileChip
                        accountName={userProfile?.account_name}
                        phoneNumber={userProfile?.phone_number}
                        className="scale-90 origin-right"
                    />
                </div>

                <button
                    onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                    className="p-2 text-zinc-600 hover:bg-zinc-50 rounded-lg active:scale-95 transition-transform shrink-0"
                >
                    {isMobileMenuOpen ? (
                        <X className="h-6 w-6" />
                    ) : (
                        <Menu className="h-6 w-6" />
                    )}
                </button>
            </div>

            {/* Mobile Drawer Overlay */}
            {isMobileMenuOpen && (
                <div
                    className="md:hidden fixed inset-0 bg-zinc-900/20 backdrop-blur-sm z-30"
                    onClick={() => setIsMobileMenuOpen(false)}
                />
            )}

            {/* Mobile Drawer */}
            <div className={`md:hidden fixed inset-y-0 right-0 w-72 bg-white shadow-2xl z-40 transform transition-transform duration-300 ease-out ${isMobileMenuOpen ? 'translate-x-0' : 'translate-x-full'
                }`}>
                <SidebarContent />
            </div>

            {/* Main Content */}
            <main className="flex-1 md:pl-72 pt-[60px] md:pt-0 transition-all duration-300">
                {/* Top Header */}
                <header className="hidden md:flex sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-zinc-200/60 px-6 py-3 items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="hidden md:flex items-center gap-2 text-zinc-500">
                            <LayoutDashboard className="h-4 w-4" />
                            <span className="text-sm font-medium">マイページ</span>
                        </div>
                    </div>

                    <div className="flex items-center gap-4">
                        <UserProfileChip
                            accountName={userProfile?.account_name}
                            phoneNumber={userProfile?.phone_number}
                            className="pl-4 border-l border-zinc-200"
                        />
                    </div>
                </header>

                <div className="max-w-6xl mx-auto p-6 lg:p-10 space-y-8 pt-6 md:pt-10">
                    {renderContent()}
                </div>
            </main>
        </div>
    )
}

---
---
File: web/src/app/dashboard/demo-call/page.tsx
'use client'

import { useEffect, useState, useCallback, useRef } from 'react'
import { useRouter } from 'next/navigation'
import { Mic, MicOff, PhoneOff, Loader2, ArrowLeft, Calendar, Phone } from 'lucide-react'
import { WebCallClient, ConnectionStatus } from '@/lib/webCall/webCallClient'

interface TranscriptItem {
    id: number
    text: string
    isFinal: boolean
    speaker: 'user' | 'ai'
}

export default function DemoCallPage() {
    const router = useRouter()
    const [status, setStatus] = useState<ConnectionStatus>('idle')
    const [isMuted, setIsMuted] = useState(false)
    const [transcripts, setTranscripts] = useState<TranscriptItem[]>([])
    const [error, setError] = useState<string | null>(null)
    const [isLoading, setIsLoading] = useState(true)
    const [callEnded, setCallEnded] = useState(false)

    const clientRef = useRef<WebCallClient | null>(null)
    const transcriptIdRef = useRef(0)
    const transcriptContainerRef = useRef<HTMLDivElement>(null)
    const [hasStarted, setHasStarted] = useState(false)

    const handleStatusChange = useCallback((newStatus: ConnectionStatus) => {
        setStatus(newStatus)
    }, [])

    const handleTranscript = useCallback((text: string, isFinal: boolean, speaker: 'user' | 'ai') => {
        setTranscripts(prev => {
            const newItem: TranscriptItem = {
                id: transcriptIdRef.current++,
                text,
                isFinal,
                speaker
            }
            return [...prev, newItem].slice(-50)
        })
    }, [])

    const handleError = useCallback((errorMessage: string) => {
        setError(errorMessage)
    }, [])

    const handleCallEnded = useCallback(() => {
        setCallEnded(true)
    }, [])

    // Start call function - must be called from user gesture for iOS compatibility
    // CRITICAL: getUserMedia must be called FIRST, before any async operations
    const startCall = useCallback(async () => {
        setHasStarted(true)
        setIsLoading(true)
        setError(null)
        setTranscripts([])

        let stream: MediaStream | null = null

        try {
            // Step 1: Request microphone FIRST - this MUST be in the synchronous part of the click handler
            // On iOS, any await before this will break the user gesture context
            console.log('[DemoCall] Requesting microphone access...')
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                })
                console.log('[DemoCall] Microphone access granted')
            } catch (micError) {
                console.error('[DemoCall] Microphone error:', micError)
                if (micError instanceof DOMException) {
                    if (micError.name === 'NotAllowedError') {
                        throw new Error('マイクへのアクセスが拒否されました。設定からマイクを許可してください。')
                    } else if (micError.name === 'NotFoundError') {
                        throw new Error('マイクが見つかりません。マイクが接続されているか確認してください。')
                    } else if (micError.name === 'NotSupportedError') {
                        throw new Error('このブラウザはマイクに対応していません。')
                    } else {
                        throw new Error(`マイクエラー: ${micError.name} - ${micError.message}`)
                    }
                }
                throw new Error('マイクへのアクセスに失敗しました')
            }

            // Step 2: Fetch token (after microphone is acquired)
            console.log('[DemoCall] Fetching token...')
            const response = await fetch('/api/demo-call/token')
            if (!response.ok) {
                const data = await response.json().catch(() => ({}))
                console.error('[DemoCall] Token fetch failed:', response.status, data)
                throw new Error(data.error || `トークンの取得に失敗しました (${response.status})`)
            }

            const { token, wsUrl, userId } = await response.json()
            console.log('[DemoCall] Token received, connecting...')

            // Step 3: Create client and start with the already-acquired stream
            clientRef.current = new WebCallClient({
                onStatusChange: handleStatusChange,
                onTranscript: handleTranscript,
                onError: handleError,
                onCallEnded: handleCallEnded
            })

            await clientRef.current.startWithStream(stream, wsUrl, token, userId)
            console.log('[DemoCall] Call started successfully')

        } catch (err) {
            console.error('[DemoCall] Failed to start call:', err)
            setError(err instanceof Error ? err.message : '通話の開始に失敗しました')
            setStatus('error')

            // Clean up stream if we acquired it but failed later
            if (stream) {
                stream.getTracks().forEach(track => track.stop())
            }
        } finally {
            setIsLoading(false)
        }
    }, [handleStatusChange, handleTranscript, handleError, handleCallEnded])

    // Cleanup on unmount
    useEffect(() => {
        return () => {
            if (clientRef.current) {
                clientRef.current.stop()
                clientRef.current = null
            }
        }
    }, [])

    // Auto-scroll transcript
    useEffect(() => {
        if (transcriptContainerRef.current) {
            transcriptContainerRef.current.scrollTop = transcriptContainerRef.current.scrollHeight
        }
    }, [transcripts])

    const handleMuteToggle = () => {
        if (clientRef.current) {
            const newMuteState = clientRef.current.toggleMute()
            setIsMuted(newMuteState)
        }
    }

    const handleEndCall = () => {
        if (clientRef.current) {
            clientRef.current.stop()
        }
        setCallEnded(true)
    }

    const getStatusDisplay = () => {
        switch (status) {
            case 'connecting':
                return { text: '接続中...', color: 'text-yellow-500', bg: 'bg-yellow-500/20' }
            case 'connected':
                return { text: '通話中', color: 'text-green-500', bg: 'bg-green-500/20' }
            case 'disconnected':
                return { text: '終了', color: 'text-zinc-500', bg: 'bg-zinc-500/20' }
            case 'error':
                return { text: 'エラー', color: 'text-red-500', bg: 'bg-red-500/20' }
            default:
                return { text: '待機中', color: 'text-zinc-400', bg: 'bg-zinc-400/20' }
        }
    }

    const statusInfo = getStatusDisplay()

    return (
        <div className="min-h-screen bg-zinc-900 flex flex-col">
            {/* Header */}
            <header className="px-6 py-4 border-b border-zinc-800 bg-zinc-900/80 backdrop-blur-sm">
                <div className="max-w-2xl mx-auto flex items-center justify-between">
                    <button
                        onClick={() => router.push('/dashboard')}
                        className="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors"
                    >
                        <ArrowLeft className="h-5 w-5" />
                        <span className="text-sm font-medium">ダッシュボードへ戻る</span>
                    </button>

                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full ${statusInfo.bg}`}>
                        {status === 'connecting' && (
                            <Loader2 className={`h-3 w-3 animate-spin ${statusInfo.color}`} />
                        )}
                        {status === 'connected' && (
                            <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse" />
                        )}
                        <span className={`text-xs font-medium ${statusInfo.color}`}>
                            {statusInfo.text}
                        </span>
                    </div>
                </div>
            </header>

            {/* Main Content */}
            <main className="flex-1 flex flex-col max-w-2xl mx-auto w-full p-6">
                <div className="text-center mb-6">
                    <h1 className="text-2xl font-bold text-white mb-2">体験通話</h1>
                    <p className="text-zinc-400 text-sm">
                        AIコンシェルジュと会話してみましょう
                    </p>
                </div>

                {/* Error message */}
                {error && (
                    <div className="mb-4 p-4 bg-red-500/10 border border-red-500/20 rounded-xl">
                        <p className="text-sm text-red-400">{error}</p>
                    </div>
                )}

                {/* Transcript area */}
                <div
                    ref={transcriptContainerRef}
                    className="flex-1 min-h-[300px] max-h-[500px] p-4 bg-zinc-800/50 rounded-2xl overflow-y-auto 
                               border border-zinc-700/50"
                >
                    {transcripts.length === 0 ? (
                        <div className="h-full flex items-center justify-center text-zinc-500 text-sm">
                            {!hasStarted ? (
                                <div className="flex flex-col items-center gap-4">
                                    <Mic className="h-12 w-12 text-zinc-600" />
                                    <span>下のボタンをタップして通話を開始</span>
                                </div>
                            ) : isLoading ? (
                                <div className="flex items-center gap-2">
                                    <Loader2 className="h-4 w-4 animate-spin" />
                                    <span>接続しています...</span>
                                </div>
                            ) : status === 'connected' ? (
                                <span>話しかけてみてください...</span>
                            ) : callEnded ? (
                                <span>通話が終了しました</span>
                            ) : (
                                <span>会話履歴がここに表示されます</span>
                            )}
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {transcripts.map((item) => (
                                <div
                                    key={item.id}
                                    className={`p-3 rounded-xl text-sm ${item.speaker === 'ai'
                                        ? 'bg-indigo-500/20 text-indigo-100'
                                        : 'bg-zinc-700/50 text-zinc-200'
                                        } ${!item.isFinal ? 'opacity-70' : ''}`}
                                >
                                    <p>{item.text}</p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Controls or Post-call navigation */}
                {!callEnded ? (
                    <div className="mt-6 flex items-center justify-center gap-6">
                        {!hasStarted ? (
                            /* Start call button - requires user gesture for iOS */
                            <button
                                onClick={startCall}
                                className="flex items-center gap-3 px-8 py-4 bg-green-600 hover:bg-green-700 
                                           text-white rounded-full font-medium text-lg
                                           shadow-lg shadow-green-500/30 hover:shadow-green-500/50
                                           transition-all duration-200 transform hover:scale-105 active:scale-95"
                            >
                                <Mic className="h-6 w-6" />
                                <span>マイクを許可して開始</span>
                            </button>
                        ) : (
                            <>
                                {/* Mute button */}
                                <button
                                    onClick={handleMuteToggle}
                                    disabled={status !== 'connected'}
                                    className={`p-4 rounded-full transition-all duration-200 
                                               ${isMuted
                                            ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30'
                                            : 'bg-zinc-700/50 text-white hover:bg-zinc-700'
                                        } disabled:opacity-50 disabled:cursor-not-allowed`}
                                >
                                    {isMuted ? (
                                        <MicOff className="h-6 w-6" />
                                    ) : (
                                        <Mic className="h-6 w-6" />
                                    )}
                                </button>

                                {/* End call button */}
                                <button
                                    onClick={handleEndCall}
                                    className="p-5 bg-red-500 hover:bg-red-600 text-white rounded-full 
                                               shadow-lg shadow-red-500/30 hover:shadow-red-500/50
                                               transition-all duration-200 transform hover:scale-105 active:scale-95"
                                >
                                    <PhoneOff className="h-7 w-7" />
                                </button>
                            </>
                        )}
                    </div>
                ) : (
                    <div className="mt-6 space-y-4">
                        <p className="text-center text-zinc-400 text-sm mb-4">
                            通話が終了しました
                        </p>
                        <div className="flex flex-col sm:flex-row gap-3">
                            <button
                                onClick={() => router.push('/dashboard?tab=reservations')}
                                className="flex-1 flex items-center justify-center gap-2 px-4 py-3 
                                           bg-indigo-600 hover:bg-indigo-700 text-white 
                                           rounded-xl font-medium transition-colors"
                            >
                                <Calendar className="h-5 w-5" />
                                予約管理へ
                            </button>
                            <button
                                onClick={() => router.push('/dashboard?tab=history')}
                                className="flex-1 flex items-center justify-center gap-2 px-4 py-3 
                                           bg-zinc-700 hover:bg-zinc-600 text-white 
                                           rounded-xl font-medium transition-colors"
                            >
                                <Phone className="h-5 w-5" />
                                通話ログへ
                            </button>
                        </div>
                    </div>
                )}

                {/* Hint text */}
                <div className="mt-6 text-center">
                    <p className="text-xs text-zinc-500">
                        これは体験版です。実際の電話回線は使用しません（PSTN発信ゼロ）
                    </p>
                    {isMuted && status === 'connected' && (
                        <p className="text-xs text-red-400 mt-2">
                            マイクがミュートされています
                        </p>
                    )}
                </div>
            </main>
        </div>
    )
}

---
---
File: web/src/app/dashboard/page.tsx
import { createClient } from '@/utils/supabase/server'
import { redirect } from 'next/navigation'
import { signOut, fetchCallLogsPaginated, fetchUniqueCallerNumbers, fetchUserProfile, fetchCallMetrics } from './actions'
import { DashboardClient } from './DashboardClient'


import { AgentSettings } from '@/types/agent'

// ... existing imports

export default async function DashboardPage() {
    const supabase = await createClient()

    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
        redirect('/login')
    }

    const { data: promptsData } = await supabase
        .from('user_prompts')
        .select('*')
        .eq('user_id', user.id)
        .single()

    // Cast to AgentSettings for now, assuming DB schema migration will happen later
    const prompts = (promptsData || { system_prompt: '', config_metadata: {} }) as unknown as AgentSettings

    const { logs: initialLogs, count: initialCount } = await fetchCallLogsPaginated(0, 10)
    const uniqueCallers = await fetchUniqueCallerNumbers()
    const userProfile = await fetchUserProfile()
    const metrics = await fetchCallMetrics()
    const metricsWithBilling = {
        ...metrics,
        currentMonthBilling: 0
    }

    return (
        <DashboardClient
            userEmail={user.email || ''}
            userProfile={userProfile}
            metrics={metricsWithBilling}
            prompts={prompts}
            initialLogs={initialLogs || []}
            initialCount={initialCount || 0}
            uniqueCallers={uniqueCallers}
            signOutAction={signOut}
        />
    )
}

---
---
File: web/src/app/dashboard/sections/AccountSection.tsx
'use client'

export function AccountSection() {
    return (
        <div className="space-y-6">
            <div>
                <h2 className="text-2xl font-bold text-zinc-900">アカウント管理</h2>
                <p className="text-zinc-500">アカウント情報の確認・変更ができます。</p>
            </div>

            <div className="bg-white p-8 rounded-2xl border border-zinc-100 shadow-sm">
                <div className="space-y-4">
                    <div className="p-6 bg-zinc-50 rounded-xl border border-zinc-100 text-center text-zinc-500">
                        <p>アカウント編集機能は現在開発中です。</p>
                    </div>
                </div>
            </div>
        </div>
    )
}

---
---
File: web/src/app/dashboard/sections/AgentSettingsSection.tsx
'use client'

import { ConciergeBuilder } from '../ConciergeBuilder'
import { AgentSettings } from '@/types/agent'

interface AgentSettingsSectionProps {
    settings: AgentSettings
}

export function AgentSettingsSection({ settings }: AgentSettingsSectionProps) {
    return (
        <div className="space-y-6 h-full flex flex-col">
            <div>
                <h2 className="text-2xl font-bold text-zinc-900">AIエージェント設定</h2>
                <p className="text-zinc-500">お店の情報やAIの振る舞いを設定できます。</p>
            </div>

            <div className="flex-1">
                <ConciergeBuilder initialSettings={settings} />
            </div>
        </div>
    )
}

---
---
File: web/src/app/dashboard/sections/CallHistorySection.tsx
'use client'

import { CallLogList } from '@/components/CallLogList'

interface CallHistorySectionProps {
    initialLogs: any[]
    initialCount: number
    uniqueCallers: string[]
}

export function CallHistorySection({ initialLogs, initialCount, uniqueCallers }: CallHistorySectionProps) {
    return (
        <div className="space-y-6">
            <div>
                <h2 className="text-2xl font-bold text-zinc-900">通話履歴</h2>
                <p className="text-zinc-500">過去の着信履歴と通話内容を確認できます。</p>
            </div>

            <div className="bg-white rounded-2xl border border-zinc-100 shadow-sm overflow-hidden">
                <CallLogList
                    initialLogs={initialLogs}
                    initialCount={initialCount}
                    uniqueCallers={uniqueCallers}
                />
            </div>
        </div>
    )
}

---
---
File: web/src/app/dashboard/sections/DashboardSection.tsx
'use client'

import { DashboardMetricsView, DashboardMetricsData } from '@/components/DashboardMetrics'
import { AgentSettings } from '@/types/agent'
import { Settings, Phone, ChevronRight, Clock } from 'lucide-react'
import { DemoCallButton } from '@/components/DemoCallButton'
import { useRouter } from 'next/navigation'

interface DashboardSectionProps {
    metrics: DashboardMetricsData
    onNavigate: (tab: 'agent' | 'history') => void
    agentSettings: AgentSettings
    recentLogs: any[]
    userProfile?: {
        phone_number?: string | null
        account_name?: string | null
    } | null
}

export function DashboardSection({ metrics, onNavigate, agentSettings, recentLogs, userProfile }: DashboardSectionProps) {
    const router = useRouter()
    const latestLog = recentLogs.length > 0 ? recentLogs[0] : null

    // Demo user detection: no phone number assigned
    const isDemoUser = !userProfile?.phone_number

    // 日付フォーマット用ヘルパー
    const formatDate = (dateString: string) => {
        const date = new Date(dateString)
        return date.toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })
    }

    return (
        <div className="space-y-8">
            {/* Demo call button - always visible */}
            <div className="p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl border border-indigo-100">
                <div className="max-w-md mx-auto space-y-4">
                    <div className="text-center">
                        <h2 className="text-lg font-bold text-zinc-900">AIコンシェルジュを体験</h2>
                        <p className="text-sm text-zinc-600 mt-1">
                            ブラウザから直接AIと会話できます
                        </p>
                    </div>
                    <DemoCallButton onClick={() => router.push('/dashboard/demo-call')} />
                </div>
            </div>

            <DashboardMetricsView metrics={metrics} />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* AIエージェント設定カード */}
                <button
                    onClick={() => onNavigate('agent')}
                    className="flex flex-col h-full p-6 bg-white rounded-2xl border border-zinc-100 shadow-sm hover:border-indigo-300 hover:shadow-md hover:bg-indigo-50/30 transition-all text-left group relative overflow-hidden"
                >
                    <div className="flex items-center justify-between w-full mb-4">
                        <div className="flex items-center gap-3">
                            <div className="p-2.5 bg-indigo-100 text-indigo-600 rounded-xl group-hover:scale-110 transition-transform">
                                <Settings className="h-5 w-5" />
                            </div>
                            <h3 className="font-bold text-zinc-900">AIエージェント設定</h3>
                        </div>
                        <ChevronRight className="h-5 w-5 text-zinc-300 group-hover:text-indigo-400 transition-colors" />
                    </div>

                    <div className="w-full space-y-3">
                        <div>
                            <div className="text-[10px] font-bold text-zinc-400 uppercase tracking-wider mb-1">現在の挨拶</div>
                            <div className="text-sm text-zinc-700 bg-zinc-50 p-3 rounded-lg border border-zinc-100 font-medium line-clamp-2 group-hover:bg-white transition-colors">
                                {agentSettings.config_metadata?.greeting_message || '（未設定）'}
                            </div>
                        </div>
                        <div className="flex items-center gap-3 text-xs text-zinc-500">
                            <span className="px-2 py-0.5 rounded-full bg-zinc-100 border border-zinc-200">
                                {agentSettings.config_metadata?.tone === 'polite' ? '丁寧' :
                                    agentSettings.config_metadata?.tone === 'friendly' ? 'フレンドリー' :
                                        agentSettings.config_metadata?.tone === 'casual' ? 'カジュアル' : '標準'}
                            </span>
                            <span>文字数: {agentSettings.system_prompt?.length || 0}文字</span>
                        </div>
                    </div>
                </button>

                {/* 通話履歴カード */}
                <button
                    onClick={() => onNavigate('history')}
                    className="flex flex-col h-full p-6 bg-white rounded-2xl border border-zinc-100 shadow-sm hover:border-emerald-300 hover:shadow-md hover:bg-emerald-50/30 transition-all text-left group relative overflow-hidden"
                >
                    <div className="flex items-center justify-between w-full mb-4">
                        <div className="flex items-center gap-3">
                            <div className="p-2.5 bg-emerald-100 text-emerald-600 rounded-xl group-hover:scale-110 transition-transform">
                                <Phone className="h-5 w-5" />
                            </div>
                            <h3 className="font-bold text-zinc-900">通話履歴</h3>
                        </div>
                        <ChevronRight className="h-5 w-5 text-zinc-300 group-hover:text-emerald-400 transition-colors" />
                    </div>

                    {latestLog ? (
                        <div className="w-full space-y-3">
                            <div className="flex items-center justify-between text-xs text-zinc-500">
                                <div className="flex items-center gap-1.5">
                                    <Clock className="h-3.5 w-3.5" />
                                    <span>{formatDate(latestLog.created_at)}</span>
                                </div>
                                <span className="font-mono text-zinc-400">{latestLog.caller_number}</span>
                            </div>
                            <div>
                                <div className="text-[10px] font-bold text-zinc-400 uppercase tracking-wider mb-1">最新の通話メモ</div>
                                <div className="text-sm text-zinc-700 bg-zinc-50 p-3 rounded-lg border border-zinc-100 font-medium line-clamp-2 group-hover:bg-white transition-colors">
                                    {latestLog.summary || '要約なし'}
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col items-center justify-center text-zinc-400 gap-2 py-2">
                            <Phone className="h-8 w-8 opacity-20" />
                            <span className="text-sm">履歴はまだありません</span>
                        </div>
                    )}
                </button>
            </div>
        </div>
    )
}

---
---
File: web/src/app/dashboard/sections/PlanSection.tsx
'use client'

import { useState } from 'react'

export function PlanSection() {
    const [isLoading, setIsLoading] = useState(false)

    const handleUpgrade = async () => {
        try {
            setIsLoading(true)

            // Checkout セッション作成 API を呼び出し
            const response = await fetch('/api/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })

            if (!response.ok) {
                const errorData = await response.json()
                throw new Error(errorData.error || 'Failed to create checkout session')
            }

            const { url } = await response.json()

            if (!url) {
                throw new Error('No checkout URL returned')
            }

            // Stripe Checkout ページにリダイレクト
            window.location.href = url

        } catch (error) {
            console.error('Checkout error:', error)
            alert(error instanceof Error ? error.message : 'アップグレード処理中にエラーが発生しました。もう一度お試しください。')
            setIsLoading(false)
        }
    }

    return (
        <div className="space-y-6">
            <div>
                <h2 className="text-2xl font-bold text-zinc-900">プラン・決済</h2>
                <p className="text-zinc-500">ご利用プランの確認とアップグレードができます。</p>
            </div>

            <div className="bg-white p-8 rounded-2xl border border-zinc-100 shadow-sm space-y-8">
                <div className="flex items-center justify-between p-6 bg-indigo-50/50 rounded-xl border border-indigo-100/50">
                    <div>
                        <h3 className="font-bold text-indigo-900 text-lg">現在のプラン: フリープラン</h3>
                        <p className="text-indigo-700 mt-1">月間60分まで無料でご利用いただけます。</p>
                    </div>
                    <span className="px-4 py-1.5 bg-white text-indigo-600 text-sm font-bold rounded-full border border-indigo-100 shadow-sm">
                        Active
                    </span>
                </div>

                <div className="border-t border-zinc-100 pt-8">
                    <h3 className="font-bold text-zinc-900 text-lg mb-2">プロプランへのアップグレード</h3>
                    <p className="text-zinc-500 mb-6">
                        月額2,980円で通話時間無制限、高度なAI設定などが利用可能になります。
                    </p>
                    <button
                        onClick={handleUpgrade}
                        disabled={isLoading}
                        className="w-full py-3 px-4 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors disabled:bg-zinc-300 disabled:cursor-not-allowed disabled:text-zinc-500"
                    >
                        {isLoading ? '処理中...' : 'アップグレード'}
                    </button>
                </div>
            </div>
        </div>
    )
}

---
---
File: web/src/app/dashboard/sections/ReservationSection.tsx
'use client'

import { useState, useEffect } from 'react'
import { Calendar, Filter, ChevronLeft, ChevronRight, Loader2, X, Check, ArrowLeft, Settings, Mail, Plus, Trash2, List, GripVertical, ArrowUp, ArrowDown, Copy } from 'lucide-react'
import {
    fetchReservationRequestsPaginated,
    ReservationStatus,
    approveReservationRequest,
    rejectReservationRequest,
    getStoreNotificationSettings,
    upsertStoreNotificationSettings,
    StoreNotificationSettings,
    listReservationFields,
    createReservationField,
    updateReservationField,
    deleteReservationField,
    reorderReservationFields,
    initializeDefaultFields,
    ReservationField,
    ReservationFieldType,
    createLineLinkToken,
    getActiveLineLinkToken
} from '../actions'

interface ReservationSectionProps {
    // Props can be expanded later if needed
}

type SubTab = 'requests' | 'settings' | 'form'

export function ReservationSection({ }: ReservationSectionProps) {
    const [activeTab, setActiveTab] = useState<SubTab>('requests')

    // --- Request List State ---
    const [requests, setRequests] = useState<any[]>([])
    const [count, setCount] = useState(0)
    const [isLoading, setIsLoading] = useState(true)
    const [page, setPage] = useState(1)
    const [statusFilter, setStatusFilter] = useState<ReservationStatus | 'all'>('all')
    const [selectedRequest, setSelectedRequest] = useState<any | null>(null)
    const [isActionLoading, setIsActionLoading] = useState(false)

    // For rejection dialog
    const [rejectReason, setRejectReason] = useState('')
    const [internalNote, setInternalNote] = useState('')
    const [customerMessage, setCustomerMessage] = useState('')
    const [showRejectForm, setShowRejectForm] = useState(false)

    // --- Notification Settings State ---
    const [notificationSettings, setNotificationSettings] = useState<StoreNotificationSettings>({
        notify_email_enabled: false,
        notify_emails: [],
        notify_line_enabled: false
    })
    const [isSettingsLoading, setIsSettingsLoading] = useState(false)
    const [isSavingSettings, setIsSavingSettings] = useState(false)
    const [newEmail, setNewEmail] = useState('')
    const [linkToken, setLinkToken] = useState<{ code: string, expires_at: string } | null>(null)
    const [isCopied, setIsCopied] = useState(false)

    // --- Form Fields State ---
    const [formFields, setFormFields] = useState<ReservationField[]>([])
    const [isFieldsLoading, setIsFieldsLoading] = useState(false)
    const [editingFieldId, setEditingFieldId] = useState<string | null>(null)

    // Edit/Create buffer
    const [editBuffer, setEditBuffer] = useState<Partial<ReservationField>>({})
    const [showCreateForm, setShowCreateForm] = useState(false)

    const itemsPerPage = 10
    const totalPages = Math.ceil(count / itemsPerPage)

    // Load Requests
    const loadData = async () => {
        setIsLoading(true)
        try {
            const offset = (page - 1) * itemsPerPage
            const { requests: data, count: total } = await fetchReservationRequestsPaginated(
                offset,
                itemsPerPage,
                { status: statusFilter }
            )
            setRequests(data || [])
            setCount(total || 0)
        } catch (error) {
            console.error('Failed to load reservations:', error)
        } finally {
            setIsLoading(false)
        }
    }

    // Load Settings
    const loadSettings = async () => {
        setIsSettingsLoading(true)
        try {
            const data = await getStoreNotificationSettings()
            if (data) {
                setNotificationSettings(data)
            }
        } catch (error) {
            console.error('Failed to load settings:', error)
        } finally {
            setIsSettingsLoading(false)
        }
    }

    // Load Form Fields
    const loadFormFields = async () => {
        setIsFieldsLoading(true)
        try {
            const data = await listReservationFields()
            setFormFields(data)
        } catch (error) {
            console.error('Failed to load form fields:', error)
        } finally {
            setIsFieldsLoading(false)
        }
    }

    useEffect(() => {
        if (activeTab === 'requests') {
            loadData()
            loadFormFields() // Load fields for label mapping in details
        }
        else if (activeTab === 'settings') {
            loadSettings()
            loadLinkToken()
        }
        else if (activeTab === 'form') loadFormFields()
    }, [page, statusFilter, activeTab])

    const loadLinkToken = async () => {
        try {
            const token = await getActiveLineLinkToken()
            if (token) {
                setLinkToken({ code: token.token_code, expires_at: token.expires_at })
            }
        } catch (error) {
            console.error('Failed to load link token:', error)
        }
    }

    const handleIssueLinkToken = async () => {
        setIsActionLoading(true)
        try {
            const res = await createLineLinkToken()
            if (res.error) {
                alert(res.error)
            } else if (res.token_code && res.expires_at) {
                setLinkToken({ code: res.token_code, expires_at: res.expires_at })
            }
        } catch (error) {
            console.error(error)
            alert('発行に失敗しました')
        } finally {
            setIsActionLoading(false)
        }
    }

    const copyLinkCode = () => {
        if (!linkToken) return
        navigator.clipboard.writeText(linkToken.code)
        setIsCopied(true)
        setTimeout(() => setIsCopied(false), 2000)
    }

    const formatDate = (dateString: string) => {
        if (!dateString) return '-'
        const date = new Date(dateString)
        return date.toLocaleString('ja-JP', {
            month: 'numeric',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        })
    }

    const formatReservationDateTime = (req: any) => {
        let dateStr = ''
        if (req.requested_date) {
            // date type should be YYYY-MM-DD but could be anything if DB is loose
            const parts = req.requested_date.split('-')
            if (parts.length === 3) {
                dateStr = `${Number(parts[1])}/${Number(parts[2])}`
            } else {
                // If not standard YYYY-MM-DD, try to just show it if it looks reasonable, or ignore
                dateStr = req.requested_date
            }
        }

        let timeStr = ''
        if (req.requested_time) {
            // HH:mm:ss -> HH:mm
            // Check if it really has colons or is just a string
            if (req.requested_time.includes(':')) {
                timeStr = req.requested_time.substring(0, 5)
            } else {
                timeStr = req.requested_time
            }
        }

        if (dateStr && timeStr) return `${dateStr} ${timeStr}`
        if (dateStr) return dateStr
        // Fallback
        return '未指定'
    }

    const getStatusBadge = (status: string) => {
        const styles = {
            pending: 'bg-yellow-100 text-yellow-800 border-yellow-200',
            approved: 'bg-green-100 text-green-800 border-green-200',
            rejected: 'bg-red-100 text-red-800 border-red-200',
            auto_approved: 'bg-blue-100 text-blue-800 border-blue-200',
        }[status] || 'bg-gray-100 text-gray-800 border-gray-200'

        const labels = {
            pending: '確認待ち',
            approved: '承認済み',
            rejected: '却下',
            auto_approved: '自動承認',
        }[status] || status

        return (
            <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${styles}`}>
                {labels}
            </span>
        )
    }

    const normalizeAnswers = (answers: any): Record<string, string> => {
        if (!answers) return {}
        if (!Array.isArray(answers) && typeof answers === 'object') {
            return answers as Record<string, string>
        }
        if (Array.isArray(answers)) {
            const result: Record<string, string> = {}
            answers.forEach(item => {
                if (typeof item === 'object' && item !== null) {
                    const key = item.field_key || item.label || item.question || `field_${Math.random().toString(36).substr(2, 9)}`
                    const value = item.answer || item.value || item.text || item.content || ''
                    result[key] = String(value)
                } else {
                    result[`item_${Math.random()}`] = String(item)
                }
            })
            return result
        }
        return {}
    }

    const getAnswerPreview = (req: any) => {
        if (req.requested_datetime_text) return req.requested_datetime_text

        // Safe handling for answers (object or array)
        if (req.answers) {
            let values: string[] = []

            if (Array.isArray(req.answers)) {
                // If array, just join strings? or objects?
                // If invalid array of objects, might need mapping. 
                // Assuming simple strings or simple objects in array if schema drifted.
                values = req.answers
                    .map((a: any) => (typeof a === 'object' ? JSON.stringify(a) : String(a)))
            } else if (typeof req.answers === 'object') {
                values = Object.values(req.answers)
                    .filter(v => typeof v === 'string' || typeof v === 'number')
                    .map(v => String(v))
            }

            if (values.length > 0) return values.slice(0, 2).join(' / ')
        }
        return ''
    }

    const handleApprove = async () => {
        if (!confirm('この予約を承認しますか？')) return
        setIsActionLoading(true)
        try {
            const res = await approveReservationRequest(selectedRequest.id, internalNote, customerMessage)
            if (res?.error) {
                alert(res.error)
            } else {
                setSelectedRequest(null)
                setCustomerMessage('')
                loadData()
            }
        } catch (err) {
            console.error(err)
            alert('エラーが発生しました')
        } finally {
            setIsActionLoading(false)
        }
    }

    const handleReject = async () => {
        if (!rejectReason.trim()) {
            alert('却下理由を入力してください')
            return
        }
        if (!confirm('この予約を却下しますか？')) return

        setIsActionLoading(true)
        try {
            const res = await rejectReservationRequest(selectedRequest.id, rejectReason, internalNote, customerMessage)
            if (res?.error) {
                alert(res.error)
            } else {
                setShowRejectForm(false)
                setRejectReason('')
                setCustomerMessage('')
                setSelectedRequest(null)
                loadData()
            }
        } catch (err) {
            console.error(err)
            alert('エラーが発生しました')
        } finally {
            setIsActionLoading(false)
        }
    }

    // --- Settings Handlers ---
    const handleAddEmail = () => {
        if (!newEmail || !newEmail.includes('@')) return
        if (notificationSettings.notify_emails.includes(newEmail)) return

        setNotificationSettings(prev => ({
            ...prev,
            notify_emails: [...prev.notify_emails, newEmail]
        }))
        setNewEmail('')
    }

    const handleRemoveEmail = (emailToRemove: string) => {
        setNotificationSettings(prev => ({
            ...prev,
            notify_emails: prev.notify_emails.filter(e => e !== emailToRemove)
        }))
    }

    const handleSaveSettings = async () => {
        setIsSavingSettings(true)
        try {
            const res = await upsertStoreNotificationSettings(notificationSettings)
            if (res?.error) {
                alert(res.error)
            } else {
                alert(res.success)
            }
        } catch (err) {
            console.error(err)
            alert('保存に失敗しました')
        } finally {
            setIsSavingSettings(false)
        }
    }

    // --- Form Field Handlers ---
    const handleInitDefaults = async () => {
        if (!confirm('不足しているデフォルト項目がある場合、追加しますか？')) return
        setIsFieldsLoading(true)
        try {
            const res = await initializeDefaultFields()
            if (res.error) alert(res.error)
            else {
                await loadFormFields()
                alert(res.success)
            }
        } finally {
            setIsFieldsLoading(false)
        }
    }

    const handleCreateField = async () => {
        if (!editBuffer.field_key || !editBuffer.label) {
            alert('キーとラベルは必須です')
            return
        }

        setIsFieldsLoading(true)
        try {
            const res = await createReservationField({
                field_key: editBuffer.field_key!,
                label: editBuffer.label!,
                field_type: (editBuffer.field_type as ReservationFieldType) || 'text',
                required: editBuffer.required || false,
                enabled: editBuffer.enabled !== false, // default true
                options: editBuffer.options || [],
                display_order: formFields.length + 1
            })
            if (res?.error) alert(res.error)
            else {
                setShowCreateForm(false)
                setEditBuffer({})
                loadFormFields()
            }
        } finally {
            setIsFieldsLoading(false)
        }
    }

    const handleStartEdit = (field: ReservationField) => {
        setEditingFieldId(field.id)
        setEditBuffer({ ...field })
    }

    const handleCancelEdit = () => {
        setEditingFieldId(null)
        setEditBuffer({})
    }

    const handleSaveEdit = async () => {
        if (!editingFieldId) return

        setIsFieldsLoading(true)
        try {
            const res = await updateReservationField(editingFieldId, editBuffer)
            if (res?.error) alert(res.error)
            else {
                setEditingFieldId(null)
                setEditBuffer({})
                loadFormFields()
            }
        } finally {
            setIsFieldsLoading(false)
        }
    }

    const handleDeleteField = async (id: string) => {
        if (!confirm('この項目を削除しますか？')) return

        setIsFieldsLoading(true)
        try {
            const res = await deleteReservationField(id)
            if (res?.error) alert(res.error)
            else loadFormFields()
        } finally {
            setIsFieldsLoading(false)
        }
    }

    const handleMoveField = async (index: number, direction: 'up' | 'down') => {
        if (direction === 'up' && index === 0) return
        if (direction === 'down' && index === formFields.length - 1) return

        const newFields = [...formFields]
        // swap
        const targetIndex = direction === 'up' ? index - 1 : index + 1
        const temp = newFields[index]
        newFields[index] = newFields[targetIndex]
        newFields[targetIndex] = temp

        setFormFields(newFields) // optimistic update

        // save order
        const ids = newFields.map(f => f.id)
        await reorderReservationFields(ids)
    }

    const getAnswerLabel = (key: string) => {
        const field = formFields.find(f => f.field_key === key)
        return field ? field.label : key
    }

    return (
        <div className="space-y-6">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h2 className="text-2xl font-bold text-zinc-900">予約管理</h2>
                    <p className="text-zinc-500">
                        {activeTab === 'requests' && 'AIが受け付けた予約リクエストの確認'}
                        {activeTab === 'settings' && 'AIからの通知設定'}
                        {activeTab === 'form' && '予約時にお客様に聞く質問項目の設定'}
                    </p>
                </div>

                {/* Active Tab Switcher */}
                <div className="flex bg-zinc-100 p-1 rounded-xl shrink-0">
                    <button
                        onClick={() => setActiveTab('requests')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'requests'
                            ? 'bg-white text-zinc-900 shadow-sm'
                            : 'text-zinc-500 hover:text-zinc-900'
                            }`}
                    >
                        リクエスト
                    </button>
                    <button
                        onClick={() => setActiveTab('settings')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5 ${activeTab === 'settings'
                            ? 'bg-white text-zinc-900 shadow-sm'
                            : 'text-zinc-500 hover:text-zinc-900'
                            }`}
                    >
                        <Settings className="h-4 w-4" />
                        通知設定
                    </button>
                    <button
                        onClick={() => setActiveTab('form')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-1.5 ${activeTab === 'form'
                            ? 'bg-white text-zinc-900 shadow-sm'
                            : 'text-zinc-500 hover:text-zinc-900'
                            }`}
                    >
                        <List className="h-4 w-4" />
                        フォーム設定
                    </button>
                </div>
            </div>

            {activeTab === 'requests' && (
                // --- Request List & Details View (Existing Code) ---
                <>
                    {selectedRequest ? (
                        // ... Details View ...
                        <div className="space-y-6">
                            <div>
                                <button
                                    onClick={() => {
                                        setSelectedRequest(null)
                                        setShowRejectForm(false)
                                        setRejectReason('')
                                        setInternalNote('')
                                        setCustomerMessage('')
                                    }}
                                    className="flex items-center text-sm text-zinc-500 hover:text-zinc-900 mb-4 transition-colors"
                                >
                                    <ArrowLeft className="h-4 w-4 mr-1" />
                                    一覧に戻る
                                </button>
                                <div className="flex items-center justify-between">
                                    <h2 className="text-2xl font-bold text-zinc-900">予約詳細</h2>
                                    {getStatusBadge(selectedRequest.status)}
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl border border-zinc-100 shadow-sm overflow-hidden p-6 md:p-8 space-y-8">
                                {/* Basic Info Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h3 className="text-sm font-bold text-zinc-400 uppercase tracking-wider mb-4">顧客情報</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs text-zinc-400">お名前</label>
                                                <div className="text-lg font-medium text-zinc-900">
                                                    {selectedRequest.customer_name || '未入力'}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-xs text-zinc-400">電話番号</label>
                                                <div className="text-base font-mono text-zinc-700">
                                                    {selectedRequest.customer_phone || selectedRequest.caller_number || '不明'}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-xs text-zinc-400">SMS送信ステータス</label>
                                                <div className="text-base text-zinc-700">
                                                    {selectedRequest.sms_sent_at ? (
                                                        <span className="text-green-600 font-medium">
                                                            送信済み ({formatDate(selectedRequest.sms_sent_at)})
                                                        </span>
                                                    ) : (
                                                        <span className="text-zinc-400">未送信</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 className="text-sm font-bold text-zinc-400 uppercase tracking-wider mb-4">予約希望内容</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs text-zinc-400">希望日時</label>
                                                <div className="text-lg font-medium text-zinc-900">
                                                    {formatReservationDateTime(selectedRequest)}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-xs text-zinc-400">人数</label>
                                                <div className="text-base text-zinc-700">
                                                    {selectedRequest.party_size ? `${selectedRequest.party_size}名` : '未指定'}
                                                </div>
                                            </div>

                                            {/* Answers Loop */}
                                            {selectedRequest.answers ? (
                                                Object.entries(normalizeAnswers(selectedRequest.answers)).map(([key, value]) => {
                                                    if (!value) return null
                                                    return (
                                                        <div key={key}>
                                                            <label className="text-xs text-zinc-400">{getAnswerLabel(key)}</label>
                                                            <div className="text-base text-zinc-700 whitespace-pre-wrap">
                                                                {String(value)}
                                                            </div>
                                                        </div>
                                                    )
                                                })
                                            ) : (
                                                <div>
                                                    <label className="text-xs text-zinc-400">詳細・メモ</label>
                                                    <div className="text-base text-zinc-700 whitespace-pre-wrap">
                                                        {selectedRequest.content || selectedRequest.memo || '（なし）'}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Action Area for Pending Requests */}
                                {selectedRequest.status === 'pending' && (
                                    <div className="border-t border-zinc-100 pt-8 mt-8">
                                        <h3 className="text-sm font-bold text-zinc-900 mb-4">承認アクション</h3>

                                        <div className="mb-4">
                                            <label className="block text-sm text-zinc-600 mb-1">社内用メモ (任意)</label>
                                            <textarea
                                                className="w-full text-sm border-zinc-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                                rows={2}
                                                placeholder="承認/却下時に記録を残せます"
                                                value={internalNote}
                                                onChange={(e) => setInternalNote(e.target.value)}
                                            />
                                        </div>

                                        <div className="mb-6">
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="block text-sm text-zinc-600">顧客へのメッセージ (任意)</label>
                                                <span className={`text-xs ${customerMessage.length > 200 ? 'text-red-500 font-bold' : 'text-zinc-400'}`}>
                                                    {customerMessage.length} / 200
                                                </span>
                                            </div>
                                            <textarea
                                                className={`w-full text-sm border-zinc-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${customerMessage.length > 200 ? 'border-red-300 focus:border-red-500 focus:ring-red-200' : ''}`}
                                                rows={3}
                                                placeholder="SMS通知に追記されます（例：お待ちしております）"
                                                value={customerMessage}
                                                maxLength={200}
                                                onChange={(e) => setCustomerMessage(e.target.value)}
                                            />
                                        </div>

                                        {!showRejectForm ? (
                                            <div className="flex gap-4">
                                                <button
                                                    onClick={handleApprove}
                                                    disabled={isActionLoading}
                                                    className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold shadow-sm transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2"
                                                >
                                                    {isActionLoading ? <Loader2 className="h-5 w-5 animate-spin" /> : <Check className="h-5 w-5" />}
                                                    承認する
                                                </button>
                                                <button
                                                    onClick={() => setShowRejectForm(true)}
                                                    disabled={isActionLoading}
                                                    className="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 px-6 py-3 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2"
                                                >
                                                    <X className="h-5 w-5" />
                                                    却下する
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="bg-red-50 p-6 rounded-xl border border-red-100 animate-in fade-in slide-in-from-top-2">
                                                <h4 className="font-bold text-red-800 mb-2">却下の理由を入力</h4>
                                                <textarea
                                                    className="w-full mb-4 border-red-200 rounded-lg focus:ring-red-500 focus:border-red-500 text-sm"
                                                    rows={3}
                                                    placeholder="例：あいにく満席のため"
                                                    value={rejectReason}
                                                    onChange={(e) => setRejectReason(e.target.value)}
                                                />
                                                <div className="flex justify-end gap-3">
                                                    <button
                                                        onClick={() => setShowRejectForm(false)}
                                                        className="px-4 py-2 text-sm font-medium text-zinc-600 hover:text-zinc-900"
                                                    >
                                                        キャンセル
                                                    </button>
                                                    <button
                                                        onClick={handleReject}
                                                        disabled={isActionLoading || !rejectReason.trim()}
                                                        className="px-6 py-2 bg-red-600 text-white rounded-lg text-sm font-bold shadow-sm hover:bg-red-700 disabled:opacity-50 transition-all"
                                                    >
                                                        {isActionLoading ? '処理中...' : '却下を確定'}
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        // ... List View ...
                        <div className="space-y-6">
                            <div className="flex items-center justify-end">
                                <div className="flex items-center gap-2">
                                    <Filter className="h-4 w-4 text-zinc-400" />
                                    <select
                                        value={statusFilter}
                                        onChange={(e) => {
                                            setStatusFilter(e.target.value as ReservationStatus | 'all')
                                            setPage(1) // Reset to first page
                                        }}
                                        className="text-sm border-zinc-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    >
                                        <option value="all">すべてのステータス</option>
                                        <option value="pending">確認待ち</option>
                                        <option value="approved">承認済み</option>
                                        <option value="auto_approved">自動承認</option>
                                        <option value="rejected">却下</option>
                                    </select>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl border border-zinc-100 shadow-sm overflow-hidden">
                                {isLoading ? (
                                    <div className="flex items-center justify-center h-64">
                                        <Loader2 className="h-8 w-8 text-indigo-600 animate-spin" />
                                    </div>
                                ) : requests.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-64 text-zinc-400">
                                        <Calendar className="h-10 w-10 mb-2 opacity-20" />
                                        <p>予約リクエストはありません</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="text-xs text-zinc-500 uppercase bg-zinc-50 border-b border-zinc-100">
                                                <tr>
                                                    <th className="px-6 py-3 font-medium">受信日時</th>
                                                    <th className="px-6 py-3 font-medium">ステータス</th>
                                                    <th className="px-6 py-3 font-medium">顧客名 / 電話番号</th>
                                                    <th className="px-6 py-3 font-medium">希望日時 / 内容</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-zinc-100">
                                                {requests.map((req) => (
                                                    <tr
                                                        key={req.id}
                                                        onClick={() => setSelectedRequest(req)}
                                                        className={`hover:bg-zinc-50/80 cursor-pointer transition-colors ${req.status === 'pending' ? 'bg-yellow-50/30' : ''}`}
                                                    >
                                                        <td className="px-6 py-4 whitespace-nowrap text-zinc-500">
                                                            {formatDate(req.created_at)}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            {getStatusBadge(req.status)}
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="font-medium text-zinc-900">
                                                                {req.customer_name || req.customer_phone || (req.caller_number ? req.caller_number : '不明')}
                                                            </div>
                                                            {(req.customer_name && (req.customer_phone || req.caller_number)) && (
                                                                <div className="text-xs text-zinc-400">{req.customer_phone || req.caller_number}</div>
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-4 text-zinc-600">
                                                            <div>{formatReservationDateTime(req)}</div>
                                                            <div className="text-xs text-zinc-400 truncate max-w-[200px]">
                                                                {getAnswerPreview(req)}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {/* Pagination */}
                                {totalPages > 1 && (
                                    <div className="flex items-center justify-between px-6 py-4 border-t border-zinc-100">
                                        <div className="text-sm text-zinc-500">
                                            {count} 件中 {(page - 1) * itemsPerPage + 1} - {Math.min(page * itemsPerPage, count)} 件を表示
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => setPage(p => Math.max(1, p - 1))}
                                                disabled={page === 1}
                                                className="p-1 rounded hover:bg-zinc-100 disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                <ChevronLeft className="h-5 w-5" />
                                            </button>
                                            <span className="text-sm font-medium text-zinc-700">
                                                {page} / {totalPages}
                                            </span>
                                            <button
                                                onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                                                disabled={page === totalPages}
                                                className="p-1 rounded hover:bg-zinc-100 disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                <ChevronRight className="h-5 w-5" />
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </>
            )
            }

            {
                activeTab === 'settings' && (
                    // --- Notification Settings View ---
                    <div className="bg-white rounded-2xl border border-zinc-100 shadow-sm p-6 md:p-8 space-y-8">
                        {isSettingsLoading ? (
                            <div className="flex items-center justify-center h-64">
                                <Loader2 className="h-8 w-8 text-indigo-600 animate-spin" />
                            </div>
                        ) : (
                            <div className="space-y-8 max-w-2xl mx-auto">
                                {/* Email Settings */}
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-lg font-bold text-zinc-900 flex items-center gap-2">
                                            <Mail className="h-5 w-5 text-indigo-600" />
                                            通知メール設定
                                        </h3>
                                        <div className="flex items-center gap-2">
                                            <span className={`text-sm font-medium ${notificationSettings.notify_email_enabled ? 'text-indigo-600' : 'text-zinc-400'}`}>
                                                {notificationSettings.notify_email_enabled ? '有効' : '無効'}
                                            </span>
                                            <button
                                                onClick={() => setNotificationSettings(p => ({ ...p, notify_email_enabled: !p.notify_email_enabled }))}
                                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${notificationSettings.notify_email_enabled ? 'bg-indigo-600' : 'bg-zinc-200'
                                                    }`}
                                            >
                                                <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${notificationSettings.notify_email_enabled ? 'translate-x-6' : 'translate-x-1'
                                                    }`} />
                                            </button>
                                        </div>
                                    </div>

                                    <div className={`p-4 rounded-xl border transition-colors ${notificationSettings.notify_email_enabled ? 'bg-zinc-50 border-zinc-200' : 'bg-zinc-50/50 border-zinc-100 opacity-60'}`}>
                                        <div className="space-y-4">
                                            <label className="text-sm font-medium text-zinc-700">通知先メールアドレス</label>

                                            <div className="flex gap-2">
                                                <input
                                                    type="email"
                                                    value={newEmail}
                                                    onChange={(e) => setNewEmail(e.target.value)}
                                                    placeholder="example@ailuna.net"
                                                    disabled={!notificationSettings.notify_email_enabled}
                                                    className="flex-1 text-sm border-zinc-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-zinc-100"
                                                />
                                                <button
                                                    onClick={handleAddEmail}
                                                    disabled={!notificationSettings.notify_email_enabled || !newEmail}
                                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition-colors"
                                                >
                                                    <Plus className="h-4 w-4" />
                                                </button>
                                            </div>

                                            <div className="space-y-2">
                                                {notificationSettings.notify_emails.map((email) => (
                                                    <div key={email} className="flex items-center justify-between p-3 bg-white rounded-lg border border-zinc-200 shadow-sm">
                                                        <span className="text-sm text-zinc-700">{email}</span>
                                                        <button
                                                            onClick={() => handleRemoveEmail(email)}
                                                            disabled={!notificationSettings.notify_email_enabled}
                                                            className="text-zinc-400 hover:text-red-600 disabled:opacity-50 transition-colors"
                                                        >
                                                            <Trash2 className="h-4 w-4" />
                                                        </button>
                                                    </div>
                                                ))}
                                                {notificationSettings.notify_emails.length === 0 && (
                                                    <div className="text-sm text-zinc-400 text-center py-2">
                                                        メールアドレスが登録されていません
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* LINE Settings */}
                                <div className="space-y-4 pt-4 border-t border-zinc-100">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-lg font-bold text-zinc-900 flex items-center gap-2">
                                            <span className="text-[#06C755] font-bold">LINE</span>
                                            通知設定
                                        </h3>
                                        <div className="flex items-center gap-2">
                                            <span className={`text-sm font-medium ${notificationSettings.notify_line_enabled ? 'text-[#06C755]' : 'text-zinc-400'}`}>
                                                {notificationSettings.notify_line_enabled ? '有効' : '無効'}
                                            </span>
                                            <button
                                                onClick={() => {
                                                    if (!notificationSettings.line_target_id && !notificationSettings.notify_line_enabled) {
                                                        alert('LINE連携が完了していません。まずは連携を行ってください。')
                                                        return
                                                    }
                                                    setNotificationSettings(p => ({ ...p, notify_line_enabled: !p.notify_line_enabled }))
                                                }}
                                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${notificationSettings.notify_line_enabled ? 'bg-[#06C755]' : 'bg-zinc-200'
                                                    }`}
                                            >
                                                <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${notificationSettings.notify_line_enabled ? 'translate-x-6' : 'translate-x-1'
                                                    }`} />
                                            </button>
                                        </div>
                                    </div>

                                    <div className="p-6 bg-zinc-50 rounded-xl border border-zinc-200">
                                        <div className="flex flex-col gap-6">
                                            {/* Status */}
                                            <div className="flex items-center justify-between">
                                                <div className="text-sm font-medium text-zinc-700">連携ステータス</div>
                                                {notificationSettings.line_target_id ? (
                                                    <div className="flex items-center gap-2 text-[#06C755] font-bold bg-white px-3 py-1 rounded-full border border-[#06C755]/20">
                                                        <Check className="h-4 w-4" />
                                                        連携済み (ID: ****{notificationSettings.line_target_id.slice(-4)})
                                                    </div>
                                                ) : (
                                                    <div className="text-zinc-400 font-medium bg-zinc-200/50 px-3 py-1 rounded-full text-sm">
                                                        未連携
                                                    </div>
                                                )}
                                            </div>

                                            {/* Link Code Area */}
                                            <div className="space-y-4">
                                                <div className="text-sm text-zinc-600">
                                                    LINE Botと連携するには、以下のボタンでコードを発行し、LINEで送信してください。
                                                </div>

                                                {!linkToken ? (
                                                    <button
                                                        onClick={handleIssueLinkToken}
                                                        disabled={isActionLoading}
                                                        className="w-full sm:w-auto px-4 py-2 bg-white border border-zinc-300 text-zinc-700 font-medium rounded-lg hover:bg-zinc-100 transition-colors shadow-sm flex items-center justify-center gap-2"
                                                    >
                                                        {isActionLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : null}
                                                        リンクコード発行
                                                    </button>
                                                ) : (
                                                    <div className="bg-white border border-zinc-200 rounded-lg p-4 space-y-3 animate-in fade-in zoom-in-95">
                                                        <label className="text-xs text-zinc-400 font-bold uppercase tracking-wider">発行されたコード（10分間有効）</label>
                                                        <div className="flex items-center gap-2">
                                                            <div className="flex-1 text-2xl font-mono font-bold text-center tracking-[0.2em] text-zinc-800 bg-zinc-100 py-2 rounded">
                                                                {linkToken.code}
                                                            </div>
                                                            <button
                                                                onClick={copyLinkCode}
                                                                className="p-3 bg-zinc-100 text-zinc-600 rounded hover:bg-zinc-200 transition-colors"
                                                                title="コピー"
                                                            >
                                                                {isCopied ? <Check className="h-5 w-5 text-green-600" /> : <Settings className="h-5 w-5 rotate-90" />}
                                                                {/* Standard copy icon replacement using rotate trick or just text if icon unavailable in imports. 
                                                                Actually I have Settings, check existing imports. 
                                                                Imports: Calendar, Filter, ChevronLeft, ChevronRight, Loader2, X, Check, ArrowLeft, Settings, Mail, Plus, Trash2, List, GripVertical, ArrowUp, ArrowDown 
                                                                I can import Copy if I want, or perform a Quick Fix. 
                                                                Let's use 'Copy' text or similar if icon is missing, or add Copy to imports later. 
                                                                For now, I'll use a simple icon I have or just text.
                                                                Wait, I can just add Copy to imports in next step.
                                                                I'll use 'Settings' for now as placeholder or just text.*/}
                                                            </button>
                                                        </div>
                                                        <div className="text-xs text-zinc-500 space-y-1">
                                                            <p>1. LINEでBotを開いてください</p>
                                                            <p>2. 上記のコードを含めて <span className="font-mono bg-zinc-100 px-1 rounded">link {linkToken.code}</span> と送信してください</p>
                                                            <p>3. 送信後、<button onClick={loadSettings} className="text-indigo-600 underline">再読み込み</button>して連携状態を確認してください</p>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Save Button */}
                                <div className="pt-6 border-t border-zinc-100 flex justify-end">
                                    <button
                                        onClick={handleSaveSettings}
                                        disabled={isSavingSettings}
                                        className="bg-zinc-900 hover:bg-zinc-800 text-white px-8 py-3 rounded-lg font-bold shadow-md transition-all active:scale-95 disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {isSavingSettings && <Loader2 className="h-4 w-4 animate-spin" />}
                                        設定を保存する
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                )
            }

            {
                activeTab === 'form' && (
                    // --- Form Field Settings View ---
                    <div className="bg-white rounded-2xl border border-zinc-100 shadow-sm p-6 md:p-8 space-y-8">
                        {isFieldsLoading ? (
                            <div className="flex items-center justify-center h-64">
                                <Loader2 className="h-8 w-8 text-indigo-600 animate-spin" />
                            </div>
                        ) : (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-zinc-900">
                                        予約フォーム質問項目
                                    </h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={handleInitDefaults}
                                            className="text-xs sm:text-sm px-3 py-2 bg-zinc-100 hover:bg-zinc-200 text-zinc-700 rounded-lg transition-colors"
                                        >
                                            デフォルト項目追加
                                        </button>
                                        <button
                                            onClick={() => {
                                                setEditBuffer({
                                                    enabled: true,
                                                    required: false,
                                                    field_type: 'text'
                                                })
                                                setShowCreateForm(true)
                                                setEditingFieldId(null)
                                            }}
                                            className="text-xs sm:text-sm px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors shadow-sm flex items-center gap-2"
                                        >
                                            <Plus className="h-4 w-4" />
                                            新規追加
                                        </button>
                                    </div>
                                </div>

                                {formFields.length === 0 ? (
                                    <div className="py-12 text-center bg-zinc-50 rounded-xl border border-dashed border-zinc-300">
                                        <p className="text-zinc-400 mb-4">質問項目が設定されていません</p>
                                        <button
                                            onClick={handleInitDefaults}
                                            className="text-indigo-600 font-medium hover:underline text-sm"
                                        >
                                            デフォルト項目テンプレートを読み込む
                                        </button>
                                    </div>
                                ) : (
                                    <ul className="space-y-3">
                                        {formFields.map((field, index) => {
                                            const isEditing = editingFieldId === field.id

                                            if (isEditing) {
                                                return (
                                                    <li key={field.id} className="p-4 bg-zinc-50 border border-indigo-200 rounded-xl shadow-sm ring-1 ring-indigo-100">
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                            <div>
                                                                <label className="text-xs text-zinc-500 font-medium ml-1">ラベル (表示名)</label>
                                                                <input
                                                                    value={editBuffer.label || ''}
                                                                    onChange={(e) => setEditBuffer({ ...editBuffer, label: e.target.value })}
                                                                    className="w-full text-sm border-zinc-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                                                    placeholder="例: アレルギー有無"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-xs text-zinc-500 font-medium ml-1">キー (システム用)</label>
                                                                <input
                                                                    value={editBuffer.field_key || ''}
                                                                    onChange={(e) => setEditBuffer({ ...editBuffer, field_key: e.target.value })}
                                                                    className="w-full text-sm border-zinc-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs"
                                                                    placeholder="例: allergy"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-xs text-zinc-500 font-medium ml-1">タイプ</label>
                                                                <select
                                                                    value={editBuffer.field_type || 'text'}
                                                                    onChange={(e) => setEditBuffer({ ...editBuffer, field_type: e.target.value as ReservationFieldType })}
                                                                    className="w-full text-sm border-zinc-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                                                >
                                                                    <option value="text">テキスト (1行)</option>
                                                                    <option value="multiline">テキスト (複数行)</option>
                                                                    <option value="number">数値</option>
                                                                    <option value="date">日付</option>
                                                                    <option value="time">時間</option>
                                                                    <option value="select">選択リスト</option>
                                                                </select>
                                                            </div>
                                                            <div className="flex items-center gap-6 pt-6">
                                                                <label className="flex items-center gap-2 text-sm text-zinc-700 cursor-pointer">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={editBuffer.required || false}
                                                                        onChange={(e) => setEditBuffer({ ...editBuffer, required: e.target.checked })}
                                                                        className="rounded text-indigo-600 focus:ring-indigo-500"
                                                                    />
                                                                    必須項目
                                                                </label>
                                                                <label className="flex items-center gap-2 text-sm text-zinc-700 cursor-pointer">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={editBuffer.enabled !== false}
                                                                        onChange={(e) => setEditBuffer({ ...editBuffer, enabled: e.target.checked })}
                                                                        className="rounded text-indigo-600 focus:ring-indigo-500"
                                                                    />
                                                                    有効
                                                                </label>
                                                            </div>
                                                        </div>

                                                        {editBuffer.field_type === 'select' && (
                                                            <div className="mb-4">
                                                                <label className="text-xs text-zinc-500 font-medium ml-1">選択肢 (改行区切り)</label>
                                                                <textarea
                                                                    value={Array.isArray(editBuffer.options) ? editBuffer.options.join('\n') : ''}
                                                                    onChange={(e) => setEditBuffer({ ...editBuffer, options: e.target.value.split('\n').filter(Boolean) })}
                                                                    className="w-full text-sm border-zinc-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-24"
                                                                    placeholder="選択肢1&#13;&#10;選択肢2&#13;&#10;選択肢3"
                                                                />
                                                            </div>
                                                        )}

                                                        <div className="flex justify-end gap-2">
                                                            <button
                                                                onClick={handleCancelEdit}
                                                                className="px-3 py-1.5 text-xs font-medium text-zinc-600 hover:bg-zinc-100 rounded-lg"
                                                            >
                                                                キャンセル
                                                            </button>
                                                            <button
                                                                onClick={handleSaveEdit}
                                                                className="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg"
                                                            >
                                                                保存
                                                            </button>
                                                        </div>
                                                    </li>
                                                )
                                            }

                                            return (
                                                <li key={field.id} className="group p-4 bg-white border border-zinc-200 rounded-xl hover:shadow-md transition-all flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                    <div className="flex items-center gap-4 flex-1">
                                                        <div className="flex flex-col gap-1 text-zinc-300">
                                                            <button
                                                                onClick={() => handleMoveField(index, 'up')}
                                                                disabled={index === 0}
                                                                className="hover:text-zinc-600 disabled:opacity-30 p-1"
                                                            >
                                                                <ArrowUp className="w-4 h-4" />
                                                            </button>
                                                            <button
                                                                onClick={() => handleMoveField(index, 'down')}
                                                                disabled={index === formFields.length - 1}
                                                                className="hover:text-zinc-600 disabled:opacity-30 p-1"
                                                            >
                                                                <ArrowDown className="w-4 h-4" />
                                                            </button>
                                                        </div>

                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className="font-bold text-zinc-800">{field.label}</span>
                                                                {!field.enabled && <span className="text-xs bg-zinc-100 text-zinc-400 px-2 py-0.5 rounded">無効</span>}
                                                                {field.required && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-medium">必須</span>}
                                                            </div>
                                                            <div className="flex items-center gap-3 text-xs text-zinc-500 font-mono">
                                                                <span>KEY: {field.field_key}</span>
                                                                <span className="w-px h-3 bg-zinc-300" />
                                                                <span>TYPE: {field.field_type}</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="flex items-center gap-2 justify-end sm:opacity-50 group-hover:opacity-100 transition-opacity">
                                                        <button
                                                            onClick={() => handleStartEdit(field)}
                                                            className="p-2 text-zinc-500 hover:bg-zinc-100 hover:text-zinc-900 rounded-lg"
                                                            title="編集"
                                                        >
                                                            <Settings className="h-4 w-4" />
                                                        </button>
                                                        <button
                                                            onClick={() => handleDeleteField(field.id)}
                                                            className="p-2 text-zinc-500 hover:bg-red-50 hover:text-red-600 rounded-lg"
                                                            title="削除"
                                                        >
                                                            <Trash2 className="h-4 w-4" />
                                                        </button>
                                                    </div>
                                                </li>
                                            )
                                        })}
                                    </ul>
                                )}

                                {/* Create Form Modalish inline */}
                                {showCreateForm && (
                                    <div className="mt-8 p-6 bg-indigo-50 border border-indigo-100 rounded-xl animate-in fade-in slide-in-from-top-4">
                                        <h4 className="font-bold text-indigo-900 mb-4">新規項目を追加</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="text-xs text-indigo-600 font-medium ml-1">ラベル (表示名)</label>
                                                <input
                                                    value={editBuffer.label || ''}
                                                    onChange={(e) => setEditBuffer({ ...editBuffer, label: e.target.value })}
                                                    className="w-full text-sm border-indigo-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                                    placeholder="例: 年齢"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-xs text-indigo-600 font-medium ml-1">キー (システム用)</label>
                                                <input
                                                    value={editBuffer.field_key || ''}
                                                    onChange={(e) => setEditBuffer({ ...editBuffer, field_key: e.target.value })}
                                                    className="w-full text-sm border-indigo-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs"
                                                    placeholder="例: age"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-xs text-indigo-600 font-medium ml-1">タイプ</label>
                                                <select
                                                    value={editBuffer.field_type || 'text'}
                                                    onChange={(e) => setEditBuffer({ ...editBuffer, field_type: e.target.value as ReservationFieldType })}
                                                    className="w-full text-sm border-indigo-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                                >
                                                    <option value="text">テキスト (1行)</option>
                                                    <option value="multiline">テキスト (複数行)</option>
                                                    <option value="number">数値</option>
                                                    <option value="date">日付</option>
                                                    <option value="time">時間</option>
                                                    <option value="select">選択リスト</option>
                                                </select>
                                            </div>
                                            <div className="flex items-center gap-6 pt-6">
                                                <label className="flex items-center gap-2 text-sm text-indigo-900 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={editBuffer.required || false}
                                                        onChange={(e) => setEditBuffer({ ...editBuffer, required: e.target.checked })}
                                                        className="rounded text-indigo-600 focus:ring-indigo-500"
                                                    />
                                                    必須項目
                                                </label>
                                                <label className="flex items-center gap-2 text-sm text-indigo-900 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={editBuffer.enabled !== false}
                                                        onChange={(e) => setEditBuffer({ ...editBuffer, enabled: e.target.checked })}
                                                        className="rounded text-indigo-600 focus:ring-indigo-500"
                                                    />
                                                    有効
                                                </label>
                                            </div>
                                        </div>

                                        {editBuffer.field_type === 'select' && (
                                            <div className="mb-4">
                                                <label className="text-xs text-indigo-600 font-medium ml-1">選択肢 (改行区切り)</label>
                                                <textarea
                                                    value={Array.isArray(editBuffer.options) ? editBuffer.options.join('\n') : ''}
                                                    onChange={(e) => setEditBuffer({ ...editBuffer, options: e.target.value.split('\n').filter(Boolean) })}
                                                    className="w-full text-sm border-indigo-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-24"
                                                    placeholder="選択肢1&#13;&#10;選択肢2&#13;&#10;選択肢3"
                                                />
                                            </div>
                                        )}

                                        <div className="flex justify-end gap-3 mt-6">
                                            <button
                                                onClick={() => {
                                                    setShowCreateForm(false)
                                                    setEditBuffer({})
                                                }}
                                                className="px-4 py-2 text-sm font-medium text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors"
                                            >
                                                キャンセル
                                            </button>
                                            <button
                                                onClick={handleCreateField}
                                                className="px-6 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm transition-colors"
                                            >
                                                作成する
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )
            }
        </div >
    )
}

---
---
File: web/src/app/globals.css
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
---
---
File: web/src/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "AiLuna - AI電話取次サービス",
  description: "24時間365日、あなたの代わりにAIが電話応対。機会損失をゼロにする次世代の電話番サービスです。",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    // ここに suppressHydrationWarning を追加しました
    <html lang="ja" suppressHydrationWarning>
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}
---
---
File: web/src/app/login/actions.ts
'use server'

import { headers } from 'next/headers'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

import { createClient } from '@/utils/supabase/server'

export async function login(formData: FormData): Promise<{ error: string } | undefined> {
    console.log('Login action started')
    const supabase = await createClient()

    const email = formData.get('email') as string
    const password = formData.get('password') as string

    const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
    })

    if (error) {
        console.error('Login error:', error)
        return { error: 'メールアドレスまたはパスワードが間違っています。' }
    }

    console.log('Login success, redirecting...')
    revalidatePath('/', 'layout')
    redirect('/dashboard')
}


export async function signup(formData: FormData): Promise<{ error: string } | { success: true }> {
    const supabase = await createClient()
    const origin = (await headers()).get('origin')

    const email = formData.get('email') as string
    const password = formData.get('password') as string
    const lastName = formData.get('lastName') as string
    const firstName = formData.get('firstName') as string
    const accountName = formData.get('accountName') as string

    // Combine lastName and firstName into full_name
    const fullName = `${lastName} ${firstName}`

    console.log('Signup data:', { email, fullName, accountName })

    const { error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
            emailRedirectTo: `${origin}/auth/complete`,
            data: {
                full_name: fullName,
                account_name: accountName,
            },
        },
    })

    if (authError) {
        console.error('Signup error:', authError)
        return { error: '登録に失敗しました。別のメールアドレスをお試しください。' }
    }

    revalidatePath('/', 'layout')
    return { success: true }
}

export async function resetPassword(formData: FormData): Promise<{ error: string } | { success: true }> {
    const supabase = await createClient()
    const origin = (await headers()).get('origin')

    const email = formData.get('email') as string

    const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${origin}/auth/complete?next=/auth/update-password`,
    })

    if (error) {
        console.error('Reset password error:', error)
        return { error: 'パスワードリセットに失敗しました。' }
    }

    return { success: true }
}

---
---
File: web/src/app/login/page.tsx
import AuthForm from '@/components/AuthForm'
import Header from '@/components/Header'
import Footer from '@/components/Footer'

type FormMode = 'login' | 'signup' | 'reset'

interface LoginPageProps {
    searchParams: Promise<{ mode?: string }>
}

export default async function LoginPage({ searchParams }: LoginPageProps) {
    const params = await searchParams
    const mode = params.mode as FormMode | undefined
    const initialMode: FormMode = mode === 'signup' || mode === 'login' || mode === 'reset' ? mode : 'login'

    return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex flex-col">
            <Header />

            <div className="flex flex-grow flex-col items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div className="sm:mx-auto sm:w-full sm:max-w-md mb-8">
                    <h1 className="text-center text-4xl font-extrabold text-gray-900 mb-2">
                        AiLuna
                    </h1>
                    <p className="text-center text-gray-600">
                        AI電話取次サービス
                    </p>
                </div>

                <AuthForm initialMode={initialMode} />
            </div>

            <Footer />
        </div>
    )
}

---
---
File: web/src/app/page.tsx
import { createClient } from '@/utils/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import Header from '@/components/Header'
import Footer from '@/components/Footer'
import { Phone, MessageSquare, Settings, BarChart3, ArrowRight } from 'lucide-react'

export default async function Home() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (user) {
    redirect('/dashboard')
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex flex-col">
      <Header />

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex-grow">
        {/* Hero Section */}
        <div className="mt-10 sm:mt-12 md:mt-16 lg:mt-20 xl:mt-28">
          <div className="text-center">
            <h1>
              <span className="block text-sm font-semibold text-indigo-600 tracking-wide uppercase">
                AI電話取次サービス
              </span>
              <span className="mt-1 block text-4xl tracking-tight font-extrabold sm:text-5xl xl:text-6xl">
                <span className="block text-gray-900">電話対応をAIに任せて</span>
                <span className="block text-indigo-600">あとからチャットで振り返る</span>
              </span>
            </h1>
            <p className="mt-3 max-w-md mx-auto text-base text-gray-500 sm:text-lg md:mt-5 md:text-xl md:max-w-3xl">
              AiLuna（アイルナ）は、AIがあなたの代わりに電話対応。
              通話内容はチャット形式で確認でき、AIへの指示も自由に編集できます。
              お店に合わせたAIオペレーターを、今すぐ無料で試せます。
            </p>
            <div className="mt-5 max-w-md mx-auto sm:flex sm:justify-center md:mt-8">
              <div className="rounded-md shadow">
                <Link
                  href="/login?mode=signup"
                  className="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 md:py-4 md:text-lg md:px-10 transition-all active:scale-[0.96]"
                >
                  無料で試してみる
                  <ArrowRight className="ml-2 h-5 w-5" />
                </Link>
              </div>
            </div>
          </div>
        </div>

        {/* Features Section */}
        <div className="mt-20 sm:mt-24 lg:mt-32">
          <div className="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3">
            {/* Feature 1 */}
            <div className="relative">
              <div className="flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                <MessageSquare className="h-6 w-6" />
              </div>
              <div className="mt-5">
                <h3 className="text-lg font-medium text-gray-900">トーク形式で通話を確認</h3>
                <p className="mt-2 text-base text-gray-500">
                  電話の内容を、LINEのようなチャット形式で振り返れます。いつ・誰が・何を話したか一目瞭然。
                </p>
              </div>
            </div>

            {/* Feature 2 */}
            <div className="relative">
              <div className="flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                <Settings className="h-6 w-6" />
              </div>
              <div className="mt-5">
                <h3 className="text-lg font-medium text-gray-900">AIの話し方を自分で編集</h3>
                <p className="mt-2 text-base text-gray-500">
                  挨拶や対応方法をダッシュボードから簡単にカスタマイズ。お店ごとのAIオペレーターが作れます。
                </p>
              </div>
            </div>

            {/* Feature 3 */}
            <div className="relative">
              <div className="flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                <BarChart3 className="h-6 w-6" />
              </div>
              <div className="mt-5">
                <h3 className="text-lg font-medium text-gray-900">着信状況をひと目で把握</h3>
                <p className="mt-2 text-base text-gray-500">
                  着信件数・利用時間・今月の請求額など、必要な情報がダッシュボードに集約されています。
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* CTA Section */}
        <div className="mt-20 sm:mt-24 lg:mt-32 mb-20">
          <div className="bg-indigo-700 rounded-2xl shadow-xl overflow-hidden">
            <div className="px-6 py-12 sm:px-12 sm:py-16 lg:flex lg:items-center lg:justify-between">
              <div>
                <h2 className="text-3xl font-extrabold text-white sm:text-4xl">
                  <span className="block">今すぐ始めませんか？</span>
                  <span className="block text-indigo-200">無料でお試しいただけます。</span>
                </h2>
              </div>
              <div className="mt-8 lg:mt-0 lg:flex-shrink-0">
                <Link
                  href="/login?mode=signup"
                  className="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-indigo-600 bg-white hover:bg-indigo-50 transition-all active:scale-[0.96]"
                >
                  アカウント登録
                  <ArrowRight className="ml-2 h-5 w-5" />
                </Link>
              </div>
            </div>
          </div>
        </div>
      </main>

      <Footer />
    </div>
  )
}

---
---
File: web/src/app/privacy/page.tsx
import Link from 'next/link'
import { ArrowLeft } from 'lucide-react'
import Footer from '@/components/Footer'

export const metadata = {
    title: 'プライバシーポリシー - AiLuna',
    description: 'AiLunaサービスのプライバシーポリシーです。',
}

export default function PrivacyPage() {
    return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex flex-col">
            <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 flex-grow">
                {/* Back to Home Link */}
                <Link
                    href="/"
                    className="inline-flex items-center text-sm text-indigo-600 hover:text-indigo-700 mb-8 transition-colors"
                >
                    <ArrowLeft className="h-4 w-4 mr-1" />
                    トップページに戻る
                </Link>

                {/* Header */}
                <div className="text-center mb-12">
                    <h1 className="text-4xl font-extrabold text-gray-900 sm:text-5xl">
                        プライバシーポリシー
                    </h1>
                    <p className="mt-4 text-lg text-gray-600">
                        AiLunaは、ユーザーの皆様の個人情報を適切に保護し、安心してサービスをご利用いただけるよう努めています。
                    </p>
                    <p className="mt-2 text-sm text-gray-500">
                        最終更新日：2025年11月22日
                    </p>
                </div>

                {/* Content */}
                <div className="bg-white rounded-2xl shadow-lg p-8 sm:p-12 space-y-8">
                    {/* Section 1 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">1. 収集する情報</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            当社は、本サービスの提供にあたり、以下の情報を収集します。
                        </p>
                        <div className="space-y-4">
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-2">1.1 アカウント登録時の情報</h3>
                                <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                    <li>氏名（姓・名）</li>
                                    <li>アカウント名</li>
                                    <li>メールアドレス</li>
                                    <li>パスワード（暗号化して保存）</li>
                                </ul>
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-2">1.2 サービス利用時の情報</h3>
                                <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                    <li>電話番号（ユーザーが設定した場合）</li>
                                    <li>通話ログ（発信者番号、通話日時、通話時間、会話内容の書き起こし）</li>
                                    <li>AI設定情報（挨拶メッセージ、事業内容の説明）</li>
                                    <li>利用状況に関するデータ（着信回数、利用時間など）</li>
                                </ul>
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-2">1.3 自動的に収集される情報</h3>
                                <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                    <li>IPアドレス</li>
                                    <li>ブラウザの種類とバージョン</li>
                                    <li>アクセス日時</li>
                                    <li>クッキー情報</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    {/* Section 2 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">2. 情報の利用目的</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            収集した個人情報は、以下の目的で利用します。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>本サービスの提供、運営、維持、改善のため</li>
                            <li>ユーザーサポート、お問い合わせへの対応のため</li>
                            <li>AI電話取次機能の提供および通話内容の記録・要約のため</li>
                            <li>利用状況の分析、統計データの作成のため</li>
                            <li>新機能、アップデート、キャンペーン等のご案内のため</li>
                            <li>利用規約違反や不正利用の防止・対応のため</li>
                            <li>法令に基づく対応のため</li>
                        </ul>
                    </section>

                    {/* Section 3 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">3. 情報の第三者提供</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            当社は、以下の場合を除き、ユーザーの個人情報を第三者に提供することはありません。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>ユーザーの同意がある場合</li>
                            <li>法令に基づく場合</li>
                            <li>人の生命、身体または財産の保護のために必要がある場合であって、本人の同意を得ることが困難である場合</li>
                            <li>サービス提供に必要な範囲で、業務委託先に提供する場合（適切な管理・監督を行います）</li>
                        </ul>
                        <p className="text-gray-700 leading-relaxed mt-4">
                            なお、本サービスは以下の外部サービスを利用しており、それぞれのプライバシーポリシーに従って情報が取り扱われます。
                        </p>
                        <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4 mt-2">
                            <li>Supabase（認証・データベース）</li>
                            <li>OpenAI（通話要約生成）</li>
                            <li>Twilio（電話通信）</li>
                        </ul>
                    </section>

                    {/* Section 4 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">4. 情報の保存期間・削除</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            当社は、個人情報を利用目的の達成に必要な期間に限り保存します。
                        </p>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            ユーザーがアカウントを削除した場合、関連する個人情報は合理的な期間内に削除されます。ただし、法令に基づく保存義務がある場合や、紛争解決のために必要な場合は、この限りではありません。
                        </p>
                        <p className="text-gray-700 leading-relaxed">
                            通話ログは、サービス提供および改善のために保存されますが、ユーザーはダッシュボードから個別の通話ログを確認・管理することができます。
                        </p>
                    </section>

                    {/* Section 5 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">5. セキュリティ</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            当社は、個人情報の漏洩、滅失、毀損を防止するため、以下のセキュリティ対策を実施しています。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>SSL/TLS暗号化通信の使用</li>
                            <li>パスワードの暗号化保存</li>
                            <li>アクセス制御とRow Level Security（RLS）の実装</li>
                            <li>定期的なセキュリティ監査</li>
                            <li>従業員への情報セキュリティ教育</li>
                        </ul>
                        <p className="text-gray-700 leading-relaxed mt-4">
                            ただし、インターネット上の通信には完全なセキュリティを保証することはできないため、ユーザー自身もパスワード管理等に十分ご注意ください。
                        </p>
                    </section>

                    {/* Section 6 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">6. クッキー等の利用</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            本サービスでは、ユーザーの利便性向上およびサービス改善のため、クッキー（Cookie）および類似の技術を使用しています。
                        </p>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            クッキーは、ユーザーのブラウザに保存される小さなテキストファイルで、以下の目的で使用されます。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>ログイン状態の維持</li>
                            <li>ユーザー設定の保存</li>
                            <li>サービス利用状況の分析</li>
                        </ul>
                        <p className="text-gray-700 leading-relaxed mt-4">
                            ブラウザの設定により、クッキーの受け入れを拒否することも可能ですが、その場合、本サービスの一部機能が正常に動作しない可能性があります。
                        </p>
                    </section>

                    {/* Section 7 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">7. プライバシーポリシーの変更</h2>
                        <p className="text-gray-700 leading-relaxed">
                            当社は、法令の変更や本サービスの機能追加等に伴い、本プライバシーポリシーを変更することがあります。変更後のプライバシーポリシーは、当社ウェブサイトに掲載した時点より効力を生じるものとします。重要な変更がある場合は、ユーザーに対して適切な方法で通知いたします。
                        </p>
                    </section>

                    {/* Section 8 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">8. お問い合わせ窓口</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            個人情報の取り扱いに関するお問い合わせ、開示・訂正・削除等のご請求は、以下の窓口までご連絡ください。
                        </p>
                        <div className="bg-gray-50 rounded-lg p-6 mt-4">
                            <p className="text-gray-700">
                                <span className="font-semibold">サービス名：</span>AiLuna
                            </p>
                            <p className="text-gray-700 mt-2">
                                <span className="font-semibold">お問い合わせ先：</span>
                                <span className="text-gray-500">（準備中 - 正式版公開時に記載予定）</span>
                            </p>
                        </div>
                    </section>

                    {/* Notice */}
                    <div className="mt-12 pt-8 border-t border-gray-200">
                        <p className="text-sm text-gray-500 text-center">
                            ※ 本プライバシーポリシーはドラフト版です。正式版は法的レビューを経て公開される予定です。
                        </p>
                    </div>
                </div>
            </div>

            <Footer />
        </div>
    )
}

---
---
File: web/src/app/terms/page.tsx
import Link from 'next/link'
import { ArrowLeft } from 'lucide-react'
import Footer from '@/components/Footer'

export const metadata = {
    title: '利用規約 - AiLuna',
    description: 'AiLunaサービスの利用規約です。',
}

export default function TermsPage() {
    return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex flex-col">
            <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 flex-grow">
                {/* Back to Home Link */}
                <Link
                    href="/"
                    className="inline-flex items-center text-sm text-indigo-600 hover:text-indigo-700 mb-8 transition-colors"
                >
                    <ArrowLeft className="h-4 w-4 mr-1" />
                    トップページに戻る
                </Link>

                {/* Header */}
                <div className="text-center mb-12">
                    <h1 className="text-4xl font-extrabold text-gray-900 sm:text-5xl">
                        利用規約
                    </h1>
                    <p className="mt-4 text-lg text-gray-600">
                        AiLunaサービスをご利用いただくにあたり、以下の利用規約をご確認ください。
                    </p>
                    <p className="mt-2 text-sm text-gray-500">
                        最終更新日：2025年11月22日
                    </p>
                </div>

                {/* Content */}
                <div className="bg-white rounded-2xl shadow-lg p-8 sm:p-12 space-y-8">
                    {/* Section 1 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第1条（適用）</h2>
                        <p className="text-gray-700 leading-relaxed">
                            本利用規約（以下「本規約」といいます）は、AiLuna（以下「当社」といいます）が提供するAI電話取次サービス「AiLuna」（以下「本サービス」といいます）の利用条件を定めるものです。ユーザーの皆様（以下「ユーザー」といいます）には、本規約に従って本サービスをご利用いただきます。
                        </p>
                    </section>

                    {/* Section 2 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第2条（定義）</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            本規約において使用する用語の定義は、以下のとおりとします。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>「本サービス」とは、当社が提供するAI電話取次サービス「AiLuna」を指します。</li>
                            <li>「ユーザー」とは、本サービスを利用する個人または法人を指します。</li>
                            <li>「登録情報」とは、ユーザーが本サービスの利用登録時に提供する情報を指します。</li>
                            <li>「通話ログ」とは、本サービスを通じて記録される通話内容および関連データを指します。</li>
                        </ul>
                    </section>

                    {/* Section 3 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第3条（登録）</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            本サービスの利用を希望する方は、本規約に同意の上、当社所定の方法により利用登録を行うものとします。
                        </p>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            当社は、登録申請者が以下のいずれかに該当する場合、登録を拒否することがあります。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>登録情報に虚偽の記載、誤記、または記入漏れがあった場合</li>
                            <li>過去に本規約違反等により登録を取り消された者である場合</li>
                            <li>その他、当社が登録を適当でないと判断した場合</li>
                        </ul>
                    </section>

                    {/* Section 4 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第4条（禁止事項）</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            ユーザーは、本サービスの利用にあたり、以下の行為を行ってはならないものとします。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>法令または公序良俗に違反する行為</li>
                            <li>犯罪行為に関連する行為</li>
                            <li>当社または第三者の知的財産権、肖像権、プライバシー、名誉その他の権利または利益を侵害する行為</li>
                            <li>本サービスのネットワークまたはシステム等に過度な負荷をかける行為</li>
                            <li>本サービスの運営を妨害するおそれのある行為</li>
                            <li>不正アクセスをし、またはこれを試みる行為</li>
                            <li>他のユーザーに関する個人情報等を収集または蓄積する行為</li>
                            <li>その他、当社が不適切と判断する行為</li>
                        </ul>
                    </section>

                    {/* Section 5 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第5条（サービスの提供の停止・中断）</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            当社は、以下のいずれかの事由があると判断した場合、ユーザーに事前に通知することなく本サービスの全部または一部の提供を停止または中断することができるものとします。
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>本サービスにかかるコンピュータシステムの保守点検または更新を行う場合</li>
                            <li>地震、落雷、火災、停電または天災などの不可抗力により、本サービスの提供が困難となった場合</li>
                            <li>コンピュータまたは通信回線等が事故により停止した場合</li>
                            <li>その他、当社が本サービスの提供が困難と判断した場合</li>
                        </ul>
                    </section>

                    {/* Section 6 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第6条（免責事項）</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            当社は、本サービスに関して、ユーザーと他のユーザーまたは第三者との間において生じた取引、連絡または紛争等について一切責任を負いません。
                        </p>
                        <p className="text-gray-700 leading-relaxed">
                            本サービスは現状有姿で提供されるものであり、当社は本サービスの完全性、正確性、確実性、有用性等について、いかなる保証も行いません。
                        </p>
                    </section>

                    {/* Section 7 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第7条（利用規約の変更）</h2>
                        <p className="text-gray-700 leading-relaxed">
                            当社は、必要と判断した場合には、ユーザーに通知することなくいつでも本規約を変更することができるものとします。変更後の本規約は、当社ウェブサイトに掲示された時点より効力を生じるものとします。
                        </p>
                    </section>

                    {/* Section 8 */}
                    <section>
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">第8条（準拠法・裁判管轄）</h2>
                        <p className="text-gray-700 leading-relaxed mb-3">
                            本規約の解釈にあたっては、日本法を準拠法とします。
                        </p>
                        <p className="text-gray-700 leading-relaxed">
                            本サービスに関して紛争が生じた場合には、当社の本店所在地を管轄する裁判所を専属的合意管轄とします。
                        </p>
                    </section>

                    {/* Notice */}
                    <div className="mt-12 pt-8 border-t border-gray-200">
                        <p className="text-sm text-gray-500 text-center">
                            ※ 本利用規約はドラフト版です。正式版は法的レビューを経て公開される予定です。
                        </p>
                    </div>
                </div>
            </div>

            <Footer />
        </div>
    )
}

---
---
File: web/src/components/AccountInfoCard.tsx
import { User, Phone } from 'lucide-react'

type AccountInfoCardProps = {
    accountName?: string | null
    phoneNumber?: string | null
}

export function AccountInfoCard({ accountName, phoneNumber }: AccountInfoCardProps) {
    const displayAccountName = accountName || '未設定'
    const displayPhoneNumber = phoneNumber || '未登録'
    const isPhoneRegistered = !!phoneNumber

    return (
        <div className="flex items-center gap-3 p-3 rounded-xl bg-zinc-50 border border-zinc-100">
            <div className="h-10 w-10 rounded-full bg-white border border-zinc-200 flex items-center justify-center text-zinc-400 shadow-sm">
                <User className="h-5 w-5" />
            </div>
            <div className="flex flex-col min-w-0">
                <span className="font-semibold text-zinc-900 text-sm truncate">
                    {displayAccountName}
                </span>
                <div className="flex items-center gap-1 text-xs text-zinc-500">
                    <Phone className="h-3 w-3" />
                    <span className="truncate">
                        {displayPhoneNumber}
                    </span>
                </div>
            </div>
        </div>
    )
}

---
---
File: web/src/components/AuthForm.tsx
'use client'

import { useState } from 'react'
import { login, signup, resetPassword } from '@/app/login/actions'
import { Mail, Lock, ArrowRight, UserPlus, LogIn, Eye, EyeOff, Loader2, MailCheck, KeyRound, User } from 'lucide-react'
import { motion, AnimatePresence } from 'framer-motion'

type FormMode = 'login' | 'signup' | 'reset'

interface AuthFormProps {
    initialMode?: FormMode
}

export default function AuthForm({ initialMode = 'login' }: AuthFormProps) {
    const [mode, setMode] = useState<FormMode>(initialMode)
    const [errorMessage, setErrorMessage] = useState<string | null>(null)
    const [showPassword, setShowPassword] = useState(false)
    const [showConfirmPassword, setShowConfirmPassword] = useState(false)
    const [isSubmitting, setIsSubmitting] = useState(false)
    const [signupSuccess, setSignupSuccess] = useState(false)
    const [resetSuccess, setResetSuccess] = useState(false)

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        setErrorMessage(null)
        const formData = new FormData(e.currentTarget)

        // Password confirmation validation for signup
        if (mode === 'signup') {
            const password = formData.get('password') as string
            const confirmPassword = formData.get('confirmPassword') as string

            if (password !== confirmPassword) {
                setErrorMessage('パスワードが一致しません。')
                return
            }
        }

        setIsSubmitting(true)

        let result
        if (mode === 'login') {
            result = await login(formData)
        } else if (mode === 'signup') {
            result = await signup(formData)
        } else {
            result = await resetPassword(formData)
        }

        setIsSubmitting(false)

        if (result && 'error' in result) {
            setErrorMessage(result.error)
        } else if (result && 'success' in result) {
            if (mode === 'signup') {
                setSignupSuccess(true)
            } else if (mode === 'reset') {
                setResetSuccess(true)
            }
        }
    }

    // Success screen for signup
    if (signupSuccess) {
        return (
            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden"
            >
                <div className="p-8 text-center">
                    <div className="flex justify-center mb-6">
                        <div className="bg-green-100 p-4 rounded-full">
                            <MailCheck className="w-12 h-12 text-green-600" />
                        </div>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">
                        認証メールを送信しました
                    </h2>
                    <p className="text-gray-600 mb-6">
                        ご登録いただいたメールアドレスに認証リンクを送信しました。
                        メール内のリンクをクリックして、アカウントを有効化してください。
                    </p>
                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 text-left">
                        <p className="text-sm text-blue-700">
                            <strong>ヒント:</strong> メールが届かない場合は、迷惑メールフォルダをご確認ください。
                        </p>
                    </div>
                </div>
            </motion.div>
        )
    }

    // Success screen for password reset
    if (resetSuccess) {
        return (
            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden"
            >
                <div className="p-8 text-center">
                    <div className="flex justify-center mb-6">
                        <div className="bg-green-100 p-4 rounded-full">
                            <MailCheck className="w-12 h-12 text-green-600" />
                        </div>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">
                        再設定メールを送信しました
                    </h2>
                    <p className="text-gray-600 mb-6">
                        ご登録いただいたメールアドレスにパスワード再設定用のリンクを送信しました。
                        メール内のリンクをクリックして、新しいパスワードを設定してください。
                    </p>
                    <button
                        onClick={() => {
                            setResetSuccess(false)
                            setMode('login')
                        }}
                        className="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-500 transition-colors"
                    >
                        ログイン画面に戻る
                    </button>
                </div>
            </motion.div>
        )
    }

    return (
        <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <AnimatePresence mode="wait">
                <motion.div
                    key={mode}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: -20 }}
                    transition={{ duration: 0.3 }}
                    className="p-8"
                >
                    <div className="flex justify-center mb-6">
                        <div className="bg-indigo-100 p-3 rounded-full">
                            {mode === 'login' ? (
                                <LogIn className="w-8 h-8 text-indigo-600" />
                            ) : mode === 'signup' ? (
                                <UserPlus className="w-8 h-8 text-indigo-600" />
                            ) : (
                                <KeyRound className="w-8 h-8 text-indigo-600" />
                            )}
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">
                        {mode === 'login' ? 'おかえりなさい' : mode === 'signup' ? 'アカウント作成' : 'パスワードリセット'}
                    </h2>
                    <p className="text-center text-gray-500 mb-8">
                        {mode === 'login'
                            ? 'アカウントにログインして続行'
                            : mode === 'signup'
                                ? '新しいアカウントを作成して開始'
                                : 'メールアドレスを入力してください'}
                    </p>

                    {errorMessage && (
                        <motion.div
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700"
                        >
                            <p className="font-bold">エラー</p>
                            <p>{errorMessage}</p>
                        </motion.div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-900 mb-1">
                                メールアドレス
                            </label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <Mail className="h-5 w-5 text-gray-400" />
                                </div>
                                <input
                                    name="email"
                                    type="email"
                                    required
                                    className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                    placeholder="you@example.com"
                                />
                            </div>
                        </div>

                        {mode !== 'reset' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-900 mb-1">
                                        パスワード
                                    </label>
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <Lock className="h-5 w-5 text-gray-400" />
                                        </div>
                                        <input
                                            name="password"
                                            type={showPassword ? 'text' : 'password'}
                                            required
                                            className="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                            placeholder="••••••••"
                                        />
                                        <button
                                            type="button"
                                            onClick={() => setShowPassword(!showPassword)}
                                            className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors"
                                        >
                                            {showPassword ? (
                                                <EyeOff className="h-5 w-5" />
                                            ) : (
                                                <Eye className="h-5 w-5" />
                                            )}
                                        </button>
                                    </div>

                                    {mode === 'login' && (
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setMode('reset')
                                                setErrorMessage(null)
                                            }}
                                            className="mt-2 text-sm text-indigo-600 hover:text-indigo-500 transition-colors"
                                        >
                                            パスワードをお忘れですか?
                                        </button>
                                    )}
                                </div>

                                {/* Password confirmation field - only shown for signup */}
                                {mode === 'signup' && (
                                    <motion.div
                                        initial={{ opacity: 0, height: 0 }}
                                        animate={{ opacity: 1, height: 'auto' }}
                                        exit={{ opacity: 0, height: 0 }}
                                    >
                                        <label className="block text-sm font-medium text-gray-900 mb-1">
                                            パスワード(確認用)
                                        </label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <Lock className="h-5 w-5 text-gray-400" />
                                            </div>
                                            <input
                                                name="confirmPassword"
                                                type={showConfirmPassword ? 'text' : 'password'}
                                                required
                                                className="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                                placeholder="••••••••"
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                                className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors"
                                            >
                                                {showConfirmPassword ? (
                                                    <EyeOff className="h-5 w-5" />
                                                ) : (
                                                    <Eye className="h-5 w-5" />
                                                )}
                                            </button>
                                        </div>
                                    </motion.div>
                                )}

                                {/* First and Last name fields - only shown for signup */}
                                {mode === 'signup' && (
                                    <motion.div
                                        initial={{ opacity: 0, height: 0 }}
                                        animate={{ opacity: 1, height: 'auto' }}
                                        exit={{ opacity: 0, height: 0 }}
                                        className="grid grid-cols-2 gap-4"
                                    >
                                        <div>
                                            <label className="block text-sm font-medium text-gray-900 mb-1">
                                                氏
                                            </label>
                                            <div className="relative">
                                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <User className="h-5 w-5 text-gray-400" />
                                                </div>
                                                <input
                                                    name="lastName"
                                                    type="text"
                                                    required
                                                    className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                                    placeholder="大塚"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-900 mb-1">
                                                名
                                            </label>
                                            <div className="relative">
                                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <User className="h-5 w-5 text-gray-400" />
                                                </div>
                                                <input
                                                    name="firstName"
                                                    type="text"
                                                    required
                                                    className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                                    placeholder="孝雄"
                                                />
                                            </div>
                                        </div>
                                    </motion.div>
                                )}

                                {/* Account name field - only shown for signup */}
                                {mode === 'signup' && (
                                    <motion.div
                                        initial={{ opacity: 0, height: 0 }}
                                        animate={{ opacity: 1, height: 'auto' }}
                                        exit={{ opacity: 0, height: 0 }}
                                    >
                                        <label className="block text-sm font-medium text-gray-900 mb-1">
                                            アカウント名
                                        </label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <User className="h-5 w-5 text-gray-400" />
                                            </div>
                                            <input
                                                name="accountName"
                                                type="text"
                                                required
                                                className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-900 bg-white"
                                                placeholder="例：大塚家具塩尻店"
                                            />
                                        </div>
                                    </motion.div>
                                )}
                            </>
                        )}

                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all active:scale-[0.96] disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100"
                        >
                            {isSubmitting ? (
                                <>
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                    処理中...
                                </>
                            ) : (
                                <>
                                    {mode === 'login' ? 'ログイン' : mode === 'signup' ? '登録する' : 'リセットメール送信'}
                                    <ArrowRight className="ml-2 h-4 w-4" />
                                </>
                            )}
                        </button>
                    </form>

                    <div className="mt-6">
                        <div className="relative">
                            <div className="absolute inset-0 flex items-center">
                                <div className="w-full border-t border-gray-300" />
                            </div>
                            <div className="relative flex justify-center text-sm">
                                <span className="px-2 bg-white text-gray-500">
                                    または
                                </span>
                            </div>
                        </div>

                        <div className="mt-6 text-center space-y-2">
                            {mode === 'reset' ? (
                                <button
                                    onClick={() => {
                                        setMode('login')
                                        setErrorMessage(null)
                                    }}
                                    className="text-sm font-medium text-indigo-600 hover:text-indigo-500 transition-colors"
                                >
                                    ログインに戻る
                                </button>
                            ) : (
                                <button
                                    onClick={() => {
                                        setMode(mode === 'login' ? 'signup' : 'login')
                                        setErrorMessage(null)
                                    }}
                                    className="text-sm font-medium text-indigo-600 hover:text-indigo-500 transition-colors"
                                >
                                    {mode === 'login'
                                        ? 'アカウントをお持ちでない方はこちら'
                                        : 'すでにアカウントをお持ちの方はこちら'}
                                </button>
                            )}
                        </div>
                    </div>
                </motion.div>
            </AnimatePresence>
            <div className="bg-gray-50 px-8 py-4 border-t border-gray-100 text-center">
                <p className="text-xs text-gray-500">
                    続行することで、利用規約とプライバシーポリシーに同意したことになります。
                </p>
            </div>
        </div>
    )
}

---
---
File: web/src/components/CallLogList.tsx
'use client'

import { useState } from 'react'
import { ChevronDown, Phone, Loader2, Search, X, Calendar, User, Filter } from 'lucide-react'
import { ConversationViewer, TranscriptItem } from './ConversationViewer'
import { fetchCallLogsPaginated } from '@/app/dashboard/actions'

type CallLog = {
    id: string
    created_at: string
    caller_number: string | null
    call_sid?: string | null
    transcript?: TranscriptItem[] | null
    summary: string | null
    duration_seconds?: number | null
}

interface CallLogListProps {
    initialLogs: CallLog[]
    initialCount: number | null
    uniqueCallers: string[]
}

export function CallLogList({ initialLogs, initialCount, uniqueCallers }: CallLogListProps) {
    const [logs, setLogs] = useState<CallLog[]>(initialLogs)
    const [count, setCount] = useState<number>(initialCount || 0)
    const [offset, setOffset] = useState(10)
    const [filters, setFilters] = useState({
        startDate: '',
        endDate: '',
        callerNumber: ''
    })
    const [activeFilters, setActiveFilters] = useState({
        startDate: '',
        endDate: '',
        callerNumber: ''
    })
    const [loading, setLoading] = useState(false)
    const [expandedId, setExpandedId] = useState<string | null>(null)
    const [isFilterOpen, setIsFilterOpen] = useState(false)

    const toggleExpand = (id: string) => {
        setExpandedId(expandedId === id ? null : id)
    }

    const formatDate = (dateString: string) => {
        const date = new Date(dateString)
        return date.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
        }).replace(/\//g, '/')
    }

    const handleFilterChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value } = e.target
        setFilters(prev => ({ ...prev, [name]: value }))
    }

    const applyFilters = async () => {
        setLoading(true)
        setActiveFilters(filters)
        try {
            // Reset to first page
            const { logs: newLogs, count: newCount } = await fetchCallLogsPaginated(0, 10, filters)
            setLogs(newLogs as CallLog[])
            setCount(newCount || 0)
            setOffset(10)
            setExpandedId(null)
            setIsFilterOpen(false)
        } catch (error) {
            console.error('Failed to apply filters:', error)
            alert('検索に失敗しました。')
        } finally {
            setLoading(false)
        }
    }

    const clearFilters = async () => {
        const emptyFilters = { startDate: '', endDate: '', callerNumber: '' }
        setFilters(emptyFilters)
        setActiveFilters(emptyFilters)
        setLoading(true)
        try {
            // Reset to first page
            const { logs: newLogs, count: newCount } = await fetchCallLogsPaginated(0, 10, emptyFilters)
            setLogs(newLogs as CallLog[])
            setCount(newCount || 0)
            setOffset(10)
            setExpandedId(null)
        } catch (error) {
            console.error('Failed to clear filters:', error)
            alert('リセットに失敗しました。')
        } finally {
            setLoading(false)
        }
    }


    const handleLoadMore = async () => {
        setLoading(true)
        try {
            const { logs: newLogs } = await fetchCallLogsPaginated(offset, 10, activeFilters)
            if (newLogs && newLogs.length > 0) {
                setLogs([...logs, ...newLogs as CallLog[]])
                setOffset(offset + 10)
            }
        } catch (error) {
            console.error('Failed to load more logs:', error)
            alert('読み込みに失敗しました。')
        } finally {
            setLoading(false)
        }
    }

    return (
        <div>
            {/* ヘッダー部分：件数表示とフィルター */}
            <div className="relative p-6 border-b border-zinc-200 bg-white">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <h2 className="text-lg font-bold text-zinc-900">通話履歴</h2>
                        <span className="text-sm text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">
                            全{count}件
                        </span>
                    </div>

                    <button
                        onClick={() => setIsFilterOpen(!isFilterOpen)}
                        className={`p-2 rounded-lg transition-colors border border-transparent ${isFilterOpen
                            ? 'bg-indigo-50 text-indigo-600 border-indigo-100'
                            : 'text-zinc-500 hover:bg-zinc-50 hover:text-zinc-900 hover:border-zinc-200'
                            }`}
                        title="フィルター"
                    >
                        <Filter className="h-5 w-5" />
                    </button>
                </div>

                {/* フィルターポップアップ */}
                {isFilterOpen && (
                    <>
                        {/* 背景クリックで閉じるためのオーバーレイ */}
                        <div className="fixed inset-0 z-40" onClick={() => setIsFilterOpen(false)} />

                        <div className="absolute left-6 right-6 md:left-auto md:right-6 bottom-full mb-2 md:w-[320px] bg-white p-5 rounded-xl shadow-xl border border-zinc-200 z-50 animate-in fade-in zoom-in-95 duration-200 origin-bottom">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-semibold text-zinc-900">絞り込み検索</h3>
                                <button
                                    onClick={() => setIsFilterOpen(false)}
                                    className="text-zinc-400 hover:text-zinc-600 p-1 rounded-md hover:bg-zinc-100"
                                >
                                    <X className="h-4 w-4" />
                                </button>
                            </div>

                            <div className="space-y-4">
                                {/* 期間フィルター */}
                                <div className="space-y-3">
                                    <div className="space-y-1.5">
                                        <label className="flex items-center gap-1.5 text-xs font-medium text-zinc-700">
                                            <Calendar className="h-3.5 w-3.5" />
                                            開始日
                                        </label>
                                        <input
                                            type="date"
                                            name="startDate"
                                            value={filters.startDate}
                                            onChange={handleFilterChange}
                                            className="block w-full text-sm bg-zinc-50 border-zinc-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-zinc-900"
                                        />
                                    </div>
                                    <div className="space-y-1.5">
                                        <label className="flex items-center gap-1.5 text-xs font-medium text-zinc-700">
                                            <Calendar className="h-3.5 w-3.5" />
                                            終了日
                                        </label>
                                        <input
                                            type="date"
                                            name="endDate"
                                            value={filters.endDate}
                                            onChange={handleFilterChange}
                                            className="block w-full text-sm bg-zinc-50 border-zinc-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-zinc-900"
                                        />
                                    </div>
                                </div>

                                {/* 発信者フィルター */}
                                <div className="space-y-1.5">
                                    <label className="flex items-center gap-1.5 text-xs font-medium text-zinc-700">
                                        <User className="h-3.5 w-3.5" />
                                        発信者
                                    </label>
                                    <select
                                        name="callerNumber"
                                        value={filters.callerNumber}
                                        onChange={handleFilterChange}
                                        className="block w-full text-sm bg-zinc-50 border-zinc-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-zinc-900"
                                    >
                                        <option value="">全ての発信者</option>
                                        {uniqueCallers.map((number) => (
                                            <option key={number} value={number}>
                                                {number}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* アクションボタン */}
                                <div className="pt-2 flex gap-2">
                                    <button
                                        onClick={clearFilters}
                                        disabled={loading}
                                        className="flex-1 flex items-center justify-center gap-1 px-3 py-2 text-sm font-medium text-zinc-600 bg-white border border-zinc-200 hover:bg-zinc-50 rounded-lg transition-all active:scale-[0.96]"
                                    >
                                        クリア
                                    </button>
                                    <button
                                        onClick={applyFilters}
                                        disabled={loading}
                                        className="flex-1 flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm transition-all active:scale-[0.96] disabled:opacity-50"
                                    >
                                        {loading ? <Loader2 className="h-4 w-4 animate-spin" /> : <Search className="h-4 w-4" />}
                                        検索
                                    </button>
                                </div>
                            </div>
                        </div>
                    </>
                )}
            </div>

            {/* リスト表示 */}
            <div className="divide-y divide-zinc-100 bg-white">
                {logs.length === 0 ? (
                    <div className="p-10 text-center text-zinc-500">
                        条件に一致する通話履歴はありません
                    </div>
                ) : (
                    logs.map((log) => {
                        const isExpanded = expandedId === log.id

                        return (
                            <div key={log.id} className="transition-colors">
                                {/* 閉じた状態のリストアイテム */}
                                <button
                                    onClick={() => toggleExpand(log.id)}
                                    className="w-full hover:bg-zinc-50 transition-colors cursor-pointer focus:outline-none focus:bg-zinc-50 active:scale-[0.99]"
                                >
                                    <div className="flex items-center justify-between p-5">
                                        <div className="flex-1 text-left">
                                            {/* 日時と電話番号 */}
                                            <div className="flex items-center gap-3 mb-1.5">
                                                <div className="flex items-center gap-2 text-sm font-medium text-zinc-900">
                                                    <Phone className="h-3.5 w-3.5 text-zinc-400" />
                                                    <span>{formatDate(log.created_at)}</span>
                                                </div>
                                                <span className="text-sm text-zinc-600">
                                                    {log.caller_number || '不明'}
                                                </span>
                                            </div>

                                            {/* 要約 */}
                                            <p className={`text-sm text-zinc-500 ${isExpanded ? '' : 'line-clamp-1'}`}>
                                                {log.summary || '要約なし'}
                                            </p>
                                        </div>

                                        {/* 展開アイコン */}
                                        <ChevronDown
                                            className={`h-5 w-5 text-zinc-400 transition-transform flex-shrink-0 ml-3 ${isExpanded ? 'rotate-180' : ''
                                                }`}
                                        />
                                    </div>
                                </button>

                                {/* 展開時の詳細ビュー */}
                                {isExpanded && (
                                    <div className="px-5 pb-5 pt-2 bg-zinc-50/50 border-t border-zinc-100">

                                        {log.call_sid && (
                                            <div className="mb-3 text-xs text-zinc-500">
                                                <span className="font-medium">Call ID:</span> {log.call_sid}
                                            </div>
                                        )}
                                        <ConversationViewer transcript={log.transcript || []} />
                                    </div>
                                )}
                            </div>
                        )
                    })
                )}
            </div>

            {/* さらに読み込むボタン */}
            {logs.length < count && (
                <div className="p-4 border-t border-zinc-200 bg-zinc-50">
                    <button
                        onClick={handleLoadMore}
                        disabled={loading}
                        className="w-full flex items-center justify-center gap-2 py-2.5 text-sm font-medium text-zinc-600 bg-white border border-zinc-200 rounded-lg hover:bg-zinc-50 hover:text-zinc-900 transition-all active:scale-[0.96] disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? (
                            <>
                                <Loader2 className="h-4 w-4 animate-spin" />
                                読み込み中...
                            </>
                        ) : (
                            'さらに読み込む'
                        )}
                    </button>
                </div>
            )}
        </div>
    )
}

---
---
File: web/src/components/ConversationViewer.tsx
import React from 'react'
import { User, Bot } from 'lucide-react'

export type TranscriptItem = {
    role: 'user' | 'assistant'
    text: string
    timestamp: string
}

interface ConversationViewerProps {
    transcript: TranscriptItem[]
}

export function ConversationViewer({ transcript }: ConversationViewerProps) {
    if (!transcript || transcript.length === 0) {
        return <div className="text-zinc-500 text-sm">会話ログはありません</div>
    }

    return (
        <div className="flex flex-col gap-4 p-4 bg-zinc-50 rounded-lg max-h-[500px] overflow-y-auto">
            {transcript.map((item, index) => {
                const isUser = item.role === 'user'
                const date = new Date(item.timestamp)
                const timeString = date.toLocaleTimeString('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit',
                })

                return (
                    <div
                        key={index}
                        className={`flex items-start gap-3 ${isUser ? 'flex-row' : 'flex-row-reverse'
                            }`}
                    >
                        <div
                            className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isUser ? 'bg-indigo-100 text-indigo-600' : 'bg-emerald-100 text-emerald-600'
                                }`}
                        >
                            {isUser ? <User className="w-5 h-5" /> : <Bot className="w-5 h-5" />}
                        </div>

                        <div
                            className={`flex flex-col max-w-[80%] ${isUser ? 'items-start' : 'items-end'
                                }`}
                        >
                            <div
                                className={`px-4 py-2 rounded-2xl text-sm ${isUser
                                    ? 'bg-white border border-zinc-200 text-zinc-800 rounded-tl-none shadow-sm'
                                    : 'bg-indigo-600 text-white rounded-tr-none'
                                    }`}
                            >
                                {item.text}
                            </div>
                            <span className="text-[10px] text-zinc-400 mt-1 px-1">
                                {timeString}
                            </span>
                        </div>
                    </div>
                )
            })}
        </div>
    )
}

---
---
File: web/src/components/DashboardMetrics.tsx
import { Phone, BarChart3, CreditCard } from 'lucide-react'
import { fetchCallMetrics } from '@/app/dashboard/actions'

export interface DashboardMetricsData {
    totalCalls: number
    totalDurationMinutes: number
    currentMonthBilling: number
}

export function DashboardMetricsView({ metrics }: { metrics: DashboardMetricsData }) {
    return (
        <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-2xl border border-zinc-100 shadow-sm">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-sm font-medium text-zinc-500">今月の着信対応</h3>
                    <Phone className="h-5 w-5 text-indigo-600" />
                </div>
                <div className="text-2xl font-bold text-zinc-900">{metrics.totalCalls}件</div>
                <p className="text-xs text-zinc-500 mt-1">全期間の合計</p>
            </div>
            <div className="bg-white p-6 rounded-2xl border border-zinc-100 shadow-sm">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-sm font-medium text-zinc-500">利用時間</h3>
                    <BarChart3 className="h-5 w-5 text-indigo-600" />
                </div>
                <div className="text-2xl font-bold text-zinc-900">{metrics.totalDurationMinutes.toFixed(1)}分</div>
                <p className="text-xs text-zinc-500 mt-1">残り無料枠: 60分</p>
            </div>
            <div className="bg-white p-6 rounded-2xl border border-zinc-100 shadow-sm">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-sm font-medium text-zinc-500">今月の請求額</h3>
                    <CreditCard className="h-5 w-5 text-indigo-600" />
                </div>
                <div className="text-2xl font-bold text-zinc-900">¥{metrics.currentMonthBilling.toLocaleString()}</div>
                <p className="text-xs text-zinc-500 mt-1">※ 請求計算ロジックは今後実装予定です。</p>
            </div>
        </section>
    )
}

export async function DashboardMetrics() {
    const metrics = await fetchCallMetrics()
    // TODO: 今月の通話時間と料金設定から実際の請求額を計算する
    const metricsWithBilling = {
        ...metrics,
        currentMonthBilling: 0
    }
    return <DashboardMetricsView metrics={metricsWithBilling} />
}

export function DashboardMetricsSkeleton() {
    return (
        <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {[1, 2, 3].map((i) => (
                <div key={i} className="bg-white p-6 rounded-xl border border-zinc-200 shadow-sm animate-pulse">
                    <div className="flex items-center justify-between mb-4">
                        <div className="h-4 w-24 bg-zinc-100 rounded"></div>
                        <div className="h-5 w-5 bg-zinc-100 rounded"></div>
                    </div>
                    <div className="h-8 w-16 bg-zinc-100 rounded mb-2"></div>
                    <div className="h-3 w-32 bg-zinc-100 rounded"></div>
                </div>
            ))}
        </section>
    )
}

---
---
File: web/src/components/DemoCallButton.tsx
'use client'

import { Phone } from 'lucide-react'

interface DemoCallButtonProps {
    onClick: () => void
    disabled?: boolean
}

export function DemoCallButton({ onClick, disabled }: DemoCallButtonProps) {
    return (
        <button
            onClick={onClick}
            disabled={disabled}
            className="group relative w-full flex items-center justify-center gap-3 px-6 py-4 
                       bg-gradient-to-r from-indigo-500 to-purple-600 
                       hover:from-indigo-600 hover:to-purple-700 
                       disabled:from-zinc-400 disabled:to-zinc-500 disabled:cursor-not-allowed
                       text-white font-bold text-lg rounded-2xl 
                       shadow-lg shadow-indigo-500/30 hover:shadow-xl hover:shadow-indigo-500/40
                       transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]
                       overflow-hidden"
        >
            {/* Animated background effect */}
            <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 
                           translate-x-[-100%] group-hover:translate-x-[100%] 
                           transition-transform duration-700" />

            <div className="relative flex items-center gap-3">
                <div className="p-2 bg-white/20 rounded-xl group-hover:scale-110 transition-transform">
                    <Phone className="h-5 w-5" />
                </div>
                <span>試しに電話してみる（体験版）</span>
            </div>

            {/* Pulse effect */}
            <div className="absolute inset-0 rounded-2xl animate-pulse-slow bg-white/5" />
        </button>
    )
}

---
---
File: web/src/components/DemoCallModal.tsx
'use client'

import { useEffect, useState, useCallback, useRef } from 'react'
import { X, Mic, MicOff, PhoneOff, Loader2 } from 'lucide-react'
import { WebCallClient, ConnectionStatus } from '@/lib/webCall/webCallClient'

interface DemoCallModalProps {
    isOpen: boolean
    onClose: () => void
}

interface TranscriptItem {
    id: number
    text: string
    isFinal: boolean
    speaker: 'user' | 'ai'
}

export function DemoCallModal({ isOpen, onClose }: DemoCallModalProps) {
    const [status, setStatus] = useState<ConnectionStatus>('idle')
    const [isMuted, setIsMuted] = useState(false)
    const [transcripts, setTranscripts] = useState<TranscriptItem[]>([])
    const [error, setError] = useState<string | null>(null)
    const [isLoading, setIsLoading] = useState(false)

    const clientRef = useRef<WebCallClient | null>(null)
    const transcriptIdRef = useRef(0)
    const transcriptContainerRef = useRef<HTMLDivElement>(null)

    const handleStatusChange = useCallback((newStatus: ConnectionStatus) => {
        setStatus(newStatus)
    }, [])

    const handleTranscript = useCallback((text: string, isFinal: boolean, speaker: 'user' | 'ai') => {
        setTranscripts(prev => {
            const newItem: TranscriptItem = {
                id: transcriptIdRef.current++,
                text,
                isFinal,
                speaker
            }
            // Keep last 50 items
            const updated = [...prev, newItem].slice(-50)
            return updated
        })
    }, [])

    const handleError = useCallback((errorMessage: string) => {
        setError(errorMessage)
    }, [])

    // Start call when modal opens
    useEffect(() => {
        if (!isOpen) return

        const startCall = async () => {
            setIsLoading(true)
            setError(null)
            setTranscripts([])

            try {
                // Fetch token from API
                const response = await fetch('/api/demo-call/token')
                if (!response.ok) {
                    const data = await response.json()
                    throw new Error(data.error || 'トークンの取得に失敗しました')
                }

                const { token, wsUrl, userId } = await response.json()

                // Create and start client
                clientRef.current = new WebCallClient({
                    onStatusChange: handleStatusChange,
                    onTranscript: handleTranscript,
                    onError: handleError
                })

                await clientRef.current.start(wsUrl, token, userId)
            } catch (err) {
                console.error('Failed to start call:', err)
                setError(err instanceof Error ? err.message : '通話の開始に失敗しました')
                setStatus('error')
            } finally {
                setIsLoading(false)
            }
        }

        startCall()

        return () => {
            if (clientRef.current) {
                clientRef.current.stop()
                clientRef.current = null
            }
        }
    }, [isOpen, handleStatusChange, handleTranscript, handleError])

    // Auto-scroll transcript
    useEffect(() => {
        if (transcriptContainerRef.current) {
            transcriptContainerRef.current.scrollTop = transcriptContainerRef.current.scrollHeight
        }
    }, [transcripts])

    const handleMuteToggle = () => {
        if (clientRef.current) {
            const newMuteState = clientRef.current.toggleMute()
            setIsMuted(newMuteState)
        }
    }

    const handleEndCall = () => {
        if (clientRef.current) {
            clientRef.current.stop()
        }
        onClose()
    }

    if (!isOpen) return null

    const getStatusDisplay = () => {
        switch (status) {
            case 'connecting':
                return { text: '接続中...', color: 'text-yellow-500', bg: 'bg-yellow-500/20' }
            case 'connected':
                return { text: '接続済み', color: 'text-green-500', bg: 'bg-green-500/20' }
            case 'disconnected':
                return { text: '切断されました', color: 'text-zinc-500', bg: 'bg-zinc-500/20' }
            case 'error':
                return { text: 'エラー', color: 'text-red-500', bg: 'bg-red-500/20' }
            default:
                return { text: '待機中', color: 'text-zinc-400', bg: 'bg-zinc-400/20' }
        }
    }

    const statusInfo = getStatusDisplay()

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            {/* Backdrop */}
            <div
                className="absolute inset-0 bg-black/60 backdrop-blur-sm"
                onClick={handleEndCall}
            />

            {/* Modal */}
            <div className="relative w-full max-w-md bg-zinc-900 rounded-3xl shadow-2xl overflow-hidden">
                {/* Header */}
                <div className="relative px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600">
                    <div className="flex items-center justify-between">
                        <h2 className="text-lg font-bold text-white">体験通話</h2>
                        <button
                            onClick={handleEndCall}
                            className="p-2 text-white/80 hover:text-white hover:bg-white/10 rounded-full transition-colors"
                        >
                            <X className="h-5 w-5" />
                        </button>
                    </div>

                    {/* Status indicator */}
                    <div className="mt-2 flex items-center gap-2">
                        <div className={`flex items-center gap-2 px-3 py-1 rounded-full ${statusInfo.bg}`}>
                            {status === 'connecting' && (
                                <Loader2 className={`h-3 w-3 animate-spin ${statusInfo.color}`} />
                            )}
                            {status === 'connected' && (
                                <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse" />
                            )}
                            <span className={`text-xs font-medium ${statusInfo.color}`}>
                                {statusInfo.text}
                            </span>
                        </div>
                        {isMuted && (
                            <div className="flex items-center gap-1 px-2 py-1 rounded-full bg-red-500/20 text-red-400">
                                <MicOff className="h-3 w-3" />
                                <span className="text-xs">ミュート中</span>
                            </div>
                        )}
                    </div>
                </div>

                {/* Error message */}
                {error && (
                    <div className="mx-6 mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-xl">
                        <p className="text-sm text-red-400">{error}</p>
                    </div>
                )}

                {/* Transcript area */}
                <div
                    ref={transcriptContainerRef}
                    className="h-64 mx-6 mt-4 p-4 bg-zinc-800/50 rounded-xl overflow-y-auto 
                               scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent"
                >
                    {transcripts.length === 0 ? (
                        <div className="h-full flex items-center justify-center text-zinc-500 text-sm">
                            {isLoading ? (
                                <div className="flex items-center gap-2">
                                    <Loader2 className="h-4 w-4 animate-spin" />
                                    <span>接続しています...</span>
                                </div>
                            ) : status === 'connected' ? (
                                <span>お待ちください...</span>
                            ) : (
                                <span>会話履歴がここに表示されます</span>
                            )}
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {transcripts.map((item) => (
                                <div
                                    key={item.id}
                                    className={`p-3 rounded-xl text-sm ${item.speaker === 'ai'
                                        ? 'bg-indigo-500/20 text-indigo-100'
                                        : 'bg-zinc-700/50 text-zinc-200'
                                        } ${!item.isFinal ? 'opacity-70' : ''}`}
                                >
                                    <p>{item.text}</p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Controls */}
                <div className="p-6 flex items-center justify-center gap-6">
                    {/* Mute button */}
                    <button
                        onClick={handleMuteToggle}
                        disabled={status !== 'connected'}
                        className={`p-4 rounded-full transition-all duration-200 
                                   ${isMuted
                                ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30'
                                : 'bg-zinc-700/50 text-white hover:bg-zinc-700'
                            } disabled:opacity-50 disabled:cursor-not-allowed`}
                    >
                        {isMuted ? (
                            <MicOff className="h-6 w-6" />
                        ) : (
                            <Mic className="h-6 w-6" />
                        )}
                    </button>

                    {/* End call button */}
                    <button
                        onClick={handleEndCall}
                        className="p-5 bg-red-500 hover:bg-red-600 text-white rounded-full 
                                   shadow-lg shadow-red-500/30 hover:shadow-red-500/50
                                   transition-all duration-200 transform hover:scale-105 active:scale-95"
                    >
                        <PhoneOff className="h-7 w-7" />
                    </button>
                </div>

                {/* Hint text */}
                <div className="px-6 pb-4 text-center">
                    <p className="text-xs text-zinc-500">
                        これは体験版です。実際の電話回線は使用しません。
                    </p>
                </div>
            </div>
        </div>
    )
}

---
---
File: web/src/components/Footer.tsx
'use client'

import Link from 'next/link'

export default function Footer() {
    return (
        <footer className="bg-white border-t border-gray-200 mt-auto">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div className="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                    {/* Copyright */}
                    <div className="text-sm text-gray-500">
                        © 2025 AiLuna. All rights reserved.
                    </div>

                    {/* Links */}
                    <div className="flex space-x-6">
                        <Link
                            href="/terms"
                            className="text-sm text-gray-600 hover:text-indigo-600 transition-colors"
                        >
                            利用規約
                        </Link>
                        <Link
                            href="/privacy"
                            className="text-sm text-gray-600 hover:text-indigo-600 transition-colors"
                        >
                            プライバシーポリシー
                        </Link>
                    </div>
                </div>
            </div>
        </footer>
    )
}

---
---
File: web/src/components/Header.tsx
'use client'

import Link from 'next/link'
import { Phone } from 'lucide-react'

export default function Header() {
    return (
        <header className="py-6 px-4 sm:px-6 lg:px-8">
            <div className="max-w-7xl mx-auto flex justify-between items-center">
                {/* Logo */}
                <Link href="/" className="flex items-center space-x-2 hover:opacity-80 transition-opacity">
                    <div className="bg-indigo-600 p-2 rounded-lg">
                        <Phone className="h-6 w-6 text-white" />
                    </div>
                    <span className="text-2xl font-bold text-gray-900">AiLuna</span>
                </Link>

                {/* Auth Buttons */}
                <div className="flex items-center space-x-3">
                    <Link
                        href="/login?mode=login"
                        className="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors"
                    >
                        ログイン
                    </Link>
                    <Link
                        href="/login?mode=signup"
                        className="px-6 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm transition-all active:scale-[0.96]"
                    >
                        無料で始める
                    </Link>
                </div>
            </div>
        </header>
    )
}

---
---
File: web/src/components/UserProfileChip.tsx
import { User, Phone } from 'lucide-react'

type UserProfileChipProps = {
    accountName?: string | null
    phoneNumber?: string | null
    planName?: string
    className?: string
}

export function UserProfileChip({ accountName, phoneNumber, planName = 'Free', className = '' }: UserProfileChipProps) {
    const displayAccountName = accountName || '未設定'
    const displayPhoneNumber = phoneNumber || '未登録'

    return (
        <div className={`flex items-center gap-3 ${className}`}>
            <div className="flex flex-col items-end">
                <div className="flex items-center gap-2">
                    <span className="text-sm font-bold text-zinc-900 max-w-[100px] truncate">
                        {displayAccountName}
                    </span>
                    <span className="px-1.5 py-0.5 text-[10px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 rounded-full uppercase tracking-wider">
                        {planName}
                    </span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-zinc-500">
                    <Phone className="h-3 w-3" />
                    <span>{displayPhoneNumber}</span>
                </div>
            </div>

            <div className="h-8 w-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-sm ring-2 ring-white">
                <User className="h-4 w-4" />
            </div>
        </div>
    )
}

---
---
File: web/src/lib/audio/audioContext.ts
/**
 * AudioContext utilities for microphone access
 */

let audioContext: AudioContext | null = null

/**
 * Get or create AudioContext instance
 */
export function getAudioContext(): AudioContext {
    if (!audioContext) {
        audioContext = new AudioContext()
    }
    return audioContext
}

/**
 * Resume AudioContext (required after user gesture)
 */
export async function resumeAudioContext(): Promise<void> {
    const ctx = getAudioContext()
    if (ctx.state === 'suspended') {
        await ctx.resume()
    }
}

/**
 * Request microphone access and return MediaStream
 */
export async function getMicrophoneStream(): Promise<MediaStream> {
    return navigator.mediaDevices.getUserMedia({
        audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
        },
        video: false
    })
}

/**
 * Close AudioContext
 */
export function closeAudioContext(): void {
    if (audioContext) {
        audioContext.close()
        audioContext = null
    }
}

---
---
File: web/src/lib/audio/audioPlayer.ts
/**
 * Audio player for received μ-law audio with mark/clear support
 * Twilio Media Streams compatible
 */

import { decodeUlaw } from './g711'
import { int16ToFloat32 } from './resampler'
import { getAudioContext } from './audioContext'

interface ScheduledBuffer {
    source: AudioBufferSourceNode
    startTime: number
    duration: number
    markName?: string
}

export interface AudioPlayerOptions {
    onMarkPlayed?: (markName: string) => void
}

export class AudioPlayer {
    private isPlaying = false
    private scheduledTime = 0
    private readonly targetSampleRate = 8000
    private scheduledBuffers: ScheduledBuffer[] = []
    private checkInterval: ReturnType<typeof setInterval> | null = null
    private options: AudioPlayerOptions

    constructor(options: AudioPlayerOptions = {}) {
        this.options = options
        this.scheduledTime = 0
    }

    /**
     * Play μ-law encoded audio data
     * @param ulawBase64 Base64 encoded μ-law audio
     * @param markName Optional mark name to track when this audio completes
     */
    playUlawBase64(ulawBase64: string, markName?: string): void {
        try {
            // Decode base64 to bytes
            const binaryString = atob(ulawBase64)
            const bytes = new Uint8Array(binaryString.length)
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i)
            }

            // Decode μ-law to linear PCM
            const pcmInt16 = decodeUlaw(bytes)
            const pcmFloat32 = int16ToFloat32(pcmInt16)

            // Play audio
            this.playFloat32(pcmFloat32, markName)
        } catch (error) {
            console.error('Error playing audio:', error)
        }
    }

    /**
     * Queue a mark to be returned when current audio completes
     */
    queueMark(markName: string): void {
        const ctx = getAudioContext()
        // Mark will fire when all currently scheduled audio completes
        const markBuffer: ScheduledBuffer = {
            source: ctx.createBufferSource(), // Dummy source, won't be played
            startTime: this.scheduledTime,
            duration: 0,
            markName
        }
        this.scheduledBuffers.push(markBuffer)
        this.startCheckInterval()
    }

    /**
     * Clear all scheduled audio immediately (barge-in support)
     */
    clear(): void {
        // Stop all scheduled sources
        for (const buffer of this.scheduledBuffers) {
            try {
                buffer.source.stop()
            } catch {
                // Source may not have started yet
            }
        }
        this.scheduledBuffers = []

        // Reset scheduling
        this.isPlaying = false
        this.scheduledTime = 0

        // Stop check interval
        if (this.checkInterval) {
            clearInterval(this.checkInterval)
            this.checkInterval = null
        }
    }

    /**
     * Play Float32Array audio samples at 8kHz
     */
    private playFloat32(samples: Float32Array, markName?: string): void {
        const ctx = getAudioContext()

        // Create audio buffer at 8kHz
        const audioBuffer = ctx.createBuffer(1, samples.length, this.targetSampleRate)

        // Copy samples to the audio buffer channel
        const channelData = audioBuffer.getChannelData(0)
        channelData.set(samples)

        // Create buffer source
        const source = ctx.createBufferSource()
        source.buffer = audioBuffer
        source.connect(ctx.destination)

        // Schedule playback
        if (!this.isPlaying || this.scheduledTime < ctx.currentTime) {
            this.scheduledTime = ctx.currentTime
            this.isPlaying = true
        }

        const startTime = this.scheduledTime
        source.start(startTime)
        this.scheduledTime += audioBuffer.duration

        // Track scheduled buffer
        this.scheduledBuffers.push({
            source,
            startTime,
            duration: audioBuffer.duration,
            markName
        })

        // Start checking for completed buffers
        this.startCheckInterval()
    }

    private startCheckInterval(): void {
        if (this.checkInterval) return

        this.checkInterval = setInterval(() => {
            this.checkCompletedBuffers()
        }, 50) // Check every 50ms
    }

    private checkCompletedBuffers(): void {
        const ctx = getAudioContext()
        const currentTime = ctx.currentTime

        // Find completed buffers
        const completed: ScheduledBuffer[] = []
        this.scheduledBuffers = this.scheduledBuffers.filter(buffer => {
            const endTime = buffer.startTime + buffer.duration
            if (currentTime >= endTime) {
                completed.push(buffer)
                return false
            }
            return true
        })

        // Fire mark callbacks for completed buffers
        for (const buffer of completed) {
            if (buffer.markName && this.options.onMarkPlayed) {
                this.options.onMarkPlayed(buffer.markName)
            }
        }

        // Stop interval if no more buffers
        if (this.scheduledBuffers.length === 0 && this.checkInterval) {
            clearInterval(this.checkInterval)
            this.checkInterval = null
            this.isPlaying = false
        }
    }

    /**
     * Stop playback and reset state
     */
    stop(): void {
        this.clear()
    }
}

---
---
File: web/src/lib/audio/g711.ts
/**
 * G.711 μ-law (mu-law) codec implementation
 * Used for telephony audio encoding/decoding
 */

// μ-law compression parameters
const ULAW_BIAS = 0x84
const ULAW_CLIP = 32635

// Segment encoding table
const SEG_END = [0xFF, 0x1FF, 0x3FF, 0x7FF, 0xFFF, 0x1FFF, 0x3FFF, 0x7FFF]

/**
 * Encode a single 16-bit linear sample to 8-bit μ-law
 */
function linearToUlaw(sample: number): number {
    let sign = 0
    let exponent = 0
    let mantissa = 0
    let ulawByte = 0

    // Get the sign and magnitude
    if (sample < 0) {
        sign = 0x80
        sample = -sample
    }

    // Clip the sample
    if (sample > ULAW_CLIP) {
        sample = ULAW_CLIP
    }

    // Add bias
    sample += ULAW_BIAS

    // Find segment number
    for (exponent = 0; exponent < 8; exponent++) {
        if (sample <= SEG_END[exponent]) {
            break
        }
    }

    // Combine sign, segment, and quantization
    if (exponent >= 8) {
        ulawByte = 0x7F ^ sign
    } else {
        mantissa = (sample >> (exponent + 3)) & 0x0F
        ulawByte = ~(sign | (exponent << 4) | mantissa) & 0xFF
    }

    return ulawByte
}

/**
 * Decode a single 8-bit μ-law sample to 16-bit linear
 */
function ulawToLinear(ulawByte: number): number {
    // Complement to obtain sign + segment
    ulawByte = ~ulawByte & 0xFF

    const sign = (ulawByte & 0x80) !== 0
    const exponent = (ulawByte >> 4) & 0x07
    const mantissa = ulawByte & 0x0F

    // Compute magnitude
    let sample = ((mantissa << 3) + ULAW_BIAS) << exponent
    sample -= ULAW_BIAS

    return sign ? -sample : sample
}

/**
 * Encode Int16Array to μ-law encoded Uint8Array
 */
export function encodeUlaw(samples: Int16Array): Uint8Array {
    const output = new Uint8Array(samples.length)
    for (let i = 0; i < samples.length; i++) {
        output[i] = linearToUlaw(samples[i])
    }
    return output
}

/**
 * Decode μ-law encoded Uint8Array to Int16Array
 */
export function decodeUlaw(bytes: Uint8Array): Int16Array {
    const output = new Int16Array(bytes.length)
    for (let i = 0; i < bytes.length; i++) {
        output[i] = ulawToLinear(bytes[i])
    }
    return output
}

---
---
File: web/src/lib/audio/resampler.ts
/**
 * Audio resampling utilities
 * Resample from browser native sample rate (typically 48kHz) to 8kHz for telephony
 */

/**
 * Resample Float32Array audio data from source to target sample rate
 * Uses linear interpolation for simplicity (MVP)
 */
export function resample(
    inputSamples: Float32Array,
    inputSampleRate: number,
    outputSampleRate: number
): Float32Array {
    if (inputSampleRate === outputSampleRate) {
        return inputSamples
    }

    const ratio = inputSampleRate / outputSampleRate
    const outputLength = Math.ceil(inputSamples.length / ratio)
    const output = new Float32Array(outputLength)

    for (let i = 0; i < outputLength; i++) {
        const srcIndex = i * ratio
        const srcIndexFloor = Math.floor(srcIndex)
        const srcIndexCeil = Math.min(srcIndexFloor + 1, inputSamples.length - 1)
        const fraction = srcIndex - srcIndexFloor

        // Linear interpolation
        output[i] = inputSamples[srcIndexFloor] * (1 - fraction) +
            inputSamples[srcIndexCeil] * fraction
    }

    return output
}

/**
 * Convert Float32Array (-1.0 to 1.0) to Int16Array (-32768 to 32767)
 */
export function float32ToInt16(samples: Float32Array): Int16Array {
    const output = new Int16Array(samples.length)
    for (let i = 0; i < samples.length; i++) {
        // Clamp to [-1, 1] range
        const s = Math.max(-1, Math.min(1, samples[i]))
        output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF
    }
    return output
}

/**
 * Convert Int16Array to Float32Array
 */
export function int16ToFloat32(samples: Int16Array): Float32Array {
    const output = new Float32Array(samples.length)
    for (let i = 0; i < samples.length; i++) {
        output[i] = samples[i] / 0x8000
    }
    return output
}

---
---
File: web/src/lib/prompts/index.ts
/**
 * System Prompts Module
 *
 * Central export point for all system prompts used throughout the AiLuna application.
 * This module provides organized access to prompts for various AI interactions.
 *
 * Note: Builder-related prompts (setupConcierge, configBuilder, configParser)
 * have been removed as the conversational setup feature was deprecated.
 */

// No exports - builder prompts removed

---
---
File: web/src/lib/webCall/webCallClient.ts
/**
 * WebSocket client for browser-based voice calls
 * Twilio Media Streams compatible
 */

import { getMicrophoneStream, resumeAudioContext, getAudioContext } from '../audio/audioContext'
import { resample, float32ToInt16 } from '../audio/resampler'
import { encodeUlaw } from '../audio/g711'
import { AudioPlayer } from '../audio/audioPlayer'

export type ConnectionStatus = 'idle' | 'connecting' | 'connected' | 'disconnected' | 'error'

export interface WebCallClientOptions {
    onStatusChange?: (status: ConnectionStatus) => void
    onTranscript?: (text: string, isFinal: boolean, speaker: 'user' | 'ai') => void
    onError?: (error: string) => void
    onCallEnded?: () => void
}

/**
 * Generate a UUID v4
 */
function generateUUID(): string {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = (Math.random() * 16) | 0
        const v = c === 'x' ? r : (r & 0x3) | 0x8
        return v.toString(16)
    })
}

export class WebCallClient {
    private ws: WebSocket | null = null
    private mediaStream: MediaStream | null = null
    private scriptProcessor: ScriptProcessorNode | null = null
    private audioPlayer: AudioPlayer | null = null
    private isMuted = false
    private status: ConnectionStatus = 'idle'

    private readonly sampleRate = 8000
    private readonly chunkMs = 20
    private readonly samplesPerChunk: number

    private streamSid: string = ''
    private callSid: string = ''
    private options: WebCallClientOptions

    constructor(options: WebCallClientOptions = {}) {
        this.options = options
        this.samplesPerChunk = (this.sampleRate * this.chunkMs) / 1000 // 160 samples at 8kHz
    }

    /**
     * Start a web call session with an already-acquired MediaStream
     * This is the preferred method for iOS compatibility - getUserMedia should be called
     * FIRST in the click handler before any async operations
     */
    async startWithStream(
        stream: MediaStream,
        wsUrl: string,
        token: string,
        userId: string
    ): Promise<void> {
        if (this.status !== 'idle' && this.status !== 'disconnected' && this.status !== 'error') {
            console.warn('[WebCallClient] Call already in progress')
            return
        }

        console.log('[WebCallClient] Starting with pre-acquired stream')
        this.setStatus('connecting')

        // Generate UUIDs for streamSid and callSid (client-side)
        this.streamSid = generateUUID()
        this.callSid = generateUUID()

        try {
            // Use the provided stream
            this.mediaStream = stream

            // Resume AudioContext (required for audio playback)
            console.log('[WebCallClient] Resuming AudioContext...')
            await resumeAudioContext()
            console.log('[WebCallClient] AudioContext resumed')

            // Connect to WebSocket with token
            const wsUrlWithToken = `${wsUrl}?token=${encodeURIComponent(token)}`
            console.log('[WebCallClient] Connecting to WebSocket...')
            this.ws = new WebSocket(wsUrlWithToken)

            this.ws.onopen = () => {
                console.log('[WebCallClient] WebSocket connected')
                // Send start event (Twilio Media Streams format)
                this.ws?.send(JSON.stringify({
                    event: 'start',
                    start: {
                        streamSid: this.streamSid,
                        callSid: this.callSid,
                        customParameters: {
                            userId
                        }
                    }
                }))
                this.setStatus('connected')

                // Start audio capture
                this.startAudioCapture()
            }

            this.ws.onmessage = (event) => {
                this.handleMessage(event.data)
            }

            this.ws.onerror = (error) => {
                console.error('[WebCallClient] WebSocket error:', error)
                this.options.onError?.('接続エラーが発生しました')
                this.setStatus('error')
            }

            this.ws.onclose = (event) => {
                console.log('[WebCallClient] WebSocket closed:', event.code, event.reason)
                if (this.status === 'connected' || this.status === 'connecting') {
                    this.setStatus('disconnected')
                    this.options.onCallEnded?.()
                }
                this.cleanup()
            }

            // Initialize audio player with mark callback
            this.audioPlayer = new AudioPlayer({
                onMarkPlayed: (markName) => {
                    // Send mark back to server when audio completes
                    this.sendMark(markName)
                }
            })

        } catch (error) {
            console.error('[WebCallClient] Failed to start call:', error)
            this.options.onError?.('通話の開始に失敗しました')
            this.setStatus('error')
            this.cleanup()
        }
    }

    /**
     * Start a web call session (legacy method)
     * WARNING: On iOS, this may fail because getUserMedia is called after async operations,
     * breaking the user gesture context. Use startWithStream() instead.
     */
    async start(wsUrl: string, token: string, userId: string): Promise<void> {
        if (this.status !== 'idle' && this.status !== 'disconnected' && this.status !== 'error') {
            console.warn('Call already in progress')
            return
        }

        this.setStatus('connecting')

        // Generate UUIDs for streamSid and callSid (client-side)
        this.streamSid = generateUUID()
        this.callSid = generateUUID()

        try {
            // Resume AudioContext (required after user gesture)
            await resumeAudioContext()

            // Request microphone access
            this.mediaStream = await getMicrophoneStream()

            // Connect to WebSocket with token
            const wsUrlWithToken = `${wsUrl}?token=${encodeURIComponent(token)}`
            this.ws = new WebSocket(wsUrlWithToken)

            this.ws.onopen = () => {
                // Send start event (Twilio Media Streams format)
                this.ws?.send(JSON.stringify({
                    event: 'start',
                    start: {
                        streamSid: this.streamSid,
                        callSid: this.callSid,
                        customParameters: {
                            userId
                        }
                    }
                }))
                this.setStatus('connected')

                // Start audio capture
                this.startAudioCapture()
            }

            this.ws.onmessage = (event) => {
                this.handleMessage(event.data)
            }

            this.ws.onerror = (error) => {
                console.error('WebSocket error:', error)
                this.options.onError?.('接続エラーが発生しました')
                this.setStatus('error')
            }

            this.ws.onclose = () => {
                if (this.status === 'connected' || this.status === 'connecting') {
                    this.setStatus('disconnected')
                    this.options.onCallEnded?.()
                }
                this.cleanup()
            }

            // Initialize audio player with mark callback
            this.audioPlayer = new AudioPlayer({
                onMarkPlayed: (markName) => {
                    // Send mark back to server when audio completes
                    this.sendMark(markName)
                }
            })

        } catch (error) {
            console.error('Failed to start call:', error)
            if (error instanceof DOMException && error.name === 'NotAllowedError') {
                this.options.onError?.('マイクへのアクセスが許可されていません')
            } else {
                this.options.onError?.('通話の開始に失敗しました')
            }
            this.setStatus('error')
            this.cleanup()
        }
    }

    /**
     * End the call
     */
    stop(): void {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            // Send stop event (Twilio Media Streams format)
            this.ws.send(JSON.stringify({
                event: 'stop',
                streamSid: this.streamSid,
                stop: {
                    callSid: this.callSid
                }
            }))
            this.ws.close()
        }
        this.cleanup()
        this.setStatus('disconnected')
        this.options.onCallEnded?.()
    }

    /**
     * Toggle mute state
     */
    toggleMute(): boolean {
        this.isMuted = !this.isMuted
        return this.isMuted
    }

    /**
     * Get current mute state
     */
    getMuteState(): boolean {
        return this.isMuted
    }

    /**
     * Get current connection status
     */
    getStatus(): ConnectionStatus {
        return this.status
    }

    /**
     * Get stream IDs
     */
    getStreamInfo(): { streamSid: string; callSid: string } {
        return { streamSid: this.streamSid, callSid: this.callSid }
    }

    private setStatus(status: ConnectionStatus): void {
        this.status = status
        this.options.onStatusChange?.(status)
    }

    private sendMark(markName: string): void {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({
                event: 'mark',
                streamSid: this.streamSid,
                mark: {
                    name: markName
                }
            }))
        }
    }

    private handleMessage(data: string): void {
        try {
            const message = JSON.parse(data)

            switch (message.event) {
                case 'media':
                    // Play received audio (Twilio format: media.payload)
                    if (message.media?.payload && this.audioPlayer) {
                        this.audioPlayer.playUlawBase64(message.media.payload)
                    }
                    break

                case 'mark':
                    // Server sent a mark - queue it to be returned when audio completes
                    if (message.mark?.name && this.audioPlayer) {
                        this.audioPlayer.queueMark(message.mark.name)
                    }
                    break

                case 'clear':
                    // Clear audio queue (barge-in)
                    if (this.audioPlayer) {
                        this.audioPlayer.clear()
                    }
                    break

                case 'transcript':
                    // Handle transcript update (custom extension)
                    this.options.onTranscript?.(
                        message.text || '',
                        message.isFinal ?? false,
                        message.speaker === 'user' ? 'user' : 'ai'
                    )
                    break

                case 'error':
                    console.error('Server error:', message.message)
                    this.options.onError?.(message.message || 'サーバーエラーが発生しました')
                    break

                case 'stop':
                    // Server requested stop
                    this.stop()
                    break

                default:
                    console.log('Unknown event type:', message.event)
            }
        } catch (error) {
            console.error('Failed to parse message:', error)
        }
    }

    private startAudioCapture(): void {
        if (!this.mediaStream) return

        const ctx = getAudioContext()
        const source = ctx.createMediaStreamSource(this.mediaStream)

        // Use ScriptProcessorNode for MVP (AudioWorklet would be better but more complex)
        const bufferSize = 4096
        this.scriptProcessor = ctx.createScriptProcessor(bufferSize, 1, 1)

        // Accumulator for chunks
        let accumulatedSamples = new Float32Array(0)

        this.scriptProcessor.onaudioprocess = (event) => {
            if (this.isMuted || !this.ws || this.ws.readyState !== WebSocket.OPEN) {
                return
            }

            const inputData = event.inputBuffer.getChannelData(0)

            // Resample to 8kHz
            const resampled = resample(inputData, ctx.sampleRate, this.sampleRate)

            // Accumulate samples
            const newAccumulated = new Float32Array(accumulatedSamples.length + resampled.length)
            newAccumulated.set(accumulatedSamples)
            newAccumulated.set(resampled, accumulatedSamples.length)
            accumulatedSamples = newAccumulated

            // Send 20ms chunks (160 samples at 8kHz)
            while (accumulatedSamples.length >= this.samplesPerChunk) {
                const chunk = accumulatedSamples.slice(0, this.samplesPerChunk)
                accumulatedSamples = accumulatedSamples.slice(this.samplesPerChunk)

                // Convert to Int16 and encode as μ-law
                const int16Chunk = float32ToInt16(chunk)
                const ulawChunk = encodeUlaw(int16Chunk)

                // Convert to base64
                const base64 = btoa(String.fromCharCode(...ulawChunk))

                // Send media message (Twilio Media Streams format)
                this.ws?.send(JSON.stringify({
                    event: 'media',
                    streamSid: this.streamSid,
                    media: {
                        payload: base64
                    }
                }))
            }
        }

        source.connect(this.scriptProcessor)
        this.scriptProcessor.connect(ctx.destination) // Required for ScriptProcessorNode to work
    }

    private cleanup(): void {
        // Stop audio capture
        if (this.scriptProcessor) {
            this.scriptProcessor.disconnect()
            this.scriptProcessor = null
        }

        // Stop audio player
        if (this.audioPlayer) {
            this.audioPlayer.stop()
            this.audioPlayer = null
        }

        // Stop media stream
        if (this.mediaStream) {
            this.mediaStream.getTracks().forEach(track => track.stop())
            this.mediaStream = null
        }

        // Reset WebSocket
        this.ws = null

        // Reset mute state
        this.isMuted = false
    }
}

---
---
File: web/src/middleware.ts
import { type NextRequest } from 'next/server'
import { updateSession } from '@/utils/supabase/middleware'

export async function middleware(request: NextRequest) {
    return await updateSession(request)
}

export const config = {
    matcher: [
        /*
         * 以下のパスで始まるものを除くすべてのリクエストパスに一致させます:
         * - _next/static (静的ファイル)
         * - _next/image (画像最適化ファイル)
         * - favicon.ico (ファビコンファイル)
         * 必要に応じてこのパターンを変更して、より多くのパスを含めることができます。
         */
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
    ],
}

---
---
File: web/src/types/agent.ts
/**
 * AI電話番の設定メタデータ
 * プレビュー画面のVisualタブで表示される情報を格納します。
 */
export interface ConfigMetadata {
    /** AIの口調・トーン（丁寧/フレンドリー/カジュアル） */
    tone?: 'polite' | 'friendly' | 'casual'
    /** 電話応対時の第一声の挨拶メッセージ（予約確認の問いかけ込み） */
    greeting_message: string
    /** ビジネスの説明文（例：「居酒屋のAI電話番」） */
    business_description: string
    /** 電話応対時の重要なルール（箇条書き） */
    rules: string[]
    /** 業種（例：「居酒屋」「美容院」「歯科医院」） */
    business_type?: string
    /** SMS通知テンプレート */
    sms_templates?: {
        approved: string
        rejected: string
    }
}

/**
 * AI電話番の完全な設定
 * Setup Conciergeで生成され、プレビュー画面に表示される単一の設定オブジェクトです。
 * 
 * 注意: この型は「現在の1つの設定」のみを表します。
 * 過去バージョンとの比較や before/after の機能は意図的に含まれていません。
 */
export interface AgentSettings {
    /** AI電話番として振る舞うための完全なシステムプロンプト（LLMに渡される指示書） */
    system_prompt: string
    /** プレビュー表示用のメタデータ（Visualタブで使用） */
    config_metadata: ConfigMetadata
}

---
---
File: web/src/utils/stripe/server.ts
import Stripe from 'stripe';

let stripeInstance: Stripe | null = null;

export const getStripe = (): Stripe => {
    if (!process.env.STRIPE_SECRET_KEY) {
        throw new Error('STRIPE_SECRET_KEY is missing. Please set it in your .env.local file.');
    }

    if (!stripeInstance) {
        stripeInstance = new Stripe(process.env.STRIPE_SECRET_KEY, {
            apiVersion: '2025-11-17.clover' as any,
            typescript: true,
        });
    }

    return stripeInstance;
};

// For backward compatibility
export const stripe = new Proxy({} as Stripe, {
    get: (target, prop) => {
        const stripeClient = getStripe();
        return (stripeClient as any)[prop];
    }
});

---
---
File: web/src/utils/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

---
---
File: web/src/utils/supabase/middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
    let supabaseResponse = NextResponse.next({
        request,
    })

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return request.cookies.getAll()
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        request.cookies.set(name, value)
                    )
                    supabaseResponse = NextResponse.next({
                        request,
                    })
                    cookiesToSet.forEach(({ name, value, options }) =>
                        supabaseResponse.cookies.set(name, value, options)
                    )
                },
            },
        }
    )

    // 重要: createServerClient と supabase.auth.getUser() の間にロジックを記述することは避けてください。
    // 単純なミスでも、ユーザーがランダムにログアウトされる問題のデバッグが非常に困難になる可能性があります。

    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (
        !user &&
        !request.nextUrl.pathname.startsWith('/login') &&
        !request.nextUrl.pathname.startsWith('/auth') &&
        request.nextUrl.pathname !== '/'
    ) {
        // ユーザーが存在しない場合、LP（トップページ）にリダイレクトします
        const url = request.nextUrl.clone()
        url.pathname = '/'
        return NextResponse.redirect(url)
    }

    // 重要: supabaseResponse オブジェクトはそのまま返す必要があります。
    // NextResponse.next() で新しい Response オブジェクトを作成する場合は、以下の点に注意してください：
    // 1. 次のようにリクエストを渡します:
    //    const myNewResponse = NextResponse.next({ request })
    // 2. 次のようにクッキーをコピーします:
    //    myNewResponse.cookies.setAll(supabaseResponse.cookies.getAll())
    // 3. myNewResponse オブジェクトを必要に応じて変更しますが、クッキーは変更しないでください！
    // 4. 最後に:
    //    return myNewResponse
    // これが行われない場合、ブラウザとサーバーの同期がずれ、ユーザーのセッションが早期に終了する可能性があります！

    return supabaseResponse
}

---
---
File: web/src/utils/supabase/server.ts
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll()
                },
                setAll(cookiesToSet) {
                    try {
                        cookiesToSet.forEach(({ name, value, options }) =>
                            cookieStore.set(name, value, options)
                        )
                    } catch (error) {
                        console.error('Cookie set error:', error)
                        // `setAll` メソッドはサーバーコンポーネントから呼び出されました。
                        // ユーザーセッションをリフレッシュするミドルウェアがある場合、
                        // これは無視できます。
                    }
                },
            },
        }
    )
}

export async function createAdminClient() {
    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!,
        {
            cookies: {
                getAll() {
                    return []
                },
                setAll(cookiesToSet) {
                    // Start of Selection
                },
            },
        }
    )
}

---
---
File: web/src/utils/twilio.ts
import twilio from 'twilio'

const accountSid = process.env.TWILIO_ACCOUNT_SID
const authToken = process.env.TWILIO_AUTH_TOKEN
const messagingServiceSid = process.env.TWILIO_MESSAGING_SERVICE_SID

export async function sendSMS(to: string, body: string, from?: string) {
    if (!accountSid || !authToken) {
        console.warn('Twilio credentials are missing in environment variables.')
        return null
    }

    try {
        const client = twilio(accountSid, authToken)
        const messageOption: any = {
            body,
            to,
        }

        // if 'from' is provided (and is a valid number), use it.
        // otherwise use Messaging Service SID if available.
        if (from) {
            messageOption.from = from
        } else if (messagingServiceSid) {
            messageOption.messagingServiceSid = messagingServiceSid
        } else {
            console.warn('No "from" number or Messaging Service SID configured for Twilio.')
            // proceeding might fail if no default is set in Twilio console, but we try
        }

        const message = await client.messages.create(messageOption)
        console.log('SMS sent successfully:', message.sid)
        return message
    } catch (error) {
        console.error('Error sending SMS:', error)
        // We throw error so caller can know it failed, or we can return null.
        // Requirement said: "Fail DB update? Recommendation: Sustain DB update, show error in UI"
        // So we might want to just return failure info or throw and catch in action.
        throw error
    }
}

---
---
File: web/package.json
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "summary": "node scripts/generate_summary.js",
    "backup": "node scripts/backup.js"
  },
  "dependencies": {
    "@supabase/auth-ui-react": "^0.4.7",
    "@supabase/auth-ui-shared": "^0.1.8",
    "@supabase/ssr": "^0.7.0",
    "@supabase/supabase-js": "^2.83.0",
    "framer-motion": "^12.23.24",
    "lucide-react": "^0.554.0",
    "next": "16.0.10",
    "openai": "^6.9.1",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "stripe": "^20.0.0",
    "twilio": "^5.10.7",
    "zod": "^4.1.12"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "^16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}

---
---
File: web/tsconfig.json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}

---
---
File: web/README.md
# ailuna-web（最新版 / 2025-12-17）

AiLuna の **SaaS管理画面**（Next.js + Supabase + Stripe）です。

- ログイン/サインアップ（Supabase Auth）
- AIエージェント設定（system prompt を手動編集 → `user_prompts` に保存）
- 通話履歴の表示（`call_logs`）
- Stripe Checkout でサブスク購入（※Webhook実装が別途必要）

---

## 1. 主要技術
- Next.js（App Router）
- Supabase（Auth + DB）
- Stripe（Checkout）
- OpenAI（Builder用：Chat Completions）

---

## 2. 必須の環境変数（.env.local）
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxxx

# Stripe（Checkout）
STRIPE_SECRET_KEY=sk_test_...
NEXT_PUBLIC_STRIPE_PRICE_ID=price_...
# 従量課金を使う場合（任意）
NEXT_PUBLIC_STRIPE_USAGE_PRICE_ID=price_...

# Stripe Webhook（実装済み）
STRIPE_WEBHOOK_SECRET=whsec_...

# WebhookからSupabaseを更新する場合（推奨：server-only env）
SUPABASE_SERVICE_ROLE_KEY=xxxx
```

## 3. Stripe Webhook 設定
ローカル開発でテストする場合：
1. Stripe CLIをインストール
2. `stripe login`
3. `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
4. 出力された `whsec_...` を `.env.local` の `STRIPE_WEBHOOK_SECRET` に設定


> `NEXT_PUBLIC_*` はクライアントにも露出します。Price IDは秘匿不要ですが、**Secret Key / Service Role Key は公開しない**でください。

### 3.1 Stripe CLI のインストール
Webhookのテストには Stripe CLI が必要です `stripe.exe` はリポジトリから削除されたため、以下のようにインストールしてください。

- **Mac**: `brew install stripe/stripe-cli/stripe`
- **Windows**: `winget install Stripe.StripeCLI` または [公式サイト](https://docs.stripe.com/stripe-cli) からダウンロード
- **Linux**: [公式サイト](https://docs.stripe.com/stripe-cli) の手順を参照

---

## 3. 起動方法
```bash
npm install
npm run dev
```

---

## 4. 主要機能

### 4.1 AIエージェント設定
- `src/app/dashboard/ConciergeBuilder.tsx`
- system_prompt と config_metadata を手動編集し、`user_prompts` に保存します。

### 4.2 通話履歴
- `src/components/CallLogList.tsx`
- サーバアクション：`src/app/dashboard/actions.ts`
- Supabase の `call_logs` から `user_id` でフィルタして取得します。


---

## 6. Stripeサブスクを「成立」させるために必要なこと
Checkoutは作れますが、`profiles.is_subscribed` を更新するには **Stripe Webhook** が必要です。

推奨：
- `src/app/api/webhooks/stripe/route.ts` を web 側に実装し、
- `profiles.is_subscribed` / `profiles.stripe_customer_id` / `profiles.phone_number` を更新する

---

## 6. よくあるトラブル
- `user_prompts` が無い：call-engine 側で DB 設定を読めず、fallback prompt になる

---

## 7. 電話予約フロー安定化 (Acceptance Criteria)
本リポジトリおよび `ailuna-call-engine` の改修における受け入れ基準です。

1. **Uniqueness**: 1通話 (`call_sid`) につき `reservation_requests` は最大1件のみ作成されること。
2. **Data Integrity**: `answers` カラムは常に JSON Object `{}` であること（Array `[]` は禁止）。
3. **Date/Time**: DB上の `requested_date` は `YYYY-MM-DD` (Date型)、`requested_time` は `HH:mm` (Time型) で保存されること。
4. **Notification**: 店舗への通知 (Email/LINE) は1予約リクエストにつき1回のみ送信されること。
5. **SMS Logging**: 予約の承認/却下時にSMSが送信された場合、`sms_body_sent` と `sms_sent_at` がデータベースに記録されること。

---
